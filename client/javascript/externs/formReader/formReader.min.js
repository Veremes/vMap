goog.provide("nsVitisComponent");nsVitisComponent={};goog.provide("nsVitisComponent.MapWorkbench");goog.require("formReader");goog.require("nsVitisComponent.Map");
nsVitisComponent.MapWorkbenchDirective=function($timeout){return{restrict:"A",controller:"AppMapWorkbenchController",controllerAs:"ctrl",templateUrl:window.location.protocol+"//"+window.location.hostname+(window.location.port?":"+window.location.port:"")+"/"+sessionStorage["appEnv"]+"/javascript/externs/formReader/component/map_workbench/map_workbench.html",compile:function(element,attributes){return{pre:function(scope,element,attributes,controller,transcludeFn){var aColumns=[{name:"map_workbench_index",
visible:false}];if(goog.isArray(scope["field"]["attributes_def"]))for(var i=0;i<scope["field"]["attributes_def"].length;i++)aColumns.push({name:scope["field"]["attributes_def"][i]["name"],displayName:scope["field"]["attributes_def"][i]["label"]});scope["gridOptions"]={"enableSorting":true,"enableRowSelection":true,"enableSelectAll":true,"multiSelect":false,"columnDefs":aColumns,"data":[]};scope["featureForm"]={"draw":{"symbol":"fa-home","color":"red","outline_color":"white","size":4,"rotation":0,
"dash":20},"text":{"text":"","size":14,"font":"Arial","color":"white","outline_color":"black","outline_size":1,"offsetX":0,"offsetY":10,"rotation":0},"attributes":{}};scope["aIcons"]=[];scope["olSelectedFeature"]=null;scope["sSelectedFeatureType"]=null;scope["bFormDisabled"]=true;scope["aFeatures"]=[];scope["custom_form"]=null;scope["oSubformScope"]=null;var lastRowChange=Date.now();var lastRowChangeTimeout=100;var lastRowSelected=null;scope["clearSelectedFeature"]=function(bremoveInteraction){scope["olSelectedFeature"]=
null;if(goog.isDefAndNotNull(scope["oMap"].interaction))if(goog.isFunction(scope["oMap"].interaction.getFeatures))if(goog.isDefAndNotNull(scope["oMap"].interaction.getFeatures())){scope["oMap"].interaction.getFeatures().clear();if(bremoveInteraction)scope["oMap"].MapObject.removeInteraction(scope["oMap"].interaction)}lastRowSelected=null;scope["gridApi"]["selection"]["clearSelectedRows"]()};scope["closeModal"]=function(identifier){$(identifier).modal("hide")};scope["gridOptions"]["onRegisterApi"]=
function(gridApi){scope["gridApi"]=gridApi;scope["gridApi"]["selection"]["on"]["rowSelectionChanged"](scope,function(row){if(lastRowChange+lastRowChangeTimeout>Date.now())return null;lastRowChange=Date.now();var olGridSelectedFeature=null;var selectedIndex=null;var toSelectIndex=null;for(var i=0;i<scope["aFeatures"].length;i++)if(scope["aFeatures"][i].get("attributes")["map_workbench_index"]===row["entity"]["map_workbench_index"]){olGridSelectedFeature=scope["aFeatures"][i];break}if(goog.isDefAndNotNull(lastRowSelected))if(lastRowSelected===
row["entity"]["map_workbench_index"]){scope["clearSelectedFeature"](true);return null}lastRowSelected=row["entity"]["map_workbench_index"];if(goog.isDefAndNotNull(scope["oMap"].interaction))if(goog.isFunction(scope["oMap"].interaction.get))if(scope["oMap"].interaction.get("type")==="select"){var aFeatures=scope["oMap"].interaction.getFeatures().getArray();if(goog.isArray(aFeatures))if(aFeatures.length>0){var attributes=aFeatures[0].get("attributes");if(goog.isDefAndNotNull(attributes))if(attributes["map_workbench_index"]===
row["entity"]["map_workbench_index"])return null}}scope["oMap"]["activeInteraction"]("select",true);scope["oMap"].interaction.getFeatures().push(olGridSelectedFeature);setTimeout(function(){scope["oMap"].interaction.displaySelectedFeatureContour()})})}},post:function(scope,element,attributes,controller,transcludeFn){scope["getSubFormScope"]=function(){return angular.element("#map_workbench_"+scope["sFormUniqueName"]+"_subform").scope()};var initMap=function(){if(goog.isDef(scope["oMap"])){scope["oMap"].MapObject.setTarget(null);
delete scope["oMap"]}if(goog.isDefAndNotNull(scope["field"]["custom_form"]))scope["ctrl"].unactiveDrawInteractions_();scope["oMap"]=new nsVitisComponent.Map({"target":$(element).find(".form-map")[0],"options":scope["field"]["map_options"],"hiddenFieldId":scope["field"]["id"],"oFormValues":scope["oFormValues"][scope["sFormDefinitionName"]],"sFormName":scope["field"]["name"],"oProj":scope.$root["proj"]});scope["oMap"].onFeatureSelected(function(oFeature){scope.$applyAsync(function(){scope["olSelectedFeature"]=
oFeature})});scope["oMap"].onFeaturesChanged(function(aFeatures){if(!goog.isArray(aFeatures))return null;scope["aFeatures"]=aFeatures;scope["ctrl"].fillGridFromFeatures_()});scope["oMap"].onFeatureAdded(function(oFeature){setTimeout(function(){scope["olSelectedFeature"]=oFeature;scope["oMap"]["activeInteraction"]("select");scope["oMap"].interaction.getFeatures().push(oFeature);setTimeout(function(){scope["oMap"].interaction.displaySelectedFeatureContour();scope["ctrl"].unactiveDrawInteractions_()})})});
setTimeout(function(){scope["oMap"].saveFeatures()})};var initSubform=function(){scope["oSubformScope"]=scope["getSubFormScope"]();scope["oSubformScope"]["loadSubForm"]({"sFormDefinitionName":"update","oFormDefinition":scope["field"]["custom_form"]["form"],"oFormValues":{"update":{}},"oProperties":scope["oProperties"]});var formSrvc=angular.element(vitisApp.appMainDrtv).injector().get(["formSrvc"]);if(goog.isDefAndNotNull(scope["oSubformScope"]))if(goog.isDefAndNotNull(scope["oSubformScope"]["oSubformValues"]))scope.$watch("oSubformScope.oSubformValues",
function(newValue,oldValue){var newTextValue=formSrvc["getFormData"]("update",true,{"oFormDefinition":scope["field"]["custom_form"]["form"],"oFormValues":goog.object.clone(newValue)});var oldTextValue=formSrvc["getFormData"]("update",true,{"oFormDefinition":scope["field"]["custom_form"]["form"],"oFormValues":goog.object.clone(oldValue)});var sFieldName=scope["field"]["custom_form"]["featureStructure"]["field"];var sFieldTypes=scope["field"]["custom_form"]["featureStructure"]["types"];var newType=
newTextValue[sFieldName];var oldType=oldTextValue[sFieldName];if(goog.isDefAndNotNull(newType)&&oldType)if(newType!==oldType)if(goog.isDefAndNotNull(sFieldTypes[newType])&&sFieldTypes[oldType]){var newGeomType=sFieldTypes[newType]["geometryType"];var oldGeomType=sFieldTypes[oldType]["geometryType"];if(newGeomType!==oldGeomType){$.notify("Ce type est incompatible avec la g\u00e9om\u00e9trie s\u00e9lectionn\u00e9e","error");scope["oSubformScope"]["setFormValues"]({"update":oldTextValue});return null}}goog.object.extend(scope["featureForm"]["attributes"],
newTextValue);if(goog.isDefAndNotNull(scope["olSelectedFeature"]))scope["ctrl"].setStyleFromType_(scope["olSelectedFeature"])},true)};setTimeout(function(){initMap();scope.$watch("field.nb_cols",function(value,old){$timeout(function(){scope["oMap"].MapObject.updateSize()})});scope.$watch("field.style",function(value,old){$timeout(function(){scope["oMap"].MapObject.updateSize()})},true);scope.$watch("oMap.bLayersTreeOpen",function(value,old){$timeout(function(){scope["oMap"].MapObject.updateSize()})},
true);scope.$on("studio resized",function(){scope["oMap"].MapObject.updateSize()});scope.$on("updateMap",function(event,data){switch(data){case "center":scope["oMap"]["setCenter"]([scope["field"]["map_options"]["center"]["coord"][0],scope["field"]["map_options"]["center"]["coord"][1]]);break;case "zoom":scope["oMap"]["setZoom"](scope["field"]["map_options"]["center"]["zoom"]);break;case "source":scope["oMap"]["setBingSource"](scope["field"]["map_options"]["source"]);break;case "extent":scope["oMap"]["setExtent"](scope["field"]["map_options"]["center"]["extent"]);
break;case "controls":scope["oMap"]["setControls"](scope["field"]["map_options"]["controls"]);break;case "interact":scope["oMap"]["setInteractions"](scope["field"]["map_options"]["interactions"]);break;case "proj":var extent=scope["oMap"]["getExtent"]();var center=scope["oMap"]["getCenter"]();var proj=scope["oMap"]["getProj"]();scope["field"]["map_options"]["center"]["extent"]=scope["oMap"]["transformExtent"](extent,proj,scope["field"]["map_options"]["proj"]);scope["field"]["map_options"]["center"]["coord"]=
scope["oMap"]["transformer"](center,proj,scope["field"]["map_options"]["proj"]);initMap();break;default:initMap();break}})});setTimeout(function(){if(goog.isDefAndNotNull(scope["field"]["custom_form"]))if(goog.isDefAndNotNull(scope["field"]["custom_form"]["form"])){goog.object.extend(scope["field"]["custom_form"],scope["oFormValues"][scope["sFormDefinitionName"]]["custom_form"]);initSubform()}})}}}}};formReader.module.directive("appMapWorkbench",nsVitisComponent.MapWorkbenchDirective);
nsVitisComponent.appColorpickerDrtv=function(){return{scope:{"model":"="},link:function(scope,element,attrs){$(element)["colorpicker"]({format:"hex"});var minTimeout=100;var timeout;$(element).on("changeColor",function(){clearTimeout(timeout);timeout=setTimeout(function(){scope["model"]=$(element)["colorpicker"]("getValue");scope.$parent.$apply()},minTimeout)})}}};formReader.module.directive("appColorpicker",nsVitisComponent.appColorpickerDrtv);
nsVitisComponent.MapWorkbenchController=function($scope,$log){$log.info("MapWorkbenchController");var this_=this;this.$log_=$log;this.$scope_=$scope;var featureFormTimeout=50;var olSelectedFeatureTimeout=200;var featureFormLastUpdate=Date.now();var olSelectedFeatureLastUpdate=Date.now();$scope.$watch("featureForm",function(){if(featureFormLastUpdate+featureFormTimeout>Date.now())return null;featureFormLastUpdate=Date.now();if(!goog.isDefAndNotNull(this_.$scope_["oMap"]))return 0;if(!goog.isDefAndNotNull(this_.$scope_["oMap"].FeatureOverlay))return 0;
if(!goog.isDefAndNotNull(this_.$scope_["olSelectedFeature"]))return 0;this_.updateFeatureStyleFromForm_();this_.updateFeatureAttributes_();setTimeout(function(){this_.$scope_["oMap"].saveFeatures()})},true);$scope.$watch("olSelectedFeature",function(){if(olSelectedFeatureLastUpdate+olSelectedFeatureTimeout>Date.now())return null;olSelectedFeatureLastUpdate=Date.now();if(goog.isDefAndNotNull($scope["olSelectedFeature"]))$scope["bFormDisabled"]=false;else $scope["bFormDisabled"]=true;if(goog.isDefAndNotNull($scope["olSelectedFeature"]))switch(this_.$scope_["olSelectedFeature"].getGeometry().getType()){case "Point":case "MultiPoint":this_.$scope_["sSelectedFeatureType"]=
"Point";break;case "LineString":case "MultiLineString":this_.$scope_["sSelectedFeatureType"]="Line";break;case "Polygon":case "MultiPolygon":this_.$scope_["sSelectedFeatureType"]="Polygon";break;default:this_.$scope_["sSelectedFeatureType"]=null;break}if(goog.isDefAndNotNull($scope["olSelectedFeature"])){var oAttributes=goog.isDefAndNotNull($scope["olSelectedFeature"].get("attributes"))?$scope["olSelectedFeature"].get("attributes"):{};$scope["featureForm"]["attributes"]=oAttributes;if(goog.isDefAndNotNull($scope["oSubformScope"])){var sFieldName=
$scope["field"]["custom_form"]["featureStructure"]["field"];var sFieldTypes=$scope["field"]["custom_form"]["featureStructure"]["types"];var oFeatureTypeSubform=angular.copy($scope["field"]["custom_form"]["form"]);if(goog.isDefAndNotNull(oAttributes[sFieldName]))if(goog.isDefAndNotNull(sFieldTypes[oAttributes[sFieldName]]))if(goog.isArray(sFieldTypes[oAttributes[sFieldName]]["disableAttrs"])){var aDisableAttrs=sFieldTypes[oAttributes[sFieldName]]["disableAttrs"];for(var i=0;i<oFeatureTypeSubform["update"]["rows"].length;i++)for(var ii=
0;ii<oFeatureTypeSubform["update"]["rows"][i]["fields"].length;ii++)if(aDisableAttrs.indexOf(oFeatureTypeSubform["update"]["rows"][i]["fields"][ii]["name"])!==-1)oFeatureTypeSubform["update"]["rows"][i]["fields"][ii]["visible"]=false}$scope["oSubformScope"]["loadSubForm"]({"sFormDefinitionName":"update","oFormDefinition":oFeatureTypeSubform,"oFormValues":{"update":angular.copy(oAttributes)},"oProperties":$scope["oProperties"]})}var oStyle=$scope["olSelectedFeature"].getStyleAsJSON();if(goog.isDefAndNotNull(oStyle["draw"]))$scope["featureForm"]["draw"]=
oStyle["draw"];if(goog.isDefAndNotNull(oStyle["text"]))$scope["featureForm"]["text"]=oStyle["text"]}else{$scope["featureForm"]["attributes"]={};if(goog.isDefAndNotNull($scope["oSubformScope"]))$scope["oSubformScope"]["setFormValues"]({"update":{}})}if(goog.isDefAndNotNull($scope["olSelectedFeature"])){var featureIndex=$scope["aFeatures"].indexOf($scope["olSelectedFeature"]);this_.$scope_["gridApi"]["selection"]["clearSelectedRows"]();this_.$scope_["gridApi"]["selection"]["selectRowByVisibleIndex"](featureIndex)}else $scope["clearSelectedFeature"](false)});
this.loadIconsList_()};formReader.module.controller("AppMapWorkbenchController",nsVitisComponent.MapWorkbenchController);
nsVitisComponent.MapWorkbenchController.prototype.loadIconsList_=function(){this.$log_.info("MapWorkbenchController.loadIconsList_");var oGlyphs=ol.style.FontSymbol.prototype.defs.glyphs;var oFonts=ol.style.FontSymbol.prototype.defs.fonts;var aIcons=[];var sIcon;for(var key in oGlyphs)if(goog.isDefAndNotNull(oGlyphs[key]["font"]))if(goog.isDefAndNotNull(goog.isDefAndNotNull(oFonts[oGlyphs[key]["font"]]))){sIcon="";if(goog.isDefAndNotNull(goog.isDefAndNotNull(oFonts[oGlyphs[key]["font"]]["prefix"]))){sIcon+=
oFonts[oGlyphs[key]["font"]]["prefix"];sIcon+=" "}sIcon+=key;aIcons.push({"def":key,"class":sIcon})}this.$scope_.$applyAsync(function(scope){scope["aIcons"]=aIcons;scope["sSelectedIcon"]=aIcons[0]["class"];scope["featureForm"]["draw"]["symbol"]=aIcons[0]["def"]})};nsVitisComponent.MapWorkbenchController.prototype.updateFeatureStyleFromForm_=function(){this.$log_.info("MapWorkbenchController.updateFeatureStyleFromForm_");this.$scope_["olSelectedFeature"].setStyleByJSON(this.$scope_["featureForm"])};
nsVitisComponent.MapWorkbenchController.prototype.updateFeatureAttributes_=function(){this.$log_.info("MapWorkbenchController.updateFeatureAttributes_");this.$scope_["olSelectedFeature"].set("attributes",this.$scope_["featureForm"]["attributes"])};
nsVitisComponent.MapWorkbenchController.prototype.fillGridFromFeatures_=function(){this.$log_.info("MapWorkbenchController.fillGridFromFeatures_");var aFeatures=this.$scope_["aFeatures"];var aGridData=[];var oAttributes;if(goog.isArray(aFeatures))for(var i=0;i<aFeatures.length;i++){if(goog.isDefAndNotNull(aFeatures[i].get("attributes")))oAttributes=aFeatures[i].get("attributes");else oAttributes={};oAttributes["map_workbench_index"]=angular.copy(i);aFeatures[i].set("attributes",oAttributes);aGridData.push(oAttributes)}this.$scope_["gridOptions"]["data"]=
aGridData;this.$scope_["gridApi"]["grid"]["refresh"]()};
nsVitisComponent.MapWorkbenchController.prototype.showAddFeatureModal=function(){this.$log_.info("MapWorkbenchController.showAddFeatureModal");var this_=this;var sFieldName=this.$scope_["field"]["custom_form"]["featureStructure"]["field"];var oFeatureTypeSubform=angular.copy(this.$scope_["field"]["custom_form"]["form"]);var formOk=false;for(var i=0;i<oFeatureTypeSubform["update"]["rows"].length;i++)for(var ii=0;ii<oFeatureTypeSubform["update"]["rows"][i]["fields"].length;ii++)if(oFeatureTypeSubform["update"]["rows"][i]["fields"][ii]["name"]!==sFieldName){oFeatureTypeSubform["update"]["rows"][i]["fields"][ii]["visible"]=
false;formOk=true}if(!formOk){console.error("Field "+sFieldName+" not present in the form");return null}var oFeatureTypeSubformScope=angular.element("#map_workbench_"+this.$scope_["sFormUniqueName"]+"_feature_type_modal_subform").scope();oFeatureTypeSubformScope["loadSubForm"]({"sFormDefinitionName":"update","oFormDefinition":oFeatureTypeSubform,"oFormValues":{"update":{}},"oProperties":this.$scope_["oProperties"]});this.$scope_["clearSelectedFeature"]();setTimeout(function(){$("#map_workbench_"+
this_.$scope_["sFormUniqueName"]+"_feature_type_modal").modal("show")})};
nsVitisComponent.MapWorkbenchController.prototype.addFeature=function(){this.$log_.info("MapWorkbenchController.addFeature");var this_=this;var formSrvc=angular.element(vitisApp.appMainDrtv).injector().get(["formSrvc"]);var sFieldName=this.$scope_["field"]["custom_form"]["featureStructure"]["field"];var sFieldTypes=this.$scope_["field"]["custom_form"]["featureStructure"]["types"];var oFeatureTypeSubform=angular.copy(this.$scope_["field"]["custom_form"]["form"]);var oFeatureTypeSubformScope=angular.element("#map_workbench_"+
this.$scope_["sFormUniqueName"]+"_feature_type_modal_subform").scope();var oFormTextValues=formSrvc["getFormData"]("update",true,{"oFormDefinition":oFeatureTypeSubform,"oFormValues":goog.object.clone(oFeatureTypeSubformScope["oSubformValues"])});var sGeometryType=null;if(goog.isDefAndNotNull(oFormTextValues[sFieldName]))if(goog.isDefAndNotNull(sFieldTypes[oFormTextValues[sFieldName]]))if(goog.isDefAndNotNull(sFieldTypes[oFormTextValues[sFieldName]]["geometryType"]))sGeometryType=sFieldTypes[oFormTextValues[sFieldName]]["geometryType"];
else sGeometryType="all";this.$scope_["oMap"].onceFeatureAdded(function(oFeature){setTimeout(function(){var oAttributes=oFeature.get("attributes");oAttributes=goog.isObject(oAttributes)?oAttributes:{};oAttributes[sFieldName]=oFormTextValues[sFieldName];oFeature.set("attributes",oAttributes);setTimeout(function(){this_.setStyleFromType_(oFeature)})})});this.unactiveDrawInteractions_();if(goog.isDefAndNotNull(sGeometryType)){this.activeDrawInteraction_(sGeometryType);$("#map_workbench_"+this.$scope_["sFormUniqueName"]+
"_feature_type_modal").modal("hide")}else $.notify("Veuillez s\u00e9lectionner un type","error")};
nsVitisComponent.MapWorkbenchController.prototype.deleteSelectedFeature=function(){this.$log_.info("MapWorkbenchController.deleteSelectedFeature");var this_=this;if(!goog.isDefAndNotNull(this.$scope_["olSelectedFeature"])){$.notify("Aucune g\u00e9o\u00e9trie s\u00e9lectionn\u00e9e","error");return null}bootbox.confirm("Supprimer d\u00e9finitivement la g\u00e9om\u00e9trie ?",function(result){if(result){this_.$scope_["oMap"].removeFeature(this_.$scope_["olSelectedFeature"]);this_.$scope_["olSelectedFeature"]=
null;setTimeout(function(){this_.$scope_["oMap"].saveFeatures()})}})};
nsVitisComponent.MapWorkbenchController.prototype.setStyleFromType_=function(oFeature){this.$log_.info("MapWorkbenchController.setStyleFromType_");if(!goog.isDefAndNotNull(oFeature))return null;var sFieldName=this.$scope_["field"]["custom_form"]["featureStructure"]["field"];var sFieldTypes=this.$scope_["field"]["custom_form"]["featureStructure"]["types"];var oAttributes=oFeature.get("attributes");if(goog.isDefAndNotNull(oAttributes[sFieldName]))if(goog.isDefAndNotNull(sFieldTypes[oAttributes[sFieldName]]))if(goog.isDefAndNotNull(sFieldTypes[oAttributes[sFieldName]]["style"])){var oStyle=angular.copy(sFieldTypes[oAttributes[sFieldName]]["style"]);
for(var key1 in oStyle)for(var key2 in oStyle[key1])if(goog.isString(oStyle[key1][key2]))if(oStyle[key1][key2].substr(0,2)==="{{"&&oStyle[key1][key2].substr(-2,2)==="}}"){var sTag=oStyle[key1][key2].substr(2,oStyle[key1][key2].length-4);if(goog.isDefAndNotNull(oAttributes[sTag]))oStyle[key1][key2]=oAttributes[sTag];else oStyle[key1][key2]=""}this.$scope_["featureForm"]["draw"]=oStyle["draw"];this.$scope_["featureForm"]["text"]=oStyle["text"]}};
nsVitisComponent.MapWorkbenchController.prototype.activeDrawInteraction_=function(sGeometryType){this.$log_.info("MapWorkbenchController.activeDrawInteraction_");switch(sGeometryType){case "all":this.$scope_["field"]["map_options"]["interactions"]["point"]=true;this.$scope_["field"]["map_options"]["interactions"]["line"]=true;this.$scope_["field"]["map_options"]["interactions"]["polygon"]=true;break;case "point":this.$scope_["field"]["map_options"]["interactions"]["point"]=true;break;case "line":this.$scope_["field"]["map_options"]["interactions"]["line"]=
true;break;case "polygon":this.$scope_["field"]["map_options"]["interactions"]["polygon"]=true;break;default:console.error("Bad sGeometryType: ",sGeometryType);return null;break}this.$scope_["oMap"]["setInteractions"](this.$scope_["field"]["map_options"]["interactions"]);if(sGeometryType==="point"||sGeometryType==="line"||sGeometryType==="polygon")this.$scope_["oMap"]["activeInteraction"](sGeometryType)};
nsVitisComponent.MapWorkbenchController.prototype.unactiveDrawInteractions_=function(){this.$log_.info("MapWorkbenchController.unactiveDrawInteractions_");var aDrawInteractions=["point","line","polygon","DP","DL","DPol","RA","remove_all","RO","remove"];for(var i=0;i<aDrawInteractions.length;i++){if(goog.isDefAndNotNull(this.$scope_["oMap"]))if(goog.isDefAndNotNull(this.$scope_["oMap"]["removeInteraction"]))this.$scope_["oMap"]["removeInteraction"](aDrawInteractions[i]);if(goog.isDefAndNotNull(this.$scope_["field"]["map_options"]["interactions"][aDrawInteractions[i]]))this.$scope_["field"]["map_options"]["interactions"][aDrawInteractions[i]]=
false}};goog.provide("nsVitisComponent.Map");goog.require("nsVitisComponent");goog.require("MapJSON");goog.require("ol");goog.require("ol.Map");goog.require("ol.View");goog.require("ol.proj");goog.require("ol.proj.Projection");goog.require("ol.Collection");goog.require("ol.layer.Tile");goog.require("ol.layer.Vector");goog.require("ol.layer.Image");goog.require("ol.layer.Group");goog.require("ol.source.OSM");goog.require("ol.source.BingMaps");goog.require("ol.source.Vector");goog.require("ol.format.WKT");
goog.require("ol.control");goog.require("ol.control.MousePosition");goog.require("ol.control.Control");goog.require("ol.control.ScaleLine");goog.require("ol.style.Style");goog.require("ol.style.Fill");goog.require("ol.style.Stroke");goog.require("ol.style.Circle");goog.require("ol.easing");goog.require("ol.interaction.Interaction");goog.require("ol.interaction.Select");goog.require("ol.interaction.Modify");goog.require("ol.interaction.Draw");goog.require("ol.events.condition");goog.require("ol.Sphere");
var featureID=0;
nsVitisComponent.Map=function(opt_option){var target=opt_option["target"];var options=opt_option["options"];this.hiddenFieldId=opt_option["hiddenFieldId"];this.oFormValues=opt_option["oFormValues"];this.sFormName=opt_option["sFormName"];var oProj=opt_option["oProj"];if(!goog.isDefAndNotNull(target)){console.error("nsVitisComponent.Map: target not defined");return null}if(!goog.isDefAndNotNull(options)){console.error("nsVitisComponent.Map: options not defined");return null}if(!goog.isDefAndNotNull(this.hiddenFieldId)){console.error("nsVitisComponent.Map: hiddenFieldId not defined");return null}if(!goog.isDefAndNotNull(this.oFormValues)){console.error("nsVitisComponent.Map: oFormValues not defined");
return null}if(!goog.isDefAndNotNull(this.sFormName)){console.error("nsVitisComponent.Map: sFormName not defined");return null}if(!goog.isDefAndNotNull(oProj)){console.error("nsVitisComponent.Map: oProj not defined");return null}this.$propertiesSrvc_=angular.element(vitisApp.appHtmlFormDrtv).injector().get(["propertiesSrvc"]);this.$translate_=angular.element(vitisApp.appHtmlFormDrtv).injector().get(["$translate"]);this.$log_=angular.element(vitisApp.appHtmlFormDrtv).injector().get(["$log"]);var this_=
this;this.$log_.info("nsVitisComponent.Map");this.appColor=$(".banner_line").css("background-color");if(goog.isDef(this.appColor))if(this.appColor.charAt(3)!=="a"){this.appColor=this.appColor.split("(");this.appColor=this.appColor[1].split(")");this.appColor="rgba("+this.appColor[0]+",0.58)"}var aTranslates=["COMPONENT_MAP_LAYERSTREE","COMPONENT_MAP_FULLSCREEN","COMPONENT_MAP_ZOOM_EXTENT","COMPONENT_MAP_DELETE_FEATURE","COMPONENT_MAP_DELETE_ALL","COMPONENT_MAP_MODIFY_FEATURE","COMPONENT_MAP_DRAW_POINT",
"COMPONENT_MAP_DRAW_LINE","COMPONENT_MAP_DRAW_POLYGON","COMPONENT_MAP_ZOOM_EXTENT","COMPONENT_MAP_OVERSIZED_EXTENT"];this.$translate_(aTranslates).then(function(translations){this_.oTranslates=translations});this.addCustomProjections();var center,extent;if(goog.isDef(options["center"]["coord"]))center=options["center"]["coord"];if(goog.isDef(options["center"]["extent"]))extent=options["center"]["extent"];this.proj_=options["proj"];this.baseProj_=goog.isDefAndNotNull(options["base_proj"])?options["base_proj"]:
this.proj_;this.outputFormat_=goog.isDefAndNotNull(options["output_format"])?options["output_format"]:"wkt";this.wktFormat=new ol.format.WKT({splitCollection:true});this.geoJSONFormat=new ol.format.GeoJSON({defaultDataProjection:this.baseProj_,featureProjection:this.proj_});if(options["center"]["coord"])this.View=new ol.View({center:center,zoom:5,projection:ol.proj.get(options["proj"])});else this.View=new ol.View({center:[(extent[0]+extent[2])/2,(extent[1]+extent[3])/2],zoom:5,projection:ol.proj.get(options["proj"])});
this.oTranslates={};this.Target=target;this.Accuracy=options["coord_accuracy"];this.Controls=[];this.Layers=[];this.Features=new ol.Collection;this.interaction="none";this.Config={};this.oProj_=oProj;this.multiGeom=options["interactions"]["multi_geometry"];this.selectedFeature=null;this["bLayersTreeOpen"]=options["bLayersTreeOpen"]===true?options["bLayersTreeOpen"]:false;this.featureSelectedEvents=[];this.featuresChangedEvents=[];this.featureAddedEvents=[];this.featureAddedOnceEvents=[];if(options["type"]===
"OSM")this.Layers.push(new ol.layer.Tile({source:new ol.source.OSM}));else if(options["type"]==="bing")this.Layers.push(new ol.layer.Tile({source:new ol.source.BingMaps({culture:options["source"]["culture"],key:options["source"]["key"],imagerySet:options["source"]["style"]})}));this.element=document.createElement("DIV");$(this.element).addClass("ol-current-projection-studio ol-unselectable");if(options["controls"]["MP"])this.Controls.push(new ol.control.MousePosition({coordinateFormat:function(coordinate){return[coordinate[0].toPrecision(this_.Accuracy),
coordinate[1].toPrecision(this_.Accuracy)]}}));if(options["controls"]["SL"])this.Controls.push(new ol.control.ScaleLine);if(options["controls"]["CP"])this.Controls.push(new ol.control.Control({element:this_.element,render:function(){var currentProj="";for(var i=0;i<this_.oProj_["projections"].length;i++)if(this_.proj_===this_.oProj_["projections"][i]["code"])currentProj=this_.oProj_["projections"][i]["name"];if(currentProj!=="")$(".ol-current-projection-studio").html(currentProj);else $(".ol-current-projection-studio").html(this_.proj_)}}));
if(options["controls"]["ZO"])setTimeout(function(){this_.ZoomGroup=this_.zoomControls(this_.Target)},500);setTimeout(function(){this_.IntractionsGroup=this_.addInteractions(this_.Target,options["interactions"])});if(Array.isArray(options["layers"]))if(options["layers"].length>0)this.Layers.push(options["layers"]);this.MapObject=new ol.Map({target:this_.Target,layers:this_.Layers,view:this_.View,controls:this_.Controls});if(goog.isDefAndNotNull(options["center"]["scale"]))this.setScale(options["center"]["scale"]);
if(goog.isDefAndNotNull(options["center"]["extent"]))this.setExtent(options["center"]["extent"]);if(options["type"]==="vmap"&&options["tree"])this["aTree"]=this.loadTree(options["tree"]);else this["aTree"]=[{"service":options["type"],"layers":this.Layers}];var projExtent=ol.proj.get(options["proj"]).getExtent();var viewExtent=this.View.calculateExtent(this.MapObject.getSize());if(this.isInsideProjExtent(viewExtent,projExtent))this.Extent=this.View.calculateExtent(this.MapObject.getSize());else{console.error("map extent oversized");
this.MapObject.getView().fit(projExtent)}$(".ol-mouse-position").css("bottom","8px");$(".ol-mouse-position").css("top","auto");$(".ol-mouse-position").css("background",this.appColor);$(".ol-mouse-position").css("color","#ffffff");$(".ol-mouse-position").css("border-radius","4px");$(".ol-scale-line").css("background",this.appColor);$(".ol-current-projection-studio").css("background",this.appColor);options["draw_color"]=goog.isDef(options["draw_color"])?options["draw_color"]:"rgba(54,184,255,0.6)";
options["contour_color"]=goog.isDef(options["contour_color"])?options["contour_color"]:"rgba(0,0,0,0.4)";options["contour_size"]=goog.isDef(options["contour_size"])?options["contour_size"]:2;options["circle_radius"]=goog.isDef(options["circle_radius"])?options["circle_radius"]:7;var style=new ol.style.Style({fill:new ol.style.Fill({color:options["draw_color"]}),stroke:new ol.style.Stroke({color:options["contour_color"],width:options["contour_size"]}),image:new ol.style.Circle({radius:options["circle_radius"],
fill:new ol.style.Fill({color:options["draw_color"]}),stroke:new ol.style.Stroke({color:options["contour_color"],width:options["contour_size"]})})});this.FeatureOverlay=new ol.layer.Vector({style:style,updateWhileAnimating:true,updateWhileInteracting:true,source:new ol.source.Vector({features:this_.Features})});setTimeout(function(){this_.MapObject.addLayer(this_.FeatureOverlay)},500);var hiddenFeatures=$("#"+this.hiddenFieldId).val();if(goog.isDef(hiddenFeatures))if(!goog.string.isEmpty(hiddenFeatures)&&
hiddenFeatures!=="[object Object]"){var aFeatures=this_.getFeaturesByString(hiddenFeatures);for(var i=0;i<aFeatures.length;i++)this.FeatureOverlay.getSource().addFeature(aFeatures[i]);var featuresExtent=this.FeatureOverlay.getSource().getExtent();this.MapObject.getView().fit(featuresExtent);if(aFeatures.length===1)if(aFeatures[0].getGeometry().getType()==="Point")this.MapObject.getView().setZoom(12)}this.Features.on("change",function(){setTimeout(function(){this_.saveFeatures();this_.MapObject.dispatchEvent("moveend")})});
return this};
nsVitisComponent.Map.prototype.saveFeatures=function(){this.$log_.info("nsVitisComponent.Map.saveFeatures");var sFeatures=this.getStringByFeatures(this.Features.getArray());if(goog.isDef(this.hiddenFieldId))document.getElementById(this.hiddenFieldId).setAttribute("value",sFeatures);if(goog.isDef(this.sFormName)&&goog.isDef(this.oFormValues))this.oFormValues[this.sFormName]=sFeatures;for(var i=0;i<this.featuresChangedEvents.length;i++)if(goog.isFunction(this.featuresChangedEvents[i]))this.featuresChangedEvents[i].call(this,this.Features.getArray())};
nsVitisComponent.Map.prototype.getFeaturesByString=function(sFeatures){this.$log_.info("nsVitisComponent.Map.getFeaturesByString");var aFeatures=[];if(this.outputFormat_==="wkt"||this.outputFormat_==="ewkt")if(ol.isEWKTGeom(sFeatures))aFeatures=ol.getFeaturesFromEWKT(sFeatures,this.proj_);else{console.error("cannot read the geometry on format ewkt");try{aFeatures=this.wktFormat.readFeatures(sFeatures,{dataProjection:this.baseProj_,featureProjection:this.proj_})}catch(e){console.error("cannot read the geometry on format wkt")}}else if(this.outputFormat_===
"geojson")try{aFeatures=this.geoJSONFormat.readFeatures(sFeatures,{dataProjection:this.baseProj_,featureProjection:this.proj_});for(var i=0;i<aFeatures.length;i++)if(goog.isDefAndNotNull(aFeatures[i].get("style")))aFeatures[i].setStyleByJSON(aFeatures[i].get("style"))}catch(e){console.error("cannot read the geometry on format geojson")}return aFeatures};
nsVitisComponent.Map.prototype.getStringByFeatures=function(aFeatures){this.$log_.info("nsVitisComponent.Map.getStringByFeatures");var sFeatures="";for(var i=0;i<aFeatures.length;i++){var olStyle=aFeatures[i].getStyleAsJSON();aFeatures[i].setProperties({style:goog.isDefAndNotNull(olStyle)?olStyle:null})}if(this.outputFormat_==="ewkt")sFeatures=ol.getEWKTFromFeatures(aFeatures,this.proj_);else if(this.outputFormat_==="wkt")sFeatures=ol.getWKTFromFeatures(aFeatures,this.proj_);else if(this.outputFormat_===
"geojson")sFeatures=this.geoJSONFormat.writeFeatures(aFeatures,{dataProjection:this.baseProj_,featureProjection:this.proj_});return sFeatures};
nsVitisComponent.Map.prototype.addCustomProjections=function(){var lambert93=new ol.proj.Projection({code:"EPSG:2154",extent:[-378305.81,6093283.21,1212610.74,7186901.68],units:"m"});ol.proj.addProjection(lambert93);var WGSToLambert=this.WGSToLambert;var lambertToWGS=this.lambertToWGS;ol.proj.addCoordinateTransforms("EPSG:4326","EPSG:2154",this.WGSToLambert,this.lambertToWGS);ol.proj.addCoordinateTransforms("EPSG:3857","EPSG:2154",function(coordinate3857){var coordinate4326=ol.proj.transform(coordinate3857,
"EPSG:3857","EPSG:4326");var coordinate2154=ol.proj.transform(coordinate4326,"EPSG:4326","EPSG:2154");return coordinate2154},function(coordinate2154){var coordinate4326=ol.proj.transform(coordinate2154,"EPSG:2154","EPSG:4326");var coordinate3857=ol.proj.transform(coordinate4326,"EPSG:4326","EPSG:3857");return coordinate3857})};
nsVitisComponent.Map.prototype.WGSToLambert=function(coordinates){var longitude=coordinates[0];var latitude=coordinates[1];var deg2rad=function deg2rad(angle){return angle/180*Math.PI};var a=6378137;var e=.08181919106;var lc=deg2rad(3);var phi0=deg2rad(46.5);var phi1=deg2rad(44);var phi2=deg2rad(49);var x0=7E5;var y0=66E5;var phi=deg2rad(latitude);var l=deg2rad(longitude);var gN1=a/Math.sqrt(1-e*e*Math.sin(phi1)*Math.sin(phi1));var gN2=a/Math.sqrt(1-e*e*Math.sin(phi2)*Math.sin(phi2));var gl1=Math.log(Math.tan(Math.PI/
4+phi1/2)*Math.pow((1-e*Math.sin(phi1))/(1+e*Math.sin(phi1)),e/2));var gl2=Math.log(Math.tan(Math.PI/4+phi2/2)*Math.pow((1-e*Math.sin(phi2))/(1+e*Math.sin(phi2)),e/2));var gl0=Math.log(Math.tan(Math.PI/4+phi0/2)*Math.pow((1-e*Math.sin(phi0))/(1+e*Math.sin(phi0)),e/2));var gl=Math.log(Math.tan(Math.PI/4+phi/2)*Math.pow((1-e*Math.sin(phi))/(1+e*Math.sin(phi)),e/2));var n=Math.log(gN2*Math.cos(phi2)/(gN1*Math.cos(phi1)))/(gl1-gl2);var c=gN1*Math.cos(phi1)/n*Math.exp(n*gl1);var ys=y0+c*Math.exp(-1*n*
gl0);var x93=x0+c*Math.exp(-1*n*gl)*Math.sin(n*(l-lc));var y93=ys-c*Math.exp(-1*n*gl)*Math.cos(n*(l-lc));return[x93,y93]};
nsVitisComponent.Map.prototype.lambertToWGS=function(coordinates){Math.atanh=Math.atanh||function(x){return Math.log((1+x)/(1-x))/2};Math.tanh=Math.tanh||function(x){if(x===Infinity)return 1;else if(x===-Infinity)return-1;else return(Math.exp(x)-Math.exp(-x))/(Math.exp(x)+Math.exp(-x))};var x=coordinates[0].toFixed(10);var y=coordinates[1].toFixed(10);var b6=6378137;var b7=298.257222101;var b8=1/b7;var b9=2*b8-b8*b8;var b10=Math.sqrt(b9);var b13=3;var b14=7E5;var b15=1.26556120499E7;var b16=.725607765053267;
var b17=1.1754255426096E7;var delx=x-b14;var dely=y-b15;var gamma=Math.atan(-delx/dely);var r=Math.sqrt(delx*delx+dely*dely);var latiso=Math.log(b17/r)/b16;var sinphiit0=Math.tanh(latiso+b10*Math.atanh(b10*Math.sin(1)));var sinphiit1=Math.tanh(latiso+b10*Math.atanh(b10*sinphiit0));var sinphiit2=Math.tanh(latiso+b10*Math.atanh(b10*sinphiit1));var sinphiit3=Math.tanh(latiso+b10*Math.atanh(b10*sinphiit2));var sinphiit4=Math.tanh(latiso+b10*Math.atanh(b10*sinphiit3));var sinphiit5=Math.tanh(latiso+b10*
Math.atanh(b10*sinphiit4));var sinphiit6=Math.tanh(latiso+b10*Math.atanh(b10*sinphiit5));var longrad=gamma/b16+b13/180*Math.PI;var latrad=Math.asin(sinphiit6);var lon=longrad/Math.PI*180;var lat=latrad/Math.PI*180;return[lon,lat]};
nsVitisComponent.Map.prototype.zoomControls=function(target){var this_=this;var buttonPlus=document.createElement("BUTTON");var buttonMinus=document.createElement("BUTTON");var buttonExtent=document.createElement("BUTTON");buttonPlus["innerHTML"]="<span class='fa fa-search-plus fa-x1' aria-hidden='true'></span>";buttonMinus["innerHTML"]="<span class='fa fa-search-minus fa-x1' aria-hidden='true'></span>";buttonExtent["innerHTML"]="<span class='glyphicon glyphicon-home' aria-hidden='true'></span>";
buttonPlus["className"]="btn btn-success Map-btn map-ZoomIn";buttonMinus["className"]="btn btn-success Map-btn map-ZoomOut";buttonExtent["className"]="btn btn-success Map-btn map-ZoomToExtent";$(buttonPlus).prop("type","button");$(buttonMinus).prop("type","button");$(buttonExtent).prop("type","button");$(buttonExtent).prop("title",this.oTranslates["COMPONENT_MAP_ZOOM_EXTENT"]);$(buttonPlus).on("click",function(){this_.MapObject.getView().animate({zoom:this_.MapObject.getView().getZoom()+1,duration:250})});
$(buttonMinus).on("click",function(){this_.MapObject.getView().animate({zoom:this_.MapObject.getView().getZoom()-1,duration:250})});$(buttonExtent).on("click",function(){this_.MapObject.getView().fit(this_.Extent)});var element=document.createElement("DIV");element["className"]="btn-group-vertical btn-group-md form-map-Group-btn-zoom";element.appendChild(buttonPlus);element.appendChild(buttonMinus);element.appendChild(buttonExtent);target.appendChild(element);return element};
nsVitisComponent.Map.prototype.addInteractions=function(target,objInter){var arrButton=[];var this_=this;if(objInter["full_screen"])if(document["fullscreenEnabled"]||document["webkitFullscreenEnabled"]||document["mozFullScreenEnabled"]||document["msFullscreenEnabled"]){var button_full_screen=document.createElement("BUTTON");button_full_screen["innerHTML"]="<span class='icon-enlarge' aria-hidden='true'></span>";button_full_screen["className"]="btn btn-success Map-btn map-FullScreen";button_full_screen["title"]=
this.oTranslates["COMPONENT_MAP_FULLSCREEN"];$(button_full_screen).prop("type","button");$(button_full_screen).on("click",function(){var elem=this_.Target;if(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement)if(document.exitFullscreen)document.exitFullscreen();else if(document.webkitExitFullscreen)document.webkitExitFullscreen();else if(document.mozCancelFullScreen)document.mozCancelFullScreen();else{if(document.msExitFullscreen)document.msExitFullscreen()}else if(elem.requestFullscreen)elem.requestFullscreen();
else if(elem.mozRequestFullScreen)elem.mozRequestFullScreen();else if(elem.webkitRequestFullscreen)elem.webkitRequestFullscreen()});arrButton.push(button_full_screen)}if(objInter["layer_tree"]){var button_layer_tree=document.createElement("BUTTON");button_layer_tree["innerHTML"]="<span class='icon-layers2' aria-hidden='true'></span>";button_layer_tree["className"]="btn btn-success Map-btn map-LayerTree";button_layer_tree["title"]=this.oTranslates["COMPONENT_MAP_LAYERSTREE"];$(button_layer_tree).prop("type",
"button");$(button_layer_tree).on("click",function(){this_["bLayersTreeOpen"]=!this_["bLayersTreeOpen"];this_.MapObject.dispatchEvent("moveend")});arrButton.push(button_layer_tree)}if(objInter["select"]){var button_select=document.createElement("BUTTON");button_select["innerHTML"]="<span class='icon-hand-pointer' aria-hidden='true'></span>";button_select["className"]="btn btn-success Map-btn map-Select";button_select["title"]=this.oTranslates["COMPONENT_MAP_SELECT"];$(button_select).prop("type","button");
$(button_select).on("click",function(){this_.activeInteraction("select")});arrButton.push(button_select)}if(objInter["RA"]||objInter["remove_all"]){var button_ra=document.createElement("BUTTON");button_ra["innerHTML"]="<span class='icon-trash' aria-hidden='true'></span>";button_ra["className"]="btn btn-success Map-btn map-AllRemove";button_ra["title"]=this.oTranslates["COMPONENT_MAP_DELETE_ALL"];$(button_ra).prop("type","button");$(button_ra).on("click",function(){if(this_.interaction!=="none")this_.MapObject.removeInteraction(this_.interaction);
this_.FeatureOverlay.getSource().getFeaturesCollection().clear();this_.FeatureOverlay.getSource().changed();this_.Features.changed()});arrButton.push(button_ra)}if(objInter["RO"]||objInter["remove"]){var button_ro=document.createElement("BUTTON");button_ro["innerHTML"]="<span class='icon-eraser' aria-hidden='true'></span>";button_ro["className"]="btn btn-success Map-btn map-Remove";button_ro["title"]=this.oTranslates["COMPONENT_MAP_DELETE_FEATURE"];$(button_ro).prop("type","button");$(button_ro).on("click",
function(){this_.activeInteraction("remove")});arrButton.push(button_ro)}if(objInter["ED"]||objInter["modify"]){var button_ed=document.createElement("BUTTON");button_ed["innerHTML"]="<span class='icon-edit' aria-hidden='true'></span>";button_ed["className"]="btn btn-success Map-btn map-Modify";button_ed["title"]=this.oTranslates["COMPONENT_MAP_MODIFY_FEATURE"];$(button_ed).prop("type","button");$(button_ed).on("click",function(){this_.activeInteraction("modify")});arrButton.push(button_ed)}if(objInter["DP"]||
objInter["point"]){var button_dp=document.createElement("BUTTON");button_dp["innerHTML"]="<span class='icon-point' aria-hidden='true'></span>";button_dp["className"]="btn btn-success Map-btn map-Point";button_dp["title"]=this.oTranslates["COMPONENT_MAP_DRAW_POINT"];$(button_dp).prop("type","button");$(button_dp).on("click",function(){this_.activeInteraction("point")});arrButton.push(button_dp)}if(objInter["DL"]||objInter["line"]){var button_dl=document.createElement("BUTTON");button_dl["innerHTML"]=
"<span class='icon-line' aria-hidden='true'></span>";button_dl["className"]="btn btn-success Map-btn map-Line";button_dl["title"]=this.oTranslates["COMPONENT_MAP_DRAW_LINE"];$(button_dl).prop("type","button");$(button_dl).on("click",function(){this_.activeInteraction("line")});arrButton.push(button_dl)}if(objInter["DPol"]||objInter["polygon"]){var button_dpol=document.createElement("BUTTON");button_dpol["innerHTML"]="<span class='icon-polygon' aria-hidden='true'></span>";button_dpol["className"]=
"btn btn-success Map-btn map-Polygon";button_dpol["title"]=this.oTranslates["COMPONENT_MAP_DRAW_POLYGON"];$(button_dpol).prop("type","button");$(button_dpol).on("click",function(){this_.activeInteraction("polygon")});arrButton.push(button_dpol)}var element=document.createElement("DIV");element["className"]="btn-group-vertical btn-group-md form-map-Group-btn-interact";for(var i=0;i<arrButton.length;i++)element.appendChild(arrButton[i]);target.appendChild(element);setTimeout(function(){var interactions=
this_.MapObject.getInteractions();interactions.on("change:length",function(){$(element).children().removeClass("active");$(element).children().blur();interactions.forEach(function(element,index,array){$(element.get("binded-button")).addClass("active")})});interactions.on("remove",function(){if(goog.isDefAndNotNull(this_.selectHover_))this_.selectHover_.setActive(false);this_.selectedFeature=null;for(var i=0;i<this_.featureSelectedEvents.length;i++)if(goog.isFunction(this_.featureSelectedEvents[i]))this_.featureSelectedEvents[i].call(this,
this_.selectedFeature)});$(document).keydown(function(e){if(e.keyCode===27)interactions.forEach(function(element,index,array){if(goog.isDef(element.get("binded-button")))this_.MapObject.removeInteraction(element)})})},1E3);return element};
nsVitisComponent.Map.prototype.removeInteraction=function(sInteraction){var button=null;switch(sInteraction){case "full_screen":button=$(this.Target).find(".map-FullScreen");break;case "layer_tree":button=$(this.Target).find(".map-LayerTree");break;case "select":button=$(this.Target).find(".map-Select");break;case "remove_all":case "RA":button=$(this.Target).find(".map-AllRemove");break;case "remove":case "RO":button=$(this.Target).find(".map-Remove");break;case "modify":case "ED":button=$(this.Target).find(".map-Modify");
break;case "point":case "DP":button=$(this.Target).find(".map-Point");break;case "line":case "DL":button=$(this.Target).find(".map-Line");break;case "polygon":case "DPol":button=$(this.Target).find(".map-Polygon");break;default:break}if(goog.isDefAndNotNull(button))$(button).remove()};
nsVitisComponent.Map.prototype.activeSelectHover=function(){var this_=this;if(goog.isDefAndNotNull(this.selectHover_))this.MapObject.removeInteraction(this.selectHover_);this.selectHover_=new ol.interaction.Select({source:this.FeatureOverlay.getSource(),condition:ol.events.condition.pointerMove});this.selectHover_.on("select",function(oEvent){this_.Target.style.cursor="";if(goog.isArray(oEvent.selected))if(oEvent.selected.length>0)this_.Target.style.cursor="pointer"});this.MapObject.addInteraction(this.selectHover_);
this.selectHover_.setActive(true)};
nsVitisComponent.Map.prototype.activeInteraction=function(sInteraction,bForceActive){var this_=this;switch(sInteraction){case "point":var button=$(this.Target).find(".map-Point");break;case "line":var button=$(this.Target).find(".map-Line");break;case "polygon":var button=$(this.Target).find(".map-Polygon");break;case "select":var button=$(this.Target).find(".map-Select");break;case "remove":var button=$(this.Target).find(".map-Remove");break;case "modify":var button=$(this.Target).find(".map-Modify");
break;default:break}var isActive=$(button).hasClass("active");if(bForceActive)isActive=false;if(this.interaction!=="none"){this.MapObject.removeInteraction(this.interaction);if(isActive)return 0}switch(sInteraction){case "point":this.interaction=new ol.interaction.Draw({source:this.FeatureOverlay.getSource(),type:"Point"});this.interaction.set("binded-button",button);this.interaction.set("type","draw_point");this.MapObject.addInteraction(this.interaction);this.interaction.on("drawend",function(event){if(this_.multiGeom!==
true)var features=this_.FeatureOverlay.getSource().getFeaturesCollection().clear();var featureID=featureID+1;event.feature.d_=featureID;this_.Features.changed();this_.callFeatureAddedEvents(event.feature)});break;case "line":this.interaction=new ol.interaction.Draw({source:this.FeatureOverlay.getSource(),type:"LineString"});this.interaction.set("binded-button",button);this.interaction.set("type","draw_line");this.MapObject.addInteraction(this.interaction);this.interaction.on("drawend",function(event){if(this_.multiGeom!==
true)var features=this_.FeatureOverlay.getSource().getFeaturesCollection().clear();var featureID=featureID+1;event.feature.d_=featureID;this_.Features.changed();this_.callFeatureAddedEvents(event.feature)});break;case "polygon":this.interaction=new ol.interaction.Draw({source:this.FeatureOverlay.getSource(),type:"Polygon"});this.interaction.set("binded-button",button);this.interaction.set("type","draw_polygon");this.MapObject.addInteraction(this.interaction);this.interaction.on("drawend",function(event){if(this_.multiGeom!==
true)var features=this_.FeatureOverlay.getSource().getFeaturesCollection().clear();var featureID=featureID+1;event.feature.d_=featureID;this_.Features.changed();this_.callFeatureAddedEvents(event.feature)});break;case "select":var button=$(this.Target).find(".map-Select");this.setSelectInteraction(button);break;case "remove":this.interaction=new ol.interaction.Select({condition:ol.events.condition.click,source:this.FeatureOverlay.getSource()});this.activeSelectHover();this.interaction.set("binded-button",
button);this.interaction.set("type","remove");this.MapObject.addInteraction(this.interaction);this.interaction.getFeatures().on("add",function(){this_.removeFeature(this_.interaction.getFeatures().getArray()[0])});break;case "modify":this.interaction=new ol.interaction.Modify({features:this.FeatureOverlay.getSource().getFeaturesCollection()});this.interaction.set("binded-button",button);this.interaction.set("type","modify");this.MapObject.addInteraction(this.interaction);this.interaction.on("modifyend",
function(){this_.Features.changed()});break;default:break}};
nsVitisComponent.Map.prototype.setSelectInteraction=function(button_select){var this_=this;this.interaction=new ol.interaction.Select({condition:ol.events.condition.click,source:this.FeatureOverlay.getSource()});if(goog.isDefAndNotNull(button_select)){this.interaction.set("binded-button",button_select);this.interaction.set("type","select")}this.MapObject.addInteraction(this.interaction);this.interaction.getFeatures().on("change:length",function(){var aOverlayFeatures=this_.FeatureOverlay.getSource().getFeatures();
var selectInteractionFeature=this_.interaction.getFeatures().getArray()[0];var oSelectedFeature=aOverlayFeatures[aOverlayFeatures.indexOf(selectInteractionFeature)];this_.selectedFeature=goog.isDefAndNotNull(oSelectedFeature)?oSelectedFeature:null;for(var i=0;i<this_.featureSelectedEvents.length;i++)if(goog.isFunction(this_.featureSelectedEvents[i]))this_.featureSelectedEvents[i].call(this,this_.selectedFeature)});this.interaction.displaySelectedFeatureContour=function(){var selectInteractionFeature=
this_.interaction.getFeatures().getArray()[0];var fill=new ol.style.Fill({color:"rgba(255,255,255,0)"});var stroke=new ol.style.Stroke({color:"rgba(0,0,0,0.4)",width:2,lineDash:[10]});var selectStyle=new ol.style.Style({image:new ol.style.Circle({fill:fill,stroke:stroke,radius:50}),fill:fill,stroke:stroke});if(goog.isDefAndNotNull(selectInteractionFeature)){var featureExtentArray=selectInteractionFeature.getGeometry().getExtent();if(selectInteractionFeature.getGeometry().getType()==="Point")var selectionFeature=
new ol.Feature({geometry:selectInteractionFeature.getGeometry()});else{var xmin=featureExtentArray[0];var ymin=featureExtentArray[1];var xmax=featureExtentArray[2];var ymax=featureExtentArray[3];var featureExtentGeometry=new ol.geom.Polygon([[[xmin,ymin],[xmin,ymax],[xmax,ymax],[xmax,ymin]]]);var selectionFeature=new ol.Feature({geometry:featureExtentGeometry})}selectionFeature.setStyle(selectStyle);this_.interaction.getFeatures().push(selectionFeature)}};this.interaction.on("select",function(){this_.interaction.displaySelectedFeatureContour()});
this.activeSelectHover()};nsVitisComponent.Map.prototype.removeFeature=function(oFeature){this.FeatureOverlay.getSource().removeFeature(oFeature);this.interaction.getFeatures().clear();if(goog.isDefAndNotNull(this.selectHover_))this.selectHover_.getFeatures().clear();this.FeatureOverlay.getSource().changed();this.Features.changed()};
nsVitisComponent.Map.prototype.loadTree=function(tree){if(this.MapObject.getLayers().getArray().length>0)this.MapObject.getLayers().clear();this.Layers.length=0;var oLayer;var aTree=[];var tileSize=[256,256];var oMapDefinition=angular.copy(tree);var oMapJSON=new MapJSON({"properties":this.$propertiesSrvc_});var olView=oMapJSON.getViewFromDef(oMapDefinition,{"size":this.MapObject.getSize(),"tileSize":tileSize});var olLayers=oMapJSON.getLayersFromDef(oMapDefinition,{"size":this.MapObject.getSize(),
"tileSize":tileSize});this.MapObject.setView(olView);for(var i=0;i<olLayers.length;i++){var oLayer={"index":i,"layer":olLayers[i]};this.Layers.push(oLayer);this.MapObject.addLayer(olLayers[i])}for(var i=0;i<oMapDefinition["children"].length;i++)if(goog.isDef(oMapDefinition["children"][i]["children"]))aTree.push({"service":oMapDefinition["children"][i]["name"],"layers":oMapDefinition["children"][i]["children"]});return aTree};
nsVitisComponent.Map.prototype.isInsideProjExtent=function(viewExtent,projExtent){var bIsInside=true;if(projExtent[0]>viewExtent[0])bIsInside=false;if(projExtent[1]>viewExtent[1])bIsInside=false;if(projExtent[2]<viewExtent[2])bIsInside=false;if(projExtent[3]<viewExtent[3])bIsInside=false;return bIsInside};
nsVitisComponent.Map.prototype.getScale=function(){var wgs84Sphere_=new ol.Sphere(6378137);var projection=this.MapObject.getView().getProjection();var map=this.MapObject;var line=map.getView().calculateExtent([37.795275591,0]);var c1=ol.proj.transform([line[0],line[1]],projection,"EPSG:4326");var c2=ol.proj.transform([line[2],line[3]],projection,"EPSG:4326");var length=wgs84Sphere_.haversineDistance(c1,c2);var scale=length*100;return scale};
nsVitisComponent.Map.prototype.setScale=function(scale){var currentScale=this["getScale"]();var currentResolution=this.MapObject.getView().getResolution();var scaleResolution=scale*currentResolution/currentScale;this.MapObject.getView().setResolution(scaleResolution);currentScale=this["getScale"]()};nsVitisComponent.Map.prototype.setExtent=function(extent){this.Extent=extent;this.MapObject.getView().fit(extent,{nearest:true})};nsVitisComponent.Map.prototype.getZoom=function(){return this.MapObject.getView().getZoom()};
nsVitisComponent.Map.prototype.setZoom=function(zoom){this.MapObject.getView().setZoom(zoom)};nsVitisComponent.Map.prototype.setCenter=function(coord){this.MapObject.getView().setCenter(coord)};
nsVitisComponent.Map.prototype.setControls=function(obj){var this_=this;this.MapObject.getControls().clear();if(this.ZoomGroup!=="undefined")$(this.ZoomGroup).remove();if(obj["ZO"])this.ZoomGroup=this.zoomControls(this.Target);if(obj["MP"]){this.MapObject.addControl(new ol.control.MousePosition({coordinateFormat:function(coordinate){return[coordinate[0].toPrecision(this_.Accuracy),coordinate[1].toPrecision(this_.Accuracy)]}}));$(".ol-mouse-position").css("bottom","8px");$(".ol-mouse-position").css("top",
"auto");$(".ol-mouse-position").css("background","rgba(218, 94, 209, 0.58)");$(".ol-mouse-position").css("color","#ffffff");$(".ol-mouse-position").css("border-radius","4px")}if(obj["SL"]){this.MapObject.addControl(new ol.control.ScaleLine);$(".ol-scale-line").css("background","rgba(218, 94, 209, 0.58)")}if(obj["CP"])this.MapObject.addControl(new ol.control.Control({"element":this_.element,"render":function(){$(this_.element).html(this_.proj_)}}))};
nsVitisComponent.Map.prototype.setInteractions=function(obj){this.MapObject.getInteractions().clear();if(this.IntractionsGroup!=="undefined")$(this.IntractionsGroup).remove();this.IntractionsGroup=this.addInteractions(this.Target,obj);ol.interaction.defaults().forEach(function(el,index,arr){this.MapObject.addInteraction(el)},this)};
nsVitisComponent.Map.prototype.setBingSource=function(objSource){this.MapObject.getLayers().getArray()[0].setSource(new ol.source.BingMaps({culture:objSource["culture"],key:objSource["key"],imagerySet:objSource["style"]}))};nsVitisComponent.Map.prototype.getConfig=function(){this.Config["extent"]=this.View.calculateExtent(this.MapObject.getSize());this.Config["coord"]=this.View.getCenter();this.Config["scale"]=Math.round(this["getScale"]());return this.Config};
nsVitisComponent.Map.prototype.getMap=function(){return this.MapObject};
nsVitisComponent.Map.prototype.setView=function(options){this.proj_=options["proj"];var center,extent;if(goog.isDef(options["center"]["coord"]))center=options["center"]["coord"];if(goog.isDef(options["center"]["extent"]))extent=options["center"]["extent"];if(options["center"]["coord"]&&options["center"]["zoom"]){this.View=new ol.View({"center":center,"zoom":options["center"]["zoom"],"projection":ol.proj.get(this.proj_)});this.MapObject.setView(this.View)}else{this.View=new ol.View({"center":[(extent[0]+
extent[2])/2,(extent[1]+extent[3])/2],"projection":ol.proj.get(this.proj_)});this.MapObject.setView(this.View);this.MapObject.getView().fit(extent,{nearest:true})}var currentProj="";for(var i=0;i<this.oProj_["projections"];i++)if(this.proj_===this.oProj["projections"][i]["code"])currentProj=this.oProj["projections"][i]["name"];if(currentProj!=="")$(".ol-current-projection-studio").html(currentProj);else $(".ol-current-projection-studio").html(this.proj_)};
nsVitisComponent.Map.prototype.setJsonTree=function(tree){this.loadTree(tree)};nsVitisComponent.Map.prototype.getFeatures=function(){return this.Features.getArray()};nsVitisComponent.Map.prototype.getProj=function(){return this.proj_};nsVitisComponent.Map.prototype.getExtent=function(){return this.View.calculateExtent(this.MapObject.getSize())};nsVitisComponent.Map.prototype.getCenter=function(){return this.View.getCenter()};
nsVitisComponent.Map.prototype.transformer=function(data,epsgFrom,epsgTo){return ol.proj.transform(data,epsgFrom,epsgTo)};nsVitisComponent.Map.prototype.transformExtent=function(extent,epsgFrom,epsgTo){return ol.proj.transformExtent(extent,epsgFrom,epsgTo)};nsVitisComponent.Map.prototype.on=function(event,handler,this_){this.MapObject.on(event,handler,this_)};
nsVitisComponent.Map.prototype.drawPoint=function(x,y){var Map=this.getMap();var this_=this;var Point=new ol.Feature({"geometry":new ol.geom.Point([x,y])});var array=Map.getLayers().getArray();array.forEach(function(item,index,array){if(goog.isDef(item.getSource().getFeatures)){var Features=item.getSource().getFeaturesCollection();if(this_.multiGeom!==true)item.getSource().getFeaturesCollection().clear();Features.push(Point)}});this.setCenter([x,y])};
nsVitisComponent.Map.prototype.onFeatureSelected=function(event){this.featureSelectedEvents.push(event)};nsVitisComponent.Map.prototype.onFeaturesChanged=function(event){this.featuresChangedEvents.push(event)};nsVitisComponent.Map.prototype.onFeatureAdded=function(event){this.featureAddedEvents.push(event)};nsVitisComponent.Map.prototype.onceFeatureAdded=function(event){this.featureAddedOnceEvents.push(event)};
nsVitisComponent.Map.prototype.callFeatureAddedEvents=function(feature){for(var i=0;i<this.featureAddedEvents.length;i++)if(goog.isFunction(this.featureAddedEvents[i]))this.featureAddedEvents[i].call(this,feature);for(var i=0;i<this.featureAddedOnceEvents.length;i++)if(goog.isFunction(this.featureAddedOnceEvents[i]))this.featureAddedOnceEvents[i].call(this,feature);goog.array.clear(this.featureAddedOnceEvents)};goog.provide("formReader");goog.require("nsVitisComponent.Map");var formReader=function(){};formReader.module=angular.module("formReader",["angular.bind.notifier"]);goog.provide("formReader.controller.formReaderController");goog.require("formReader");
formReader.formReaderController=function($scope,$q,$log,formReaderService,$rootScope,$element){$log.info("formReader.formReaderController");var this_=this;this.$scope_=$scope;this.$q_=$q;this.$log_=$log;this.$element_=$element;this.formReaderService_=formReaderService;this.aWatchedVariables_=[];$scope["oFormValues"]=goog.isDef($scope["oFormValues"])?$scope["oFormValues"]:{};$scope["oFormDefinition"]=goog.isDef($scope["oFormDefinition"])?$scope["oFormDefinition"]:{};$scope["sFormDefinitionName"]=goog.isDef($scope["sFormDefinitionName"])?
$scope["sFormDefinitionName"]:"";this.initFormTabs();$scope["sFormUniqueName"]=Date.now();$scope["iDisplayedTab"]=0;$scope.$watch("iDisplayedTab",function(){this_.refreshSubformGrids()});if(typeof $rootScope["oFormPromises"]=="undefined")$rootScope["oFormPromises"]={};$rootScope["oFormPromises"][$scope["sFormDefinitionName"]]=[];var oFormDefinition=$scope["oFormDefinition"][$scope["sFormDefinitionName"]];if(typeof oFormDefinition!="undefined"&&oFormDefinition["formDefinitionLoaded"]===true)this_.loadForm();
else var clearListener=$rootScope.$on("formDefinitionLoaded",function(){clearListener();this_.loadForm()})};formReader.module.controller("AppFormReaderController",formReader.formReaderController);
formReader.formReaderController.prototype.initFormTabs=function(){if(goog.isDefAndNotNull(this.$scope_["oFormDefinition"]))if(goog.isDefAndNotNull(this.$scope_["sFormDefinitionName"]))if(goog.isDefAndNotNull(this.$scope_["oFormDefinition"][this.$scope_["sFormDefinitionName"]]))if(!goog.isDefAndNotNull(this.$scope_["oFormDefinition"][this.$scope_["sFormDefinitionName"]]["tabs"])){var oForm=this.$scope_["oFormDefinition"][this.$scope_["sFormDefinitionName"]];var aElems=[];if(goog.isDefAndNotNull(oForm["rows"])){for(var i=
0;i<oForm["rows"].length;i++)if(goog.isDefAndNotNull(oForm["rows"][i]["fields"]))for(var ii=0;ii<oForm["rows"][i]["fields"].length;ii++)if(goog.isDefAndNotNull(oForm["rows"][i]["fields"][ii]["name"]))aElems.push(oForm["rows"][i]["fields"][ii]["name"]);else if(goog.isDefAndNotNull(oForm["rows"][i]["fields"][ii]["buttons"]))for(var iii=0;iii<oForm["rows"][i]["fields"][ii]["buttons"].length;iii++)if(goog.isDefAndNotNull(oForm["rows"][i]["fields"][ii]["buttons"][iii]["name"]))aElems.push(oForm["rows"][i]["fields"][ii]["buttons"][iii]["name"]);
this.$scope_["oFormDefinition"][this.$scope_["sFormDefinitionName"]]["tabs"]={"position":"top","list":[{"label":"Tab 0","elements":aElems}]}}}};
formReader.formReaderController.prototype.loadForm=function(){var this_=this;this.initFormTabs();this.useDefaultValues(false);setTimeout(function(){var formDefinition=this_.$scope_["oFormDefinition"];var formDefinitionName=this_.$scope_["sFormDefinitionName"];if(!goog.isDefAndNotNull(formDefinition))return 0;if(!goog.isDefAndNotNull(formDefinitionName))return 0;if(!goog.isDefAndNotNull(formDefinition[formDefinitionName]))return 0;var initEvent=formDefinition[formDefinitionName]["initEvent"];setTimeout(function(){if(goog.isDefAndNotNull(formDefinition[formDefinitionName]["initEvent"]))if(this_.formReaderService_["isFunctionCall"](initEvent))this_.formReaderService_["callFunction"](initEvent);
setTimeout(function(){this_.extractFormDefinitionInfos()})})});this.$scope_["iDisplayedTab"]=0;this.$scope_.$broadcast("loadForm")};formReader.formReaderController.prototype.refreshForm=function(){this.initFormTabs();this.$scope_.$broadcast("$$rebind::refresh")};
formReader.formReaderController.prototype.setFormDefinition=function(oFormDefinition){this.$log_.log("formReader.formReaderController.prototype.setFormDefinition");this.$scope_["oFormDefinition"]=oFormDefinition;this.formReaderService_["oFormDefinition"]=oFormDefinition;this.refreshForm();this.$scope_["iDisplayedTab"]=0};
formReader.formReaderController.prototype.setFormValues=function(oFormValues){this.$log_.log("formReader.formReaderController.prototype.setFormValues");this.$scope_["oFormValues"]=oFormValues;this.formReaderService_["oFormValues"]=oFormValues};
formReader.formReaderController.prototype.setDefinitionName=function(oFormDefinitionName){this.$log_.log("formReader.formReaderController.prototype.setDefinitionName");this.$scope_["sFormDefinitionName"]=oFormDefinitionName;this.formReaderService_["sFormDefinitionName"]=oFormDefinitionName};
formReader.formReaderController.prototype.valueIsPresent=function(oField,oValue){if(!goog.isDef(oField)||!goog.isDef(oValue))return false;if(!goog.isDef(oField["options"]))return false;if(!goog.object.isEmpty(oValue))if(goog.isDefAndNotNull(oValue["selectedOption"]))if(goog.isDefAndNotNull(oValue["selectedOption"]["value"]))oValue=oValue["selectedOption"]["value"];if(goog.isArray(oField["options"])&&oField["options"].length>0){var valueIsPresent=false;for(var i=0;i<oField["options"].length;i++)if(oField["options"][i]["value"]===
oValue)valueIsPresent=true;return valueIsPresent}else return false};formReader.formReaderController.prototype.toTest=function(object){};
formReader.formReaderController.prototype.useDefaultValues=function(bEraseFormValues,sElementName){this.$log_.log("formReader.formReaderController.prototype.useDefaultValues");var $scope=this.$scope_;var oFormValues=$scope["oFormValues"];var oFormDefinition=$scope["oFormDefinition"];var sFormDefinitionName=$scope["sFormDefinitionName"];if(!goog.isDefAndNotNull(oFormValues))return 0;if(!goog.isDefAndNotNull(oFormDefinition))return 0;if(!goog.isDefAndNotNull(sFormDefinitionName))return 0;if(!goog.isDefAndNotNull(oFormDefinition[sFormDefinitionName]))return 0;
var aRows=oFormDefinition[sFormDefinitionName]["rows"];if(!goog.isDefAndNotNull(aRows))return 0;for(var i=0;i<aRows.length;i++)if(goog.isDefAndNotNull(aRows[i]["fields"]))for(var ii=0;ii<aRows[i]["fields"].length;ii++){if(aRows[i]["fields"][ii]["type"]==="bo_grid"||aRows[i]["fields"][ii]["type"]==="ui_grid"||aRows[i]["fields"][ii]["type"]==="section_grid")continue;var field;try{field=angular.copy(aRows[i]["fields"][ii])}catch(e){console.error("try angular.copy failed");continue}if(goog.isDefAndNotNull(sElementName))if(field["name"]!==
sElementName)continue;if(goog.isDefAndNotNull(field["default_value"])&&field["default_value"]!=="")if(this.formReaderService_["isFunctionCall"](field["default_value"]))field["default_value"]=this.formReaderService_["callFunction"](field["default_value"]);if(field["type"]==="select"||field["type"]==="editable_select"){if(goog.isDefAndNotNull(field["default_value"])&&field["default_value"]!=="")field["default_value"]={"value":field["default_value"]}}else if(field["type"]==="list"||field["type"]==="double_select")if(goog.isDefAndNotNull(field["default_value"])&&
field["default_value"]!==""){var aDefaultKeys=[];if(goog.isString(field["default_value"]))aDefaultKeys=field["default_value"].split("|");else aDefaultKeys=field["default_value"];var aDefaults=[];for(var iii=0;iii<aDefaultKeys.length;iii++)aDefaults.push({"value":aDefaultKeys[iii]});field["default_value"]=aDefaults}if(this.useDefaultValue(field,bEraseFormValues))if(field["type"]==="select"||field["type"]==="editable_select"||field["type"]==="list"){if(!goog.isDefAndNotNull(oFormValues[sFormDefinitionName][field["name"]]))oFormValues[sFormDefinitionName][field["name"]]=
{};oFormValues[sFormDefinitionName][field["name"]]["selectedOption"]=field["default_value"]}else if(field["type"]==="double_select"){if(!goog.isDefAndNotNull(oFormValues[sFormDefinitionName][field["name"]]))oFormValues[sFormDefinitionName][field["name_to"]]={};oFormValues[sFormDefinitionName][field["name_to"]]["selectedOption"]=field["default_value"]}else if(field["type"]==="editable_double_select"){if(!goog.isDefAndNotNull(oFormValues[sFormDefinitionName][field["name"]]))oFormValues[sFormDefinitionName][field["name_available_tags"]]=
{};oFormValues[sFormDefinitionName][field["name_available_tags"]]["selectedOption"]=field["default_value"]}else oFormValues[sFormDefinitionName][field["name"]]=field["default_value"];delete field}};
formReader.formReaderController.prototype.useDefaultValue=function(oField,bEraseFormValues){this.$log_.log("formReader.formReaderController.prototype.useDefaultValue");var $scope=this.$scope_;var oFormValues=$scope["oFormValues"];var sFormDefinitionName=$scope["sFormDefinitionName"];if(goog.isDef(oField["default_value"])&&oField["default_value"]!=="")if(bEraseFormValues===true)return true;else if(oField["type"]==="select"){if(!goog.isDefAndNotNull(oFormValues[sFormDefinitionName][oField["name"]]))return true;
if(!goog.isDefAndNotNull(oFormValues[sFormDefinitionName][oField["name"]]["selectedOption"]))return true;if(!goog.isDefAndNotNull(oFormValues[sFormDefinitionName][oField["name"]]["selectedOption"]["value"]))return true;if(oFormValues[sFormDefinitionName][oField["name"]]["selectedOption"]["value"].length===0)return true}else if(oField["type"]==="editable_select"){if(!goog.isDefAndNotNull(oFormValues[sFormDefinitionName][oField["name"]]))return true;if(!goog.isDefAndNotNull(oFormValues[sFormDefinitionName][oField["name"]]["selectedOption"]))return true;
if(!goog.isDefAndNotNull(oFormValues[sFormDefinitionName][oField["name"]]["selectedOption"]["value"]))return true;if(oFormValues[sFormDefinitionName][oField["name"]]["selectedOption"]["value"].length===0)return true}else if(oField["type"]==="list"){if(!goog.isDefAndNotNull(oFormValues[sFormDefinitionName][oField["name"]]))return true;if(!goog.isArray(oFormValues[sFormDefinitionName][oField["name"]]["selectedOption"]))return true;if(oFormValues[sFormDefinitionName][oField["name"]]["selectedOption"].length===
0)return true;if(oFormValues[sFormDefinitionName][oField["name"]]["selectedOption"][0]["value"].length===0)return true}else if(oField["type"]==="double_select"){if(!goog.isDefAndNotNull(oFormValues[sFormDefinitionName][oField["name_to"]]))return true;if(!goog.isArray(oFormValues[sFormDefinitionName][oField["name_to"]]["selectedOption"]))return true;if(oFormValues[sFormDefinitionName][oField["name_to"]]["selectedOption"].length===0)return true;if(oFormValues[sFormDefinitionName][oField["name_to"]]["selectedOption"][0]["value"].length===
0)return true}else if(oField["type"]==="editable_double_select"){if(!goog.isDefAndNotNull(oFormValues[sFormDefinitionName][oField["name_available_tags"]]))return true;if(!goog.isArray(oFormValues[sFormDefinitionName][oField["name_available_tags"]]["selectedOption"]))return true;if(oFormValues[sFormDefinitionName][oField["name_available_tags"]]["selectedOption"].length===0)return true;if(oFormValues[sFormDefinitionName][oField["name_available_tags"]]["selectedOption"][0]["value"].length===0)return true}else{if(!goog.isDefAndNotNull(oFormValues[sFormDefinitionName][oField["name"]]))return true;
if(oFormValues[sFormDefinitionName][oField["name"]].length===0)return true}else return false};
formReader.formReaderController.prototype.extractFormDefinitionInfos=function(){this.$log_.log("formReader.formReaderController.prototype.extractFormDefinitionInfos");if(!goog.isDef(this.$scope_["oFormDefinition"])){console.error("$scope['oFormDefinition'] not defined");return 0}this.$scope_.$broadcast("extractFormDefinitionInfos");this.$scope_["bFormDefinitionInfosExtracted"]=true;var oFormDefinition=this.$scope_["oFormDefinition"][this.$scope_["sFormDefinitionName"]];var oFormValues=this.$scope_["oFormValues"][this.$scope_["sFormDefinitionName"]];
var oDataSources=this.$scope_["oFormDefinition"]["datasources"];var formFieldValue;var selectValue;var this_=this;if(!goog.isDefAndNotNull(this.$scope_.$root["oFormPromises"][this.$scope_["sFormDefinitionName"]]))this.$scope_.$root["oFormPromises"][this.$scope_["sFormDefinitionName"]]=[];var deferred=this.$q_.defer();var promise=deferred.promise;this.$scope_.$root["oFormPromises"][this.$scope_["sFormDefinitionName"]].push(promise);for(var i=0;i<this_.aWatchedVariables_.length;i++)this_.aWatchedVariables_[i]();
this_.aWatchedVariables_.length=0;if(goog.isDef(oFormDefinition)&&goog.isDef(oFormDefinition["rows"]))for(var i=0;i<oFormDefinition["rows"].length;i++)for(var j=0;j<oFormDefinition["rows"][i]["fields"].length;j++){var elem=oFormDefinition["rows"][i]["fields"][j];formFieldValue=oFormValues[elem["name"]];if(typeof elem["id"]==="undefined"&&typeof elem["name"]!=="undefined")elem["id"]=this.$scope_["sFormDefinitionName"]+"_"+elem["name"];switch(elem["type"]){case "select":case "editable_select":case "list":case "double_select":elem["id_from"]=
elem["id"]+"_from";var oWebService=null;var aOptions=null;if(goog.isDef(elem["datasource"]))if(goog.isDef(elem["datasource"]["datasource_id"]))if(goog.isDef(oDataSources))if(goog.isDef(oDataSources[elem["datasource"]["datasource_id"]]))if(oDataSources[elem["datasource"]["datasource_id"]]["type"]==="web_service")oWebService=this_.extractElemWebService(elem,oDataSources);else if(oDataSources[elem["datasource"]["datasource_id"]]["type"]==="object")aOptions=this_.extractElemOptions(elem,oDataSources);
if(goog.isDef(elem["web_service"]))oWebService=angular.copy(elem["web_service"]);if(goog.isDefAndNotNull(elem["options"]))var aUsedOptions=elem["options"];if(goog.isDefAndNotNull(aOptions))var aUsedOptions=aOptions;if(goog.isDefAndNotNull(oWebService)){oWebService=angular.copy(oWebService);if(oWebService["load_first_time"]!==false){if(goog.isDef(oWebService["parents"]))this.listenParentsChanges(elem,oWebService,oFormValues);var parents_ready=this.areParentsReady(oFormValues,oWebService["parents"],
true);if(parents_ready)this.formReaderService_["setWebServiceSelectOptions"](elem,this.$scope_["sFormDefinitionName"],this.$scope_["oFormValues"],oWebService);delete oWebService}else if(typeof oWebService["callback"]!=="undefined")if(this_.formReaderService_["isFunctionCall"](oWebService["callback"]))this_.formReaderService_["callFunction"](oWebService["callback"])}else if(goog.isDef(aUsedOptions))this.formReaderService_["setSelectOptions"](elem,this.$scope_["sFormDefinitionName"],this.$scope_["oFormValues"],
aUsedOptions);else if(typeof formFieldValue!=="object"){selectValue=formFieldValue;if(elem["type"]==="select"||elem["type"]==="editable_select")oFormValues[elem["name"]]={"selectedOption":{"value":selectValue},"options":[]};else oFormValues[elem["name"]]={"selectedOption":[{"value":selectValue}],"options":[]}}break;case "editable_double_select":elem["name_available_tags"]=elem["name"]+"_available";elem["id_available_tags"]=elem["id"]+"_available";if(typeof elem["web_service"]!=="undefined")this.formReaderService_["setWebServiceTags"](elem,
this.$scope_["sFormDefinitionName"],this.$scope_["oFormValues"]);break;case "title":case "subtitle":case "label":case "button":break;case "ui_grid":if(typeof elem["datasource"]!="undefined"&&oDataSources[elem["datasource"]["datasource_id"]]["type"]==="web_service"){oWebService=this_.extractElemWebService(elem,oDataSources);var oUiGridElem=elem;this_.formReaderService_["getWebServiceData"](oWebService).then(function(aData){var oGridOptions=angular.element("#"+oUiGridElem["id"]+"_grid .ui-grid-contents-wrapper").scope()["grid"]["options"];
oGridOptions["data"]=aData})}break;default:break}delete elem}this.$q_.all(this.$scope_.$root["oFormPromises"][this.$scope_["sFormDefinitionName"]]).then(function(values){setTimeout(function(){this_.$scope_.$root.$emit("formExtracted",this_.$scope_["sFormDefinitionName"])});if(goog.isDefAndNotNull(oFormDefinition)){var sFormName=oFormDefinition["name"];var oFormElement=angular.element("form[name='"+sFormName+"']");if(oFormElement.length>0){var oFormElementScope=oFormElement.scope();if(goog.isDefAndNotNull(oFormElementScope[sFormName]))oFormElementScope[sFormName].$setPristine()}}});
deferred.resolve()};
formReader.formReaderController.prototype.listenParentsChanges=function(elem,oWebService,oFormValues){var this_=this;oWebService["parameters"]["original_filter"]=goog.isDefAndNotNull(oWebService["parameters"]["filter"])?oWebService["parameters"]["filter"]:"";oWebService["parameters"]["original_filter_copy"]=angular.copy(oWebService["parameters"]["original_filter"]);for(var i=0;i<oWebService["parents"].length;i++){var filter_attr=oWebService["parents"][i]["filter_attr"];var filter_equality=oWebService["parents"][i]["filter_equality"];
if(goog.isDef(oWebService["parents"][i]["name_to"]))var watchedVariableName=oWebService["parents"][i]["name_to"];else var watchedVariableName=oWebService["parents"][i]["name"];var sWatchedVariable=angular.copy("oFormValues."+this_.$scope_["sFormDefinitionName"]+"."+watchedVariableName+".selectedOption");var oldValue=oFormValues[watchedVariableName];var bFirstLoad=true;setTimeout(function(opt_options){var sParentsChanged=angular.bind({elem:opt_options.elem,oWebService:opt_options.oWebService,filter_attr:opt_options.filter_attr,
filter_equality:opt_options.filter_equality,watchedVariableName:opt_options.watchedVariableName},function(changed,newVal,oldVal,scope){var elem=this.elem;var oWebService=this.oWebService;var filter_attr=this.filter_attr;var filter_equality=this.filter_equality;var watchedVariableName=this.watchedVariableName;var watchedVariableValue=oFormValues[watchedVariableName];var oSelectedOption;if(!bFirstLoad)if(goog.isObject(oldValue)&&goog.isObject(watchedVariableValue))if(goog.isDefAndNotNull(watchedVariableValue["selectedOption"])&&
goog.isDefAndNotNull(oldValue["selectedOption"]))if(goog.isDefAndNotNull(watchedVariableValue["selectedOption"]["value"])&&goog.isDefAndNotNull(oldValue["selectedOption"]["value"]))if(watchedVariableValue["selectedOption"]["value"]==oldValue["selectedOption"]["value"])return 0;if(!goog.isDefAndNotNull(watchedVariableValue))return 0;if(!goog.isDefAndNotNull(watchedVariableValue["selectedOption"]))return 0;else if(goog.isArray(watchedVariableValue["selectedOption"])){if(watchedVariableValue["selectedOption"].length===
0)return 0}else if(!goog.isDefAndNotNull(watchedVariableValue["selectedOption"]["value"]))return 0;var parents_ready=this_.areParentsReady(oFormValues,oWebService["parents"]);if(goog.isDefAndNotNull(this_.$scope_["oFormValues"]))if(goog.isDefAndNotNull(this_.$scope_["oFormValues"][this_.$scope_["sFormDefinitionName"]]))if(goog.isDefAndNotNull(this_.$scope_["oFormValues"][this_.$scope_["sFormDefinitionName"]][elem["name"]]))if(goog.isDefAndNotNull(this_.$scope_["oFormValues"][this_.$scope_["sFormDefinitionName"]][elem["name"]]["selectedOption"]))oSelectedOption=
angular.copy(this_.$scope_["oFormValues"][this_.$scope_["sFormDefinitionName"]][elem["name"]]["selectedOption"]);this_.formReaderService_["emptySelectOptions"](elem,this_.$scope_["sFormDefinitionName"],this_.$scope_["oFormValues"]);if(parents_ready){oWebService["parameters"]["original_filter"]=angular.copy(oWebService["parameters"]["original_filter_copy"]);oWebService["parameters"]["filter"]=this_.getNewFilter(oFormValues,oWebService["parents"],oWebService["parameters"]["original_filter"]);this_.$log_.log({"filter: ":angular.copy(oWebService["parameters"]["filter"])});
this_.formReaderService_["setWebServiceSelectOptions"](elem,this_.$scope_["sFormDefinitionName"],this_.$scope_["oFormValues"],oWebService,oSelectedOption)}oldValue=angular.copy(watchedVariableValue);bFirstLoad=false},true);sParentsChanged();this_.aWatchedVariables_.push(this_.$scope_.$watch(opt_options.sWatchedVariable,sParentsChanged))},1E3,{sWatchedVariable:sWatchedVariable,elem:elem,oWebService:oWebService,filter_attr:filter_attr,filter_equality:filter_equality,watchedVariableName:watchedVariableName});
delete filter_attr;delete filter_equality;delete sWatchedVariable}};
formReader.formReaderController.prototype.extractElemWebService=function(elem,oDataSources){if(elem["type"]!="ui_grid"){if(!goog.isDef(elem["datasource"]["id_key"]))return null;if(!goog.isDef(elem["datasource"]["label_key"]))return null}var oWebService=angular.copy(oDataSources[elem["datasource"]["datasource_id"]]);oWebService["id_key"]=elem["datasource"]["id_key"];oWebService["label_key"]=elem["datasource"]["label_key"];oWebService["parameters"]=goog.isDef(oWebService["parameters"])?oWebService["parameters"]:
{};if(goog.isDef(elem["datasource"]["parents"]))oWebService["parents"]=elem["datasource"]["parents"];if(goog.isDef(elem["datasource"]["filter"]))oWebService["parameters"]["filter"]=elem["datasource"]["filter"];if(goog.isDef(elem["datasource"]["distinct"]))oWebService["parameters"]["distinct"]=elem["datasource"]["distinct"];if(goog.isDef(elem["datasource"]["attributs"]))oWebService["parameters"]["attributs"]=elem["datasource"]["attributs"];if(goog.isDef(elem["datasource"]["order_by"]))oWebService["parameters"]["order_by"]=
elem["datasource"]["order_by"];if(goog.isDef(elem["datasource"]["sort_order"]))oWebService["parameters"]["sort_order"]=elem["datasource"]["sort_order"];return oWebService};
formReader.formReaderController.prototype.extractElemOptions=function(elem,oDataSources){var aOptions=[];if(goog.isDef(oDataSources[elem["datasource"]["datasource_id"]]["data"])&&goog.isDef(elem["datasource"]["id_key"])&&goog.isDef(elem["datasource"]["label_key"])){var id_key=elem["datasource"]["id_key"];var label_key=elem["datasource"]["label_key"];var aData=oDataSources[elem["datasource"]["datasource_id"]]["data"];if(!goog.isDef(id_key))console.error("id_key not defined (required in for data json source)");
if(!goog.isDef(label_key))console.error("label_key not defined (required in for data json source)");if(goog.isDef(id_key)&&goog.isDef(label_key))for(var i=0;i<aData.length;i++)aOptions.push(aData[i][label_key]+"|"+aData[i][id_key]);delete id_key;delete label_key;delete aData}if(goog.isDef(oDataSources[elem["datasource"]["datasource_id"]]["options"]))aOptions=oDataSources[elem["datasource"]["datasource_id"]]["options"];return aOptions};
formReader.formReaderController.prototype.areParentsReady=function(oFormValues,aParents,bLookOnlyWaited){var parents_ready=true;if(!goog.isDefAndNotNull(oFormValues)){console.error("formReader.formReaderController.prototype.areParentsReady: oFormValues not defined");return false}if(!goog.isDefAndNotNull(aParents)||goog.isArray(aParents)&&aParents.length===0)return true;for(var i=0;i<aParents.length;i++){if(aParents[i]["wait_for_parent"]==="false"||aParents[i]["wait_for_parent"]===false)continue;else if(bLookOnlyWaited===
true)return false;if(!goog.isDefAndNotNull(oFormValues[aParents[i]["name"]])){parents_ready=false;continue}if(!goog.isDefAndNotNull(oFormValues[aParents[i]["name"]]["selectedOption"])){parents_ready=false;continue}if(goog.isArray(oFormValues[aParents[i]["name"]]["selectedOption"])){if(oFormValues[aParents[i]["name"]]["selectedOption"].length===0){parents_ready=false;continue}if(oFormValues[aParents[i]["name"]]["selectedOption"][0]["value"].length===0){parents_ready=false;continue}}if(!goog.isArray(oFormValues[aParents[i]["name"]]["selectedOption"])){if(!goog.isDefAndNotNull(oFormValues[aParents[i]["name"]]["selectedOption"]["value"])){parents_ready=
false;continue}if(oFormValues[aParents[i]["name"]]["selectedOption"]["value"].length===0){parents_ready=false;continue}}}return parents_ready};
formReader.formReaderController.prototype.getNewFilter=function(oFormValues,aParents,originalFilter){var additionalFilter={"relation":"AND","operators":[]};aParents=goog.isDefAndNotNull(aParents)?aParents:[];if(!goog.isDefAndNotNull(originalFilter)||String(originalFilter).trim()==="")originalFilter={"relation":"AND","operators":[]};for(var i=0;i<aParents.length;i++){if(!goog.isDef(oFormValues[aParents[i]["name"]]))continue;if(!goog.isDef(oFormValues[aParents[i]["name"]]["selectedOption"]))continue;
if(!goog.isDef(oFormValues[aParents[i]["name"]]["selectedOption"]["value"])){if(!goog.isArray(oFormValues[aParents[i]["name"]]["selectedOption"]))continue;if(oFormValues[aParents[i]["name"]]["selectedOption"].length<1)continue}var aParentValues=[];if(!goog.isArray(oFormValues[aParents[i]["name"]]["selectedOption"])&&goog.isDef(oFormValues[aParents[i]["name"]]["selectedOption"]["value"]))aParentValues.push(oFormValues[aParents[i]["name"]]["selectedOption"]);else aParentValues=oFormValues[aParents[i]["name"]]["selectedOption"];
var key=aParents[i]["filter_attr"];var equality=aParents[i]["filter_equality"];var parentFilter={"relation":"OR","operators":[]};for(var ii=0;ii<aParentValues.length;ii++){var value=aParentValues[ii]["value"];if(!goog.isDefAndNotNull(value))continue;else if(goog.isString(value)&&!value.length>0)continue;parentFilter["operators"].push({"column":key,"compare_operator":equality,"value":value});delete value}if(parentFilter["operators"].length===0)continue;additionalFilter["operators"].push(parentFilter);
delete aParentValues;delete key;delete equality;delete parentFilter}delete i;if(additionalFilter["operators"].length>0)originalFilter["operators"].push(additionalFilter);return originalFilter};
formReader.formReaderController.prototype.numberParser=function(str,bInt){str=goog.isDef(str)?str:"";bInt=goog.isDef(bInt)?bInt:false;if(bInt)return this.integerParser(str);else{str=str.replace(",",".");var parts=str.split(".");if(parts.length===0)return NaN;else if(parts.length===1)if(str.charAt(str.length-1)===".")return this.integerParser(str)+".";else return this.integerParser(str);else if(parts.length>=2){var left=this.integerParser(parts[0]);var right=0;if(parts.length===2)if(parts[1]==="")return this.integerParser(str)+
".";else right=this.integerParser(parts[1],true);else{var tmp="";for(var i=1;i<parts.length;i++)tmp+=parts[i];right=this.integerParser(tmp)}return parseFloat(left+"."+right).toFixed(String(right).length)}else return NaN}};
formReader.formReaderController.prototype.integerParser=function(str,bKeepZeros){var ret="";if(typeof bKeepZeros=="undefined")bKeepZeros=false;for(var i=0;i<str.length;i++){var currentChar=str.charAt(i);if(!isNaN(parseInt(currentChar)))ret+=currentChar}if(!bKeepZeros)ret=parseInt(ret);return ret};
formReader.formReaderController.prototype.refreshSubformGrids=function(){var gridScope;var grids=$(this.$element_).find("[data-app-subform-grid]");setTimeout(function(){for(var i=0;i<grids.length;i++){gridScope=angular.element(grids[i]).scope();if(goog.isDefAndNotNull(gridScope))if(goog.isDefAndNotNull(gridScope["gridApi"]))if(goog.isDefAndNotNull(gridScope["gridApi"]["core"]))if(goog.isDefAndNotNull(gridScope["gridApi"]["core"]["handleWindowResize"]))gridScope["gridApi"]["core"]["handleWindowResize"]()}})};goog.provide("formReader.directive.formReaderDirective");goog.require("nsVitisComponent.MapWorkbench");goog.require("formReader");
formReader.formReaderDirective=function($q,formReaderService,propertiesSrvc,$log,$compile){return{restrict:"A",scope:{"oProperties":"=?appProperties","oFormValues":"=?appFormValues","oFormDefinition":"=?appFormDefinition","sFormDefinitionName":"=?appFormDefinitionName","oFormEventsContainer":"=?appFormEventsContainer","wabState":"=?appWabState","wabGroup":"=?appWabGroup","showTabs":"=?appTabs"},controller:"AppFormReaderController",controllerAs:"ctrl",templateUrl:window.location.protocol+"//"+window.location.hostname+
(window.location.port?":"+window.location.port:"")+"/"+sessionStorage["appEnv"]+"/javascript/externs/formReader/formReader.html",link:function(scope,element,attrs){$log.log("formReader.formReaderDirective.link");scope["showTabs"]=scope["showTabs"]==="false"||scope["showTabs"]===false?scope["showTabs"]=false:scope["showTabs"]=true;scope["wabState"]=goog.isDefAndNotNull(scope["wabState"])&&scope["wabState"]!==""?scope["wabState"]:null;scope["wabGroup"]=goog.isDefAndNotNull(scope["wabGroup"])&&scope["wabGroup"]!==
""?scope["wabGroup"]:null;scope["submitButton"]=false;scope["oFormEventsContainer"]=goog.isDef(scope["oFormEventsContainer"])?scope["oFormEventsContainer"]:scope;formReaderService["oProperties"]=scope["oProperties"];formReaderService["oFormValues"]=scope["oFormValues"];formReaderService["oFormDefinition"]=scope["oFormDefinition"];formReaderService["sFormDefinitionName"]=scope["sFormDefinitionName"];formReaderService["oFormEventsContainer"]=scope["oFormEventsContainer"];var clearListener=scope.$root.$on("formDefinitionLoaded",
function(event,sFormDefinitionName){clearListener();if(goog.isDefAndNotNull(scope["oFormDefinition"]))if(goog.isDefAndNotNull(scope["oFormDefinition"][sFormDefinitionName]))if(goog.isDefAndNotNull(scope["oFormDefinition"][sFormDefinitionName]["wab"])){scope["showTabs"]=false;scope["wabState"]=scope["oFormValues"][sFormDefinitionName]["status_name"];scope["userGroups"]=[];ajaxRequest({"method":"GET","url":propertiesSrvc["web_server_name"]+"/"+propertiesSrvc["services_alias"]+"/vitis/users/"+sessionStorage["user_id"],
"scope":scope,"headers":{"Accept":"application/x-vm-json"},"success":function(response){scope["userGroups"]=response.data["data"][0]["groups_label"].split(",");for(var group in scope["oFormDefinition"][sFormDefinitionName]["wab"][scope["wabState"]])if(scope["userGroups"].indexOf(group)>-1){scope["wabGroup"]=group;break}if(!goog.isDefAndNotNull(scope["wabGroup"]))console.warn("this user can't see this form");scope.$root.$emit("wabGroupLoaded",scope["wabGroup"])}});if(!goog.isDefAndNotNull(scope["wabGroup"]))console.warn("this user can't see this form")}});
scope["isFormTextElement"]=function(sFormElementType){var aFormText=new Array("text","password","datetime","datetime-local","date","month","time","week","integer","float","number","email","url","search","tel","color");if(aFormText.indexOf(sFormElementType)!==-1)return true;else return false};scope["sendForm"]=function(){$log.log("scope.sendForm");var sFormName=scope["oFormDefinition"][scope["sFormDefinitionName"]]["name"];if(scope[sFormName]["$valid"]===true){var deferred=$q.defer();var promise=deferred.promise;
var beforeEvent=scope["oFormDefinition"][scope["sFormDefinitionName"]]["beforeEvent"];if(typeof beforeEvent!=="undefined")if(goog.isString(beforeEvent))$q.when(formReaderService["callFunction"](beforeEvent)).then(function(){deferred.resolve()});else{if(goog.isFunction(beforeEvent))$q.when(beforeEvent(scope["oFormValues"])).then(function(){deferred.resolve()})}else deferred.resolve();promise.then(function(){deferred=$q.defer();promise=deferred.promise;var submitEvent=scope["oFormDefinition"][scope["sFormDefinitionName"]]["event"];
if(typeof submitEvent!=="undefined")if(goog.isString(submitEvent))$q.when(formReaderService["callFunction"](submitEvent)).then(function(){deferred.resolve()});else{if(goog.isFunction(submitEvent))$q.when(submitEvent(scope["oFormValues"])).then(function(){deferred.resolve()})}else deferred.resolve();promise.then(function(){var afterEvent=scope["oFormDefinition"][scope["sFormDefinitionName"]]["afterEvent"];if(typeof afterEvent!=="undefined")if(goog.isString(afterEvent))formReaderService["callFunction"](afterEvent);
else if(goog.isFunction(afterEvent))afterEvent(scope["oFormValues"])})})}};scope["testElementsValidityTab"]=function(callback){$log.log("scope.testElementsValidityTab");var sFormName=scope["oFormDefinition"][scope["sFormDefinitionName"]]["name"];if(!scope[sFormName]["$valid"]===true){var aElems=formReaderService["getAllFormElementDefinition"](scope["sFormDefinitionName"],scope["oFormDefinition"]);var aInvalidElems=[];for(var i=0;i<aElems.length;i++)if(goog.isDefAndNotNull(aElems[i]["name"]))if(goog.isDefAndNotNull(scope[sFormName][aElems[i]["name"]]))if(!scope[sFormName][aElems[i]["name"]]["$valid"])aInvalidElems.push(aElems[i]["name"]);
if(goog.isDefAndNotNull(aInvalidElems[0]))if(goog.isDefAndNotNull(scope["oFormDefinition"][scope["sFormDefinitionName"]]["tabs"]))if(goog.isDefAndNotNull(scope["oFormDefinition"][scope["sFormDefinitionName"]]["tabs"]["list"])){var aTabs=scope["oFormDefinition"][scope["sFormDefinitionName"]]["tabs"]["list"];for(var i=0;i<aTabs.length;i++)if(aTabs[i]["elements"].indexOf(aInvalidElems[0])!==-1){scope["iDisplayedTab"]=i;break}}}if(goog.isDefAndNotNull(callback))callback.call()};scope["executeButtonEvent"]=
function($event,buttonEvent){$log.log("scope.executeButtonEvent");if(goog.isString(buttonEvent))formReaderService["callFunction"](buttonEvent);else if(goog.isFunction(buttonEvent))buttonEvent(scope["oFormValues"])};scope["getValidationCssClass"]=function(sFieldName){if(typeof sFieldName!="undefined"){var sFormName=scope["oFormDefinition"][scope["sFormDefinitionName"]]["name"];if(typeof scope[sFormName]!="undefined")if(typeof scope[sFormName][sFieldName]!="undefined")if(scope[sFormName][sFieldName].$invalid&&
scope[sFormName][sFieldName].$dirty)return"has-error"}};scope["switchSelectedOptions"]=function(sFormDefinitionName,oFieldDefinition,sFromSelectName,sToSelectName){$log.log("scope.switchSelectedOptions");var oFromSelect=scope["oFormValues"][sFormDefinitionName][sFromSelectName];scope["oFromSelect"]=oFromSelect;if(typeof oFieldDefinition["switch_event"]!=="undefined")if(formReaderService["isFunctionCall"](oFieldDefinition["switch_event"]))if(goog.isString(oFieldDefinition["switch_event"]))formReaderService["callFunction"](oFieldDefinition["switch_event"]);
else if(goog.isFunction(oFieldDefinition["switch_event"]))oFieldDefinition["switch_event"](scope["oFormValues"]);if(oFromSelect["selectedOption"].length>0){var oToSelect=scope["oFormValues"][sFormDefinitionName][sToSelectName];var i=0;while(i<oFromSelect["selectedOption"].length){if(oFromSelect["selectedOption"][i]["disabled"]!=true)oToSelect["options"].unshift(oFromSelect["options"].splice(oFromSelect["options"].indexOf(oFromSelect["selectedOption"][i]),1)[0]);i++}oFromSelect["selectedOption"]=[]}};
scope["reloadSelectField"]=function(oParentSelect,sFormDefinitionName){formReaderService["reloadSelectField"](oParentSelect,sFormDefinitionName,scope["oFormValues"],scope["oFormDefinition"])};scope["isStringNotEmpty"]=function(element){if(!goog.isDefAndNotNull(element))return false;if(!goog.isString(element))return false;if(!element.length>0)return false;return true};scope["getLinkFileName"]=function(url){if(!goog.isString(url))return"";var sName=url;if(sName.lastIndexOf("/")!==-1)sName=sName.substr(sName.lastIndexOf("/")+
1);if(sName.lastIndexOf("?")!==-1)sName=sName.substr(0,sName.lastIndexOf("?"));return sName};scope["isFieldPresent"]=function(oField,oTab,bCheckButtons){bCheckButtons=goog.isDefAndNotNull(bCheckButtons)?bCheckButtons:false;var isVisible=true;if(oField["visible"]===false||oField["visible"]==="false")isVisible=false;var isOnTab=false;if(oTab["elements"].indexOf(oField["name"])!==-1)isOnTab=true;if(oField["visibleAllTabs"]===true)isOnTab=true;if(goog.isDefAndNotNull(oField["buttons"])&&bCheckButtons===
false)isOnTab=true;if(!scope["showTabs"])isOnTab=true;if(this["useWab"]()){var isOnWab=false;var wabValue=this["getWabField"](oField);if(wabValue==="r"||wabValue==="rw")isOnWab=true;if(goog.isDefAndNotNull(oField["buttons"]))isOnWab=true;if(wabValue==="r")oField["disabled"]=true}if(goog.isDefAndNotNull(isOnWab))if(isVisible&&isOnTab&&isOnWab)return true;else return false;else if(isVisible&&isOnTab)return true;else return false};scope["isButtonPresent"]=function(oButton,oField,oTab){var isVisible=
true;if(oButton["visible"]===false||oButton["visible"]==="false")isVisible=false;var isOnTab=false;if(oTab["elements"].indexOf(oButton["name"])!==-1)isOnTab=true;if(oButton["visibleAllTabs"]===true)isOnTab=true;if(this["isFieldPresent"](oField,oTab,true))isOnTab=true;if(this["useWab"]()){var isOnWab=false;var wabValue="";if(this["isFieldPresent"](oField,oTab,true))wabValue=this["getWabField"](oField);else wabValue=this["getWabField"](oButton);if(wabValue==="r"||wabValue==="rw")isOnWab=true;if(wabValue===
"r")oButton["disabled"]=true;if(wabValue=="")oField["visible"]=false}if(goog.isDefAndNotNull(isOnWab))if(isVisible&&isOnTab&&isOnWab)return true;else return false;else if(isVisible&&isOnTab)return true;else return false};scope["getWabField"]=function(oField){if(goog.isDefAndNotNull(scope["wabState"])&&goog.isDefAndNotNull(scope["wabGroup"]))if(goog.isDefAndNotNull(scope["oFormDefinition"]))if(goog.isDefAndNotNull(scope["oFormDefinition"][scope["sFormDefinitionName"]]))if(goog.isDefAndNotNull(scope["oFormDefinition"][scope["sFormDefinitionName"]]["wab"]))if(goog.isDefAndNotNull(scope["oFormDefinition"][scope["sFormDefinitionName"]]["wab"][scope["wabState"]]))if(goog.isDefAndNotNull(scope["oFormDefinition"][scope["sFormDefinitionName"]]["wab"][scope["wabState"]][scope["wabGroup"]])){var oWab=
scope["oFormDefinition"][scope["sFormDefinitionName"]]["wab"][scope["wabState"]][scope["wabGroup"]];if(goog.isDefAndNotNull(oWab[oField["name"]]))return oWab[oField["name"]]}return null};scope["useWab"]=function(){var useWab=false;if(goog.isDefAndNotNull(scope["wabState"])&&goog.isDefAndNotNull(scope["wabGroup"]))if(goog.isDefAndNotNull(scope["oFormDefinition"]))if(goog.isDefAndNotNull(scope["oFormDefinition"][scope["sFormDefinitionName"]]))if(goog.isDefAndNotNull(scope["oFormDefinition"][scope["sFormDefinitionName"]]["wab"]))useWab=
true;return useWab};scope["compileTemplate"]=function(){ajaxRequest({"method":"GET","url":propertiesSrvc["web_server_name"]+"/"+sessionStorage["appEnv"]+"/javascript/externs/formReader/formReader.html","scope":scope,"success":function(response){if(!goog.isDefAndNotNull(response["data"])){console.error("template not founded");return 0}var sTemplate=response["data"];var compiledTemplate=$compile(sTemplate)(scope);element.children().replaceWith(compiledTemplate)}})};scope["resetFileInputs"]=function(){$(element).find(".file").each(function(){$(this)["fileinput"]("clear")})};
scope.$on("$destroy",function(){scope.$root["clearFormData"](scope["sFormDefinitionName"],scope)});scope.$on("loadForm",function(){scope["resetFileInputs"]()})}}};formReader.module.directive("appFormReader",formReader.formReaderDirective);
formReader.appFormFieldSpecificParamsDrtv=function($timeout,$translate,propertiesSrvc,formReaderService,$log,$q){return{link:function(scope,element,attrs){$log.log("formReader.appFormFieldSpecificParamsDrtv.link");if(typeof scope["field"]["attributes"]!=="undefined"){var i=0;var aKeys=Object.keys(scope["field"]["attributes"]);while(i<aKeys.length){element[0]["setAttribute"](aKeys[i],scope["field"]["attributes"][aKeys[i]]);i++}}if(scope["field"]["autofocus"]===true)element[0].focus();switch(scope["field"]["type"]){case "captcha":$timeout(function(){var test=
grecaptcha["render"](scope["field"]["id"],{"sitekey":scope["field"]["key"],"callback":function(response){scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]=response}})},10);break;case "date":case "datetime":var oOptions={"useCurrent":false};var oLocaleOptions={"date":{"fr":{"locale":"fr","format":"DD/MM/YYYY"},"en":{"format":"MM/DD/YYYY"}},"datetime":{"fr":{"locale":"fr","format":"DD/MM/YYYY HH:mm"},"en":{"format":"MM/DD/YYYY HH:mm"}}};goog.object.extend(oOptions,oLocaleOptions[scope["field"]["type"]][propertiesSrvc["language"]]);
if(typeof scope["field"]["options"]!=="undefined")goog.object.extend(oOptions,scope["field"]["options"]);$(element)["datetimepicker"](oOptions);$(element).on("dp.change",function(e){scope["oFormValues"][scope["sFormDefinitionName"]][element[0].name]=element[0].value});break;case "checkbox":if(typeof scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]=="undefined")if(typeof scope["field"]["default_value"]!="undefined")scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]=
scope["field"]["default_value"];else scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]=false;break;case "upload":element[0].addEventListener("change",function(){var oFileList={"aFiles":this.files};scope["oFormValues"][scope["sFormDefinitionName"]][element[0].name]=oFileList},false);var oOptions={"showPreview":false,"showRemove":true,"showUpload":false};if(typeof scope["field"]["options"]!=="undefined")goog.object.extend(oOptions,scope["field"]["options"]);oOptions["mainClass"]=
"input-file-"+scope["oFormDefinition"][scope["sFormDefinitionName"]]["input_size"];if(propertiesSrvc["language"]!="en")oOptions["language"]=propertiesSrvc["language"];$(element)["fileinput"](oOptions);break;case "file_wsdata":element[0].addEventListener("change",function(){var oFileList={"aFiles":this.files};scope["oFormValues"][scope["sFormDefinitionName"]][element[0].name]=oFileList},false);if(goog.isDefAndNotNull(scope["field"]["extensions"])){var aFilesExtensions=scope["field"]["extensions"].split("|");
for(var iFileExtensionIndex in aFilesExtensions)aFilesExtensions[iFileExtensionIndex]="."+aFilesExtensions[iFileExtensionIndex];element[0].setAttribute("accept",aFilesExtensions.join(","))}var oOptions={"showPreview":false,"showRemove":false,"showUpload":false};if(typeof scope["field"]["options"]!=="undefined")goog.object.extend(oOptions,scope["field"]["options"]);oOptions["mainClass"]="input-file-"+scope["oFormDefinition"][scope["sFormDefinitionName"]]["input_size"];if(propertiesSrvc["language"]!=
"en")oOptions["language"]=propertiesSrvc["language"];$(element)["fileinput"](oOptions);break;case "image_wsdata":if(!goog.isDefAndNotNull(scope["field"]["display_width"]))scope["field"]["display_width"]="100%";element[0].addEventListener("change",function(){var oFileList={"aFiles":this.files};if(goog.isDefAndNotNull(scope["field"]["width"])&&goog.isDefAndNotNull(scope["field"]["height"])){oFileList["width"]=scope["field"]["width"];oFileList["height"]=scope["field"]["height"]}scope["oFormValues"][scope["sFormDefinitionName"]][element[0].name]=
oFileList},false);var oOptions={"showPreview":false,"showRemove":false,"showUpload":false,"allowedFileTypes":["image"]};oOptions["mainClass"]="input-file-"+scope["oFormDefinition"][scope["sFormDefinitionName"]]["input_size"];if(propertiesSrvc["language"]!="en")oOptions["language"]=propertiesSrvc["language"];$(element)["fileinput"](oOptions);break;case "email":scope["field"]["pattern"]="^(([a-zA-Z]|[0-9])|([-]|[_]|[.]))+[@](([a-zA-Z]|[0-9])|([-]|[_]|[.])){2,63}[.](([a-zA-Z0-9]){2,63})+$";var pattern=
angular.copy(scope["field"]["pattern"]);scope.$watch("oFormValues."+scope["sFormDefinitionName"]+'["'+scope["field"]["name"]+'"]',function(){scope["field"]["pattern"]=angular.copy(pattern);$timeout(function(){if(element[0]["className"].indexOf("ng-invalid-pattern")!==-1){var advice;if(scope["oProperties"]["language"]==="fr")advice="ceci n'est pas une adresse mail";else advice="this is not a mail adress";$(element).notify(advice,{"position":"top","className":"error","autoHide":false,"clickToHide":false})}else{var tabChild=
element[0]["parentNode"]["children"];var elToDelete=-1;for(var i=0;i<tabChild.length;i++)if(tabChild[i]["className"]==="notifyjs-wrapper")elToDelete=i;if(elToDelete>-1)$(tabChild[elToDelete]).remove()}},1)});break;case "url":scope["field"]["pattern"]="^https?:\\/\\/.{1,}";var pattern=angular.copy(scope["field"]["pattern"]);scope.$watch("oFormValues."+scope["sFormDefinitionName"]+'["'+scope["field"]["name"]+'"]',function(){scope["field"]["pattern"]=angular.copy(pattern);$timeout(function(){if(element[0]["className"].indexOf("ng-invalid-pattern")!==
-1){var advice;if(scope["oProperties"]["language"]==="fr")advice="ce champ doit contenir une url qui commence\n par http:// ou https://";else advice="this field must contain an url that begin\n by http:// or https://";$(element).notify(advice,{"position":"top","className":"error","autoHide":false,"clickToHide":false})}else{var tabChild=element[0]["parentNode"]["children"];var elToDelete=-1;for(var i=0;i<tabChild.length;i++)if(tabChild[i]["className"]==="notifyjs-wrapper")elToDelete=i;if(elToDelete>
-1)$(tabChild[elToDelete]).remove()}},1)});break;case "integer":if(typeof scope["field"]["min"]!=="undefined")element[0].setAttribute("min",scope["field"]["min"]);if(typeof scope["field"]["max"]!=="undefined")element[0].setAttribute("max",scope["field"]["max"]);if(typeof scope["field"]["max_length"]!=="undefined")element[0].setAttribute("maxLength",scope["field"]["max_length"]);scope["$parent"]["valid"]=true;scope["numberUpdate"]=function(){var val=scope["oFormValues"][scope["sFormDefinitionName"]][element[0].name];
if(goog.isDef(val)&&(typeof val==="string"||typeof val==="number"))if(typeof val==="string"){var tmp=scope["ctrl"]["numberParser"](val,true);if(!isNaN(tmp))scope["oFormValues"][scope["sFormDefinitionName"]][element[0].name]=tmp;else scope["oFormValues"][scope["sFormDefinitionName"]][element[0].name]=""}else scope["oFormValues"][scope["sFormDefinitionName"]][element[0].name]=val;else console.error("bad type argument")};$timeout(function(){scope["oFormValues"][scope["sFormDefinitionName"]][element[0].name]+=
" ";scope["numberUpdate"]()},500);break;case "float":case "number":if(typeof scope["field"]["min"]!=="undefined")element[0].setAttribute("min",scope["field"]["min"]);if(typeof scope["field"]["max"]!=="undefined")element[0].setAttribute("max",scope["field"]["max"]);if(typeof scope["field"]["max_length"]!=="undefined")element[0].setAttribute("maxLength",scope["field"]["max_length"]);scope["$parent"]["valid"]=true;scope["numberUpdate"]=function(){var val=scope["oFormValues"][scope["sFormDefinitionName"]][element[0].name];
if(goog.isDef(val)&&(typeof val==="string"||typeof val==="number"))if(typeof val==="string"){var tmp=scope["ctrl"]["numberParser"](val,false);if(!isNaN(tmp)||typeof tmp==="string")scope["oFormValues"][scope["sFormDefinitionName"]][element[0].name]=tmp;else scope["oFormValues"][scope["sFormDefinitionName"]][element[0].name]=""}else scope["oFormValues"][scope["sFormDefinitionName"]][element[0].name]=val;else console.error("bad type argument")};$timeout(function(){scope["oFormValues"][scope["sFormDefinitionName"]][element[0].name]+=
" ";scope["numberUpdate"]()},500);break;case "image_wsdata":if(goog.isDefAndNotNull(scope["field"])){if(goog.isDefAndNotNull(scope["field"]["width"]))if(scope["field"]["width"]==0||scope["field"]["width"]=="0px")scope["field"]["width"]=null;if(goog.isDefAndNotNull(scope["field"]["style"]))if(goog.isDefAndNotNull(scope["field"]["style"]["height"]))if(scope["field"]["style"]["height"]==0||scope["field"]["style"]["height"]=="0px")scope["field"]["style"]["height"]=null}break;case "image":if(goog.isDefAndNotNull(scope["field"])){if(goog.isDefAndNotNull(scope["field"]["width"]))if(scope["field"]["width"]==
0||scope["field"]["width"]=="0px")scope["field"]["width"]=null;if(goog.isDefAndNotNull(scope["field"]["style"]))if(goog.isDefAndNotNull(scope["field"]["style"]["height"]))if(scope["field"]["style"]["height"]==0||scope["field"]["style"]["height"]=="0px")scope["field"]["style"]["height"]=null}var options={"inline":false,"button":true,"navbar":false,"title":2,"toolbar":2,"tooltip":true,"fullscreen":false,"url":function(){return scope["oProperties"]["web_server_name"]+"/"+scope["oProperties"][scope["field"]["alias"]]+
"/"+scope["field"]["folder"]+"/"+scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]}};scope["viewer"]=new Viewer(element[0],options);scope["openViewer"]=function(){$log.log("openViewer");scope["viewer"].show();angular.element(".viewer-prev").remove();angular.element(".viewer-next").remove()};break;case "imageurl":if(goog.isDefAndNotNull(scope["field"])){if(goog.isDefAndNotNull(scope["field"]["width"]))if(scope["field"]["width"]==0||scope["field"]["width"]=="0px")scope["field"]["width"]=
null;if(goog.isDefAndNotNull(scope["field"]["style"]))if(goog.isDefAndNotNull(scope["field"]["style"]["height"]))if(scope["field"]["style"]["height"]==0||scope["field"]["style"]["height"]=="0px")scope["field"]["style"]["height"]=null}var options={"inline":false,"button":true,"navbar":false,"title":2,"toolbar":2,"tooltip":true,"fullscreen":false,"url":function(){return scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]}};scope["viewer"]=new Viewer(element[0],options);scope["openViewer"]=
function(){$log.log("openViewer");scope["viewer"].show();angular.element(".viewer-prev").remove();angular.element(".viewer-next").remove()};break;case "select":case "editable_select":var oField=scope["field"];var fieldValue=scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]];if(typeof fieldValue=="string"&&!isNaN(fieldValue))if(fieldValue.length==1||fieldValue.search(/^[1-9][0-9]+$/)!=-1)scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]=Number(fieldValue);
if(typeof oField["multiple"]!=="undefined"&&oField["multiple"]===true)element[0].setAttribute("multiple","");if(typeof oField["size"]!=="undefined"){element[0].setAttribute("size",oField["size"]);element[0].style.height="auto"}if(goog.isString(oField["options"])){var tmp=oField["options"].split(",");var tmp2;for(var i=0;i<tmp.length;i++){tmp2=tmp[i].split("|");tmp[i]={"label":tmp2[0],"value":tmp2[1]}}scope["oFormValues"][scope["sFormDefinitionName"]][oField["name"]]["options"]=tmp}if(typeof scope["field"]["child_select"]!=
"undefined")element[0].addEventListener("change",function(){scope["reloadSelectField"](scope["field"],scope["sFormDefinitionName"])},false);if(goog.isDefAndNotNull(oField["onchange"]))element[0].addEventListener("change",function(){if(formReaderService["isFunctionCall"](oField["onchange"]))if(goog.isString(oField["onchange"]))formReaderService["callFunction"](oField["onchange"]);else if(goog.isFunction(oField["onchange"]))oField["onchange"](scope["oFormValues"])},false);break;case "map_bing":case "map_osm":case "map_vmap":var initMap=
function(){if(goog.isDef(scope["oMap"])){scope["oMap"].MapObject.setTarget(null);delete scope["oMap"]}scope["oMap"]=new nsVitisComponent.Map({"target":element[0],"options":scope["field"]["map_options"],"hiddenFieldId":scope["field"]["id"],"oFormValues":scope["oFormValues"][scope["sFormDefinitionName"]],"sFormName":scope["field"]["name"],"oProj":scope.$root["proj"]});if(typeof scope["field"]["style"]!="undefined")if(typeof scope["field"]["style"]["height"]!="undefined"&&scope["field"]["style"]["height"]==
"ratio"){var ratio=window.innerWidth/window.innerHeight;scope["field"]["style"]["height"]=parseInt(element[0].clientWidth/ratio)+"px"}scope.$root.$emit("OpenLayersMapCreated",scope["oMap"]);scope["oMap"].on("moveend",function(){scope["field"]["map_options"]["center"]=scope["oMap"]["getConfig"]();scope.$apply()},scope["oMap"])};setTimeout(function(){initMap();scope.$watch("field.nb_cols",function(value,old){$timeout(function(){scope["oMap"].MapObject.updateSize()})});scope.$watch("field.style",function(value,
old){$timeout(function(){scope["oMap"].MapObject.updateSize()})},true);scope.$watch("oMap.bLayersTreeOpen",function(value,old){$timeout(function(){scope["oMap"].MapObject.updateSize()})},true);scope.$on("studio resized",function(){scope["oMap"].MapObject.updateSize()});scope.$on("updateMap",function(event,data){switch(data){case "center":scope["oMap"]["setCenter"]([scope["field"]["map_options"]["center"]["coord"][0],scope["field"]["map_options"]["center"]["coord"][1]]);break;case "zoom":scope["oMap"]["setZoom"](scope["field"]["map_options"]["center"]["zoom"]);
break;case "source":scope["oMap"]["setBingSource"](scope["field"]["map_options"]["source"]);break;case "extent":scope["oMap"]["setExtent"](scope["field"]["map_options"]["center"]["extent"]);break;case "controls":scope["oMap"]["setControls"](scope["field"]["map_options"]["controls"]);break;case "interact":scope["oMap"]["setInteractions"](scope["field"]["map_options"]["interactions"]);break;case "proj":var extent=scope["oMap"]["getExtent"]();var center=scope["oMap"]["getCenter"]();var proj=scope["oMap"]["getProj"]();
scope["field"]["map_options"]["center"]["extent"]=scope["oMap"]["transformExtent"](extent,proj,scope["field"]["map_options"]["proj"]);scope["field"]["map_options"]["center"]["coord"]=scope["oMap"]["transformer"](center,proj,scope["field"]["map_options"]["proj"]);initMap();break;default:initMap();break}})});break;case "slider":scope["field"]["options"]["id"]=scope["field"]["id"]+"_slider";var mySlider=$(element)["slider"](scope["field"]["options"]);if(!goog.isDefAndNotNull(scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]))scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]=
0;$(element).on("slide",function(){scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]=$(element)["slider"]("getValue")});scope.$watch("oFormValues."+scope["sFormDefinitionName"]+'["'+scope["field"]["name"]+'"]',function(){setTimeout(function(){if(goog.isDefAndNotNull($(element)))if(goog.isDefAndNotNull(scope["oFormValues"]))if(goog.isDefAndNotNull(scope["oFormValues"][scope["sFormDefinitionName"]]))if(goog.isDefAndNotNull(scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]))$(element)["slider"]("setValue",
parseFloat(scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]))},10)});scope.$watch("field.options",function(){setTimeout(function(){mySlider=$(element)["slider"](scope["field"]["options"])},10)},true);break;case "color_picker":$(element)["colorpicker"]({format:"rgba"});$(element).on("changeColor",function(){scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]=$(element)["colorpicker"]("getValue")});scope.$watch("oFormValues."+scope["sFormDefinitionName"]+
'["'+scope["field"]["name"]+'"]',function(){setTimeout(function(){if(goog.isDefAndNotNull($(element)))if(goog.isDefAndNotNull(scope["oFormValues"]))if(goog.isDefAndNotNull(scope["oFormValues"][scope["sFormDefinitionName"]]))if(goog.isDefAndNotNull(scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]))$(element)["colorpicker"]("setValue",scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]])},10)});break;case "double_select":var ilineHeight=parseInt($(element).css("line-height"))-
1;if(typeof scope["field"]["size"]!=="undefined")element[0].style.minHeight=ilineHeight*scope["field"]["size"]+"px";break;case "password":if(typeof scope["field"]["autocomplete"]==="undefined"||scope["field"]["autocomplete"]===false){element[0].readOnly=true;if(document.getElementById("FormBuilder")===null)var clearListener=scope.$root.$on("endFormNgRepeat",function(event){$timeout(function(){element[0].readOnly=false},300);clearListener()});else $timeout(function(){element[0].readOnly=false},300)}break;
case "text":if(typeof scope["field"]["max_length"]!=="undefined")element[0].setAttribute("maxLength",scope["field"]["max_length"]);break;case "treeview":var oTreeviewOptions=angular.copy(scope["field"]["options"]);if(goog.isDefAndNotNull(oTreeviewOptions["dataLoadingEvent"])&&oTreeviewOptions["dataLoadingEvent"]!=""){scope.$root["waitForTreeviewDataLoaded"]=function(){var deferred=$q.defer();var clearListener=scope.$root.$on(oTreeviewOptions["dataLoadingEvent"],function(event,aNodes){clearListener();
deferred.resolve(aNodes)});return deferred.promise};if(goog.isDefAndNotNull(oTreeviewOptions["data"])&&oTreeviewOptions["data"]!=""&&formReaderService["isFunctionCall"](oTreeviewOptions["data"]))formReaderService["callFunction"](oTreeviewOptions["data"]);oTreeviewOptions["data"]="waitForTreeviewDataLoaded()"}else if(!formReaderService["isFunctionCall"](oTreeviewOptions["data"])){scope.$root["getTreeviewData"]=function(){var deferred=$q.defer();deferred.resolve(scope["field"]["options"]["data"]);return deferred.promise};
oTreeviewOptions["data"]="getTreeviewData()"}if(goog.isDefAndNotNull(oTreeviewOptions["data"])&&oTreeviewOptions["data"]!="")formReaderService["callFunction"](oTreeviewOptions["data"]).then(function(aNodes){oTreeviewOptions["data"]=aNodes;if(typeof oTreeviewOptions["showCheckbox"]!="undefined"&&oTreeviewOptions["showCheckbox"]===true){this["setTreeviewNodesState"]=function(oNode){for(var i in oNode)if(typeof oNode[i]["nodes"]!="undefined")this["setTreeviewNodesState"](oNode[i]["nodes"]);else{if(typeof oNode[i]["state"]==
"undefined")oNode[i]["state"]={};var aCheckedItem=[];var sValue=scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]];if(typeof sValue=="string"&&sValue!="")aCheckedItem=sValue.split("|");if(aCheckedItem.indexOf(String(oNode[i]["value"]))!=-1)oNode[i]["state"]["checked"]=true}};this["setTreeviewNodesState"](oTreeviewOptions["data"]);oTreeviewOptions["onNodeChecked"]=function(event,data){if(typeof data["nodes"]!="undefined")for(var i in data["nodes"])$(element)["treeview"]("checkNode",
data["nodes"][i]["nodeId"]);else{var aCheckedItem=[];if(typeof data["value"]!="undefined"){var sValue=scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]];if(typeof sValue=="string"&&sValue!="")aCheckedItem=sValue.split("|");aCheckedItem.push(data["value"]);scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]=aCheckedItem.join("|")}}};oTreeviewOptions["onNodeUnchecked"]=function(event,data){if(typeof data["nodes"]!="undefined")for(var i in data["nodes"])$(element)["treeview"]("uncheckNode",
data["nodes"][i]["nodeId"]);else{var aCheckedItem=[];if(typeof data["value"]!="undefined"){var sValue=scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]];if(typeof sValue=="string"&&sValue!="")aCheckedItem=sValue.split("|");aCheckedItem.splice(aCheckedItem.indexOf(data["value"]),1);scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]=aCheckedItem.join("|")}}}}$(element)["treeview"](oTreeviewOptions)});break;case "foldermanager":var oTreeviewOptions=angular.copy(scope["field"]["options"]);
oTreeviewOptions["data"]=[];if(typeof oTreeviewOptions["showCheckbox"]!="undefined"&&oTreeviewOptions["showCheckbox"]===true){this["setTreeviewNodesState"]=function(oNode){for(var i in oNode)if(typeof oNode[i]["nodes"]!="undefined")this["setTreeviewNodesState"](oNode[i]["nodes"]);else{if(typeof oNode[i]["state"]=="undefined")oNode[i]["state"]={};var aCheckedItem=[];var sValue=scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]];if(typeof sValue=="string"&&sValue!="")aCheckedItem=
sValue.split("|");if(aCheckedItem.indexOf(String(oNode[i]["value"]))!=-1)oNode[i]["state"]["checked"]=true}};this["setTreeviewNodesState"](oTreeviewOptions["data"]);if(!goog.isDefAndNotNull(oTreeviewOptions["recursiveCheck"]))oTreeviewOptions["recursiveCheck"]=true;oTreeviewOptions["onNodeChecked"]=function(event,data){if(typeof data["nodes"]!="undefined"&&oTreeviewOptions["recursiveCheck"])for(var i in data["nodes"])$(element)["treeview"]("checkNode",data["nodes"][i]["nodeId"]);else{var aCheckedItem=
[];if(typeof data["value"]!="undefined"){var sValue=scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]];if(typeof sValue=="string"&&sValue!="")aCheckedItem=sValue.split("|");aCheckedItem.push(data["value"]);scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]=aCheckedItem.join("|")}}};oTreeviewOptions["onNodeUnchecked"]=function(event,data){console.log(data);if(typeof data["nodes"]!="undefined"&&oTreeviewOptions["recursiveCheck"])for(var i in data["nodes"])$(element)["treeview"]("uncheckNode",
data["nodes"][i]["nodeId"]);else{var aCheckedItem=[];if(typeof data["value"]!="undefined"){var sValue=scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]];if(typeof sValue=="string"&&sValue!="")aCheckedItem=sValue.split("|");aCheckedItem.splice(aCheckedItem.indexOf(data["value"]),1);scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]=aCheckedItem.join("|")}}}}$(element)["treeview"](oTreeviewOptions);var destroyer=scope.$on("update_data_treeview_"+scope["field"]["id"],
function(event,data){if(goog.isDefAndNotNull(data)){oTreeviewOptions["data"]=data;$(element)["treeview"](oTreeviewOptions)}});scope.$on("$destroy",function(){destroyer()});if(goog.isDefAndNotNull(scope["field"]["loadDataFunction"]))formReaderService["callFunction"](scope["field"]["loadDataFunction"]);break}if(typeof scope["field"]["read_only"]!="undefined"&&scope["field"]["read_only"]==true)element[0].readOnly=true}}};formReader.module.directive("appFormFieldSpecificParams",formReader.appFormFieldSpecificParamsDrtv);
formReader.appFormRowNgRepeatDrtv=function($timeout,$rootScope,envSrvc,$log){return{link:function(scope,element,attrs){$log.log("formReader.appFormRowNgRepeatDrtv.link");if(typeof scope["row"]["tab"]!="undefined"){var bFirstTab=false;var sTabContainerId=scope["sFormDefinitionName"]+"_"+scope["row"]["tab"]["parent"]+"_tab_container";if(document.getElementById(sTabContainerId)==null){var oDiv=document.createElement("div");oDiv.className="tab-content";oDiv.id=sTabContainerId;element[0].parentNode.insertBefore(oDiv,
element[0]);bFirstTab=true}document.getElementById(sTabContainerId).appendChild(element[0]);element[0].id=scope["sFormDefinitionName"]+"_"+scope["row"]["tab"]["name"]+"_tab";element[0].setAttribute("role","tabpanel");$timeout(function(){element[0].className+=" tab-pane fade";if(bFirstTab)element[0].className+=" in active"})}$timeout(function(){if(scope["$last"])$rootScope.$emit("endFormNgRepeat",envSrvc["oSelectedObject"]["name"])})}}};formReader.module.directive("appFormRowNgRepeat",formReader.appFormRowNgRepeatDrtv);
formReader.appFormFieldNgRepeatDrtv=function($translate,$timeout,formReaderService,propertiesSrvc,externFunctionSrvc,$log){return{link:function(scope,element,attrs){if(typeof scope["field"]["default_value"]=="string")if(/^[A-Z0-9_]+$/.test(scope["field"]["default_value"]))$translate([scope["field"]["default_value"]]).then(function(translations){if(scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]==scope["field"]["default_value"])scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]=
translations[scope["field"]["default_value"]]});if(typeof scope["field"]["name"]!="undefined"&&scope["field"]["name"].indexOf(".")!=-1)scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["name"]]=formReaderService["getFormValueFromObject"](scope["oFormValues"][scope["sFormDefinitionName"]],scope["field"]["name"]);if(typeof scope["field"]["visible"]!=="undefined")if(formReaderService["isFunctionCall"](scope["field"]["visible"]))scope["field"]["visible"]=scope.$eval(scope["field"]["visible"]);
if(scope["field"]["type"]==="editable_double_select")var clearListener=scope.$root.$on("webServiceTagsloaded",function(event,oFormElementDefinition){clearListener();if(oFormElementDefinition["webServiceTagsloaded"]!=true){oFormElementDefinition["webServiceTagsloaded"]=true;$timeout(function(){var oOptions={};if(typeof oFormElementDefinition["options"]!=="undefined")oOptions=oFormElementDefinition["options"];$("#"+oFormElementDefinition["id"])["tagsinput"](oOptions);$("#"+oFormElementDefinition["id_available_tags"])["tagsinput"](oOptions);
$("#"+oFormElementDefinition["id"]).on("itemRemoved itemAdded",function(event){if(event["type"]=="itemRemoved"){$("#"+oFormElementDefinition["id_available_tags"])["tagsinput"]("add",event["item"]);scope.$root["setTagsInput"]([oFormElementDefinition["id_available_tags"]])}else scope.$root["setTagsInput"]([oFormElementDefinition["id"]])});$("#"+oFormElementDefinition["id_available_tags"]).on("itemRemoved itemAdded",function(event){if(event["type"]=="itemRemoved"){$("#"+oFormElementDefinition["id"])["tagsinput"]("add",
event["item"]);scope.$root["setTagsInput"]([oFormElementDefinition["id"]])}else scope.$root["setTagsInput"]([oFormElementDefinition["id_available_tags"]])});scope.$root["setTagsInput"]([oFormElementDefinition["id_available_tags"],oFormElementDefinition["id"]])})}});else if(scope["field"]["type"]=="ui_grid"||scope["field"]["type"]=="bo_grid"||scope["field"]["type"]=="section_grid"){if(!goog.isDefAndNotNull(scope["field"]["options"]))scope["field"]["options"]={"enableRowSelection":true,"enableSelectAll":true,
"enablePagination":false,"enablePaginationControls":false,"enableColumnMenus":false,"enableColumnResizing":false,"appHeader":true,"appHeaderTitleBar":true,"columnDefs":[],"data":[]};if(typeof scope["field"]["options"]["appDisableRowSelection"]!="undefined"&&scope["field"]["options"]["appDisableRowSelection"]===true)scope["field"]["options"]["isRowSelectable"]=function(){return false};scope["gridOptions"]=angular.copy(scope["field"]["options"]);var aColumnTitleTranslation=[];var aColumnDefs=angular.copy(scope["gridOptions"]["columnDefs"]);
aColumnDefs.forEach(function(oColumnDef){aColumnTitleTranslation.push(oColumnDef["name"])});$translate(aColumnTitleTranslation).then(function(oTranslations){aColumnTitleTranslation.forEach(function(sTranslation,i){aColumnDefs[i]["name"]=oTranslations[sTranslation];aColumnDefs[i]["displayName"]=oTranslations[sTranslation]});scope["gridOptions"]["columnDefs"]=angular.copy(aColumnDefs)});if(scope["gridOptions"]["appEnableDragAndDrop"]===true)scope["gridOptions"]["rowTemplate"]='<div grid="grid" class="ui-grid-draggable-row" draggable="true"><div ng-repeat="(colRenderIndex, col) in colContainer.renderedColumns track by col.colDef.name" class="ui-grid-cell" ng-class="{ \'ui-grid-row-header-cell\': col.isRowHeader, \'custom\': true }" ui-grid-cell></div></div>';
scope["gridOptions"]["onRegisterApi"]=function(gridApi){scope.$root.$emit("registeredUiGridApi",gridApi);scope["gridApi"]=gridApi;$timeout(function(){externFunctionSrvc["resizeWin"]();gridApi["core"]["handleWindowResize"]()});scope["gridOptions"]["gridApi"]=gridApi;$timeout(function(){if(scope["gridOptions"]["enableRowSelection"])$(gridApi["grid"]["element"]).find(".ui-grid-render-container-body").on("click.selectRow",function(event){var oCell=event.target;if($(oCell).hasClass("ui-grid-cell")||$(oCell).hasClass("ui-grid-cell-contents")){var iRowIndex=
$(element).find(".ui-grid-render-container-body .ui-grid-canvas").children().index($(oCell).parents(".ui-grid-row"));$(element).find(".ui-grid-render-container-left .ui-grid-row").eq(iRowIndex).find(".ui-grid-selection-row-header-buttons").click()}})});if(typeof gridApi["dragndrop"]!=="undefined")if(scope["gridOptions"]["appEnableDragAndDrop"]===true){gridApi["dragndrop"]["setDragDisabled"]=false;gridApi["draggableRows"]["on"]["rowDragged"](scope,function(info,rowElement){});gridApi["draggableRows"]["on"]["rowFinishDrag"](scope,
function(){if(typeof scope["gridOptions"]["appDragAndDropEvent"]!=="undefined"&&typeof scope["gridOptions"]["appDragAndDropEvent"]["rowFinishDrag"]!=="undefined")if(goog.isFunction(scope.$root[scope["gridOptions"]["appDragAndDropEvent"]["rowFinishDrag"]]))scope.$root[scope["gridOptions"]["appDragAndDropEvent"]["rowFinishDrag"]]();else console.error(scope["gridOptions"]["appDragAndDropEvent"]["rowFinishDrag"]+" is not a function of scope.$root")});gridApi["draggableRows"]["on"]["rowEnterRow"](scope,
function(info,rowElement){});gridApi["draggableRows"]["on"]["beforeRowMove"](scope,function(from,to,data){})}else gridApi["dragndrop"]["setDragDisabled"]=true;element[0].querySelector(".ui-grid-render-container-body").style.height="100%";element[0].querySelector(".ui-grid-render-container-body .ui-grid-viewport").style.height="Calc(100% - 30px)"}}else if(scope["field"]["type"]=="codemirror"){if(typeof scope["field"]["codemirrorOptions"]!="undefined")scope["field"]["cm_options"]=scope["field"]["codemirrorOptions"];
if(goog.isDefAndNotNull(scope["field"]["cm_options"]))scope["field"]["cm_options"]["onLoad"]=function(oEditor){if(typeof scope["oCodeMirrorEditor"]=="undefined")scope["oCodeMirrorEditor"]={};scope["oCodeMirrorEditor"][oEditor["options"]["appName"]]=oEditor;oEditor.on("change",function(){if(typeof oEditor["options"]["appMaxHeight"]!="undefined"){var iMaxHeight=oEditor["options"]["appMaxHeight"];var oDoc=oEditor["getDoc"]();var iLines=oDoc["lineCount"]();var iLineHeight=oEditor["defaultTextHeight"]();
var iHeightNeeded=iLines*iLineHeight;if(iMaxHeight.indexOf("%")!=-1)iMaxHeight=parseInt(window.innerHeight*parseInt(iMaxHeight)/100);else if(iMaxHeight.indexOf("l")!=-1)iMaxHeight=parseInt(parseInt(iMaxHeight)*iLineHeight);else if(!isNaN(iMaxHeight))iMaxHeight=parseInt(iMaxHeight);if(iMaxHeight<iHeightNeeded)oEditor["setSize"](null,iMaxHeight)}});if(typeof oEditor["options"]["appHeight"]!="undefined"){var iHeight=oEditor["options"]["appHeight"];var iLineHeight=oEditor["defaultTextHeight"]();if(typeof iHeight==
"string")if(iHeight.indexOf("%")!=-1)iHeight=parseInt(window.innerHeight*parseInt(iHeight)/100);else if(iHeight.indexOf("l")!=-1)iHeight=parseInt(parseInt(iHeight)*iLineHeight);else if(!isNaN(iHeight))iHeight=parseInt(iHeight);if(typeof iHeight=="number")oEditor["setSize"](null,iHeight)}if(typeof scope["field"]["cm_options"]["appHints"]!="undefined")oEditor.on("keyup",function(cm,event){if(event.key==scope["field"]["cm_options"]["appHints"]["key"]){var options={hint:function(){return{"from":oEditor["getDoc"]()["getCursor"](),
"to":oEditor["getDoc"]()["getCursor"](),"list":scope["field"]["cm_options"]["appHints"]["hints"]}}};oEditor["showHint"](options)}})}}$timeout(function(){if(typeof scope["field"]["tooltip"]!=="undefined"&&scope["field"]["visible"]!==false){if(typeof scope["field"]["tooltip"]["trigger"]==="undefined")scope["field"]["tooltip"]["trigger"]="hover";var oTooltipElement=document.createElement("span");oTooltipElement.className="form-field-label-tooltip";var sTooltipElementId=scope["field"]["id"]+"_tooltip";
oTooltipElement.id=sTooltipElementId;if(typeof scope["field"]["tooltip"]["thumbnail"]!="undefined"){var sFileName=scope["oFormValues"][scope["sFormDefinitionName"]][scope["field"]["tooltip"]["thumbnail"]];if(sFileName!=""&&sFileName!=null){var sImagePath=propertiesSrvc["web_server_name"]+"/"+propertiesSrvc["public_alias"]+"/"+propertiesSrvc["application"]+"/"+sFileName;scope["field"]["tooltip"]["html"]=true;scope["field"]["tooltip"]["content"]='<img src="'+sImagePath+'" class="popover-thumbnail-img">';
scope["field"]["tooltip"]["template"]='<div class="popover popover-thumbnail" role="tooltip"><div class="arrow"></div><h3 class="popover-title"></h3><div class="popover-content"></div></div>';element[0].querySelector("label").appendChild(oTooltipElement);$(element).find("label .form-field-label-tooltip")["popover"](scope["field"]["tooltip"])}}else{element[0].querySelector("label").appendChild(oTooltipElement);$translate([scope["field"]["tooltip"]["title"],scope["field"]["tooltip"]["content"]]).then(function(translations){scope["field"]["tooltip"]["title"]=
translations[scope["field"]["tooltip"]["title"]];scope["field"]["tooltip"]["content"]=translations[scope["field"]["tooltip"]["content"]];$(element).find("label .form-field-label-tooltip")["popover"](scope["field"]["tooltip"]).on("inserted.bs.popover",function(){if(typeof scope["field"]["tooltip"]["width"]!=="undefined")element[0].querySelector(".popover").style.width=scope["field"]["tooltip"]["width"]})})}}if(typeof scope["field"]["autocomplete"]!="undefined")if(scope["field"]["autocomplete"])element[0].querySelector("[name='"+
scope["field"]["name"]+"']").setAttribute("autocomplete","on");else element[0].querySelector("[name='"+scope["field"]["name"]+"']").setAttribute("autocomplete","off")});if(scope["field"]["type"]=="tinymce"){if(typeof scope["field"]["tinymceOptions"]=="undefined")scope["field"]["tinymceOptions"]={};if(propertiesSrvc["language"]!="en")scope["field"]["tinymceOptions"]["language"]=propertiesSrvc["language"]+"_"+propertiesSrvc["language"].toUpperCase()}}}};
formReader.module.directive("appFormFieldNgRepeat",formReader.appFormFieldNgRepeatDrtv);formReader.appButtonDrtv=function($translate,$log){return{link:function(scope,element,attrs){$log.log("formReader.appButtonDrtv.link");if(typeof scope["button"]["tooltip"]!=="undefined")$translate([scope["button"]["tooltip"]["title"]]).then(function(translations){scope["button"]["tooltip"]["title"]=translations[scope["button"]["tooltip"]["title"]];$(element).tooltip(scope["button"]["tooltip"])})}}};
formReader.module.directive("appButton",formReader.appButtonDrtv);
formReader.appSubformGridDrtv=function($timeout,$translate,propertiesSrvc,formReaderService,$log){return{link:function(scope,element,attrs){$log.log("formReader.appSubformGridDrtv.link");var oMainScope=angular.element("#formreader_"+scope["sFormUniqueName"]+"_grid_subform_modal").scope();var formContainer=element.closest("form").parent();scope["initBoSubformGrid"]=function(){$log.log("formReader.appSubformGridDrtv.initBoSubformGrid");var sBusinessObject=scope["field"]["bo_id"];var sModalId="formreader_"+
scope["sFormUniqueName"]+"_grid_subform_modal";var oSearchValues={};var oInsertValues={};var sFilterAttr=scope["field"]["bo_filter_attr"];var sFilterValue=scope["field"]["form_filter_value"];var envSrvc=angular.element(vitisApp.appMainDrtv).injector().get(["envSrvc"]);var formSrvc=angular.element(vitisApp.appMainDrtv).injector().get(["formSrvc"]);var sSubformId="formreader_"+scope["sFormUniqueName"]+"_grid_subform";var oSubformScope=angular.element("#"+sSubformId).scope();var bIsIntersected=false;
oMainScope["closeModal"]=function(identifier){$(identifier).modal("hide")};$("#"+sModalId).on("hidden.bs.modal",function(event){setTimeout(function(){envSrvc["oFormValues"]=oMainScope["oFormValues"];envSrvc["oFormDefinition"]=oMainScope["oFormDefinition"];envSrvc["sFormDefinitionName"]=oMainScope["sFormDefinitionName"]})});scope["haveInsertRights"]=false;scope["haveDeleteRights"]=false;scope["haveUpdateRights"]=false;scope["haveCardRights"]=false;scope["oListWebService"]={"dataType":"businessObject",
"ressource_id":"vmap/querys/"+sBusinessObject+"/list","parameters":{"filter":""}};formReaderService["getBusinessObjectDef"](sBusinessObject).then(function(oBusinessObject){if(!goog.isDefAndNotNull(oBusinessObject["business_object_id"])){console.error("error while loading business object ("+sBusinessObject+")");return 0}if(goog.isDefAndNotNull(sFilterAttr)&&sFilterAttr!=="")if(goog.isDefAndNotNull(sFilterValue)&&sFilterValue!=="")if(goog.isDefAndNotNull(oMainScope["oFormValues"]))if(goog.isDefAndNotNull(oMainScope["oFormValues"][oMainScope["sFormDefinitionName"]])){var sFilterValueValue=
oMainScope["oFormValues"][oMainScope["sFormDefinitionName"]][sFilterValue];if(goog.isDefAndNotNull(sFilterValueValue))if(goog.isDefAndNotNull(sFilterValueValue["selectedOption"]))if(goog.isDefAndNotNull(sFilterValueValue["selectedOption"]["value"]))sFilterValueValue=sFilterValueValue["selectedOption"]["value"];if(goog.isDefAndNotNull(sFilterValueValue))if(goog.isDefAndNotNull(sFilterValueValue["selectedOption"]))if(goog.isDefAndNotNull(sFilterValueValue["selectedOption"][0]))if(goog.isDefAndNotNull(sFilterValueValue["selectedOption"][0]["value"]))sFilterValueValue=
sFilterValueValue["selectedOption"][0]["value"];bIsIntersected=true;oSearchValues[sFilterAttr]=sFilterValueValue;oInsertValues[sFilterAttr]=sFilterValueValue}var sFilter=formReaderService["parseFilter"](oSearchValues);scope["oListWebService"]["parameters"]["filter"]=sFilter;scope["oListWebService"]["parameters"]["limit"]=100;if(oBusinessObject["user_rights"].indexOf("INSERT")!==-1)scope["haveInsertRights"]=true;if(oBusinessObject["user_rights"].indexOf("DELETE")!==-1)scope["haveDeleteRights"]=true;
if(oBusinessObject["user_rights"].indexOf("UPDATE")!==-1)if(goog.isDefAndNotNull(oBusinessObject["json_form"]))if(goog.isDefAndNotNull(oBusinessObject["json_form"][0]))if(goog.isDefAndNotNull(oBusinessObject["json_form"][0]["update"]))scope["haveUpdateRights"]=true;if(oBusinessObject["user_rights"].indexOf("SELECT")!==-1)if(goog.isDefAndNotNull(oBusinessObject["json_form"]))if(goog.isDefAndNotNull(oBusinessObject["json_form"][0]))if(goog.isDefAndNotNull(oBusinessObject["json_form"][0]["display"]))scope["haveCardRights"]=
true;var setGridData=function(aResult){var aList=[];for(var i=0;i<aResult.length;i++){aResult[i]["bo_list"]["bo_object_infos"]={"bo_id_value":aResult[i]["bo_id_value"],"bo_id_field":aResult[i]["bo_id_field"],"bo_type":aResult[i]["bo_type"]};aList.push(aResult[i]["bo_list"])}scope["gridOptions"]["data"]=aList};var setGrid=function(){formReaderService["getWebServiceData"](angular.copy(scope["oListWebService"])).then(function(aResult){if(!goog.isDefAndNotNull(aResult))return null;if(goog.isDefAndNotNull(aResult[0])){scope["gridOptions"]["columnDefs"]=
[{"name":"","field":"actions","cellTemplate":"<app-ui-grid-action></app-ui-grid-action>","width":60,"enableSorting":false,"enableColumnMoving":false,"enableColumnResizing":false}];for(var i=0;i<aResult[0]["bo_list_attributs"].length;i++)scope["gridOptions"]["columnDefs"].push({"field":aResult[0]["bo_list_attributs"][i]});setGridData(aResult);if(scope["haveUpdateRights"])scope["gridApi"]["grid"]["appScope"]["edit_column"]="edit";if(scope["haveCardRights"])scope["gridApi"]["grid"]["appScope"]["show_column"]=
"show";scope["gridApi"]["grid"]["appScope"]["executeActionButtonEvent"]=function(oRow,sEvent){if(formContainer.attr("id")==="studio_form_reader"){$translate("NO_IN_STUDIO").then(function(translation){$.notify(translation,"error")});return 0}var oElement=oRow["entity"];var oObject=oElement["bo_object_infos"];var sSubformDefinitionName=sEvent==="edit"?"update":sEvent==="show"?"display":"display";var oFormWebService={"dataType":"businessObject","ressource_id":"vmap/querys/"+sBusinessObject+"/form","parameters":{"filter":{"column":oObject["bo_id_field"],
"compare_operator":"=","value":oObject["bo_id_value"]}}};formReaderService["getWebServiceData"](oFormWebService).then(function(aResult){var oSubformDefinition=aResult[0]["bo_json_form"];var oSubformValues={};var sModalId="formreader_"+scope["sFormUniqueName"]+"_grid_subform_modal";if(sSubformDefinitionName==="update")oSubformDefinition["update"]["event"]=function(oFormValuesResulted){formReaderService["updateBoElement"](sBusinessObject,oObject,oSubformDefinition,sSubformDefinitionName,oFormValuesResulted,
function(){$("#"+sModalId).modal("hide");setTimeout(function(){formReaderService["getWebServiceData"](angular.copy(scope["oListWebService"])).then(function(oNewResult){setGridData(oNewResult)})});$translate("LIST_EDIT_OK").then(function(translation){$.notify(translation,"success")})})};oSubformValues[sSubformDefinitionName]=aResult[0]["bo_form"];oSubformDefinition[sSubformDefinitionName]["name"]="formreader_"+scope["sFormUniqueName"]+"_grid_subform_form";if(bIsIntersected)oSubformDefinition=formReaderService["disableFormElement"](oSubformDefinition,
sFilterAttr,sSubformDefinitionName);if(!goog.isDefAndNotNull(oObject)){console.error("oObject undefined");return 0}if(!goog.isDefAndNotNull(oSubformScope)){console.error("oSubformScope undefined");return 0}if(!goog.isDefAndNotNull(oSubformDefinition)){console.error("oSubformDefinition undefined");return 0}if(!goog.isDefAndNotNull(sSubformDefinitionName)){console.error("sSubformDefinitionName undefined");return 0}if(!goog.isDefAndNotNull(oSubformValues)){console.error("oSubformValues undefined");return 0}oMainScope.$applyAsync(function(){oMainScope["grid_subform_title"]=
aResult[0]["bo_title"];oMainScope["grid_subform_definition_name"]=sSubformDefinitionName;if(sSubformDefinitionName==="update")oMainScope["grid_subform_size"]=oBusinessObject["edit_form_size"];if(sSubformDefinitionName==="display")oMainScope["grid_subform_size"]=oBusinessObject["display_form_size"]});formReaderService["showModalSubform"](sModalId,oSubformScope,oSubformDefinition,sSubformDefinitionName,oSubformValues)})};scope["gridApi"]["grid"]["refresh"]()}else setGridData([])})};scope["addObject"]=
function(){if(formContainer.attr("id")==="studio_form_reader"){$translate("NO_IN_STUDIO").then(function(translation){$.notify(translation,"error")});return 0}var oSubformValues={"insert":angular.copy(oInsertValues)};var sModalId="formreader_"+scope["sFormUniqueName"]+"_grid_subform_modal";var oSubformDefinition=oBusinessObject["json_form"][0];var sSubformDefinitionName="insert";if(bIsIntersected)oSubformDefinition=formReaderService["disableFormElement"](oSubformDefinition,sFilterAttr,sSubformDefinitionName);
oMainScope.$applyAsync(function(){oMainScope["grid_subform_title"]=oBusinessObject["title"];oMainScope["grid_subform_size"]=oBusinessObject["add_form_size"];oMainScope["grid_subform_definition_name"]=sSubformDefinitionName});oSubformDefinition[sSubformDefinitionName]["name"]="formreader_"+scope["sFormUniqueName"]+"_grid_subform_form";var lastInsert=Date.now();oSubformDefinition["insert"]["event"]=function(oFormValuesResulted){if(lastInsert>Date.now()-2E3)return false;lastInsert=Date.now();formReaderService["insertBoElement"](sBusinessObject,
oBusinessObject,oSubformDefinition,sSubformDefinitionName,oFormValuesResulted,function(){$("#"+sModalId).modal("hide");setTimeout(function(){setGrid()});$translate("LIST_ADD_OK").then(function(translation){$.notify(translation,"success")})})};formReaderService["showModalSubform"](sModalId,oSubformScope,oSubformDefinition,sSubformDefinitionName,oSubformValues)};scope["removeSelection"]=function(){if(formContainer.attr("id")==="studio_form_reader"){$translate("NO_IN_STUDIO").then(function(translation){$.notify(translation,
"error")});return 0}var aIds=[];var rows=scope["gridApi"]["selection"]["getSelectedRows"]();if(rows.length>0)$translate("LIST_DELETE_CONFIRM").then(function(translation){bootbox.confirm(translation,function(result){if(result===true){for(var i=0;i<rows.length;i++)aIds.push(rows[i]["bo_object_infos"]["bo_id_value"]);formReaderService["deleteBoElements"](sBusinessObject,aIds,function(){setTimeout(function(){formReaderService["getWebServiceData"](angular.copy(scope["oListWebService"])).then(function(oNewResult){setGridData(oNewResult)})});
$translate("LIST_DELETE_OK").then(function(translation){$.notify(translation,"success")})})}})});else $translate("LIST_NO_ELEMENT_SELECTED").then(function(translation){$.notify(translation,"warning")})};scope["showFilterFormModal"]=function(){if(formContainer.attr("id")==="studio_form_reader"){$translate("NO_IN_STUDIO").then(function(translation){$.notify(translation,"error")});return 0}var oFilterformScope=oSubformScope;var sFilterformDefinitionName="search";var oFilterformDefinition=oBusinessObject["json_form"][0];
var oFilterformValues={"search":oSearchValues};if(bIsIntersected)oFilterformDefinition=formReaderService["disableFormElement"](oFilterformDefinition,sFilterAttr,sFilterformDefinitionName);oFilterformDefinition[sFilterformDefinitionName]["name"]="formreader_"+scope["sFormUniqueName"]+"_grid_subform_form";oFilterformDefinition[sFilterformDefinitionName]["event"]=function(oFormValuesResulted){envSrvc["oFormValues"]=oFormValuesResulted;envSrvc["oFormDefinition"]=oFilterformDefinition;envSrvc["sFormDefinitionName"]=
sFilterformDefinitionName;var oValues=formSrvc["getFormData"](sFilterformDefinitionName,true);var sFilter=formReaderService["parseFilter"](oValues);scope["oListWebService"]["parameters"]["filter"]=sFilter;$("#"+sModalId).modal("hide");formReaderService["getWebServiceData"](angular.copy(scope["oListWebService"])).then(function(oNewResult){setGridData(oNewResult)});$translate("LIST_SEARCH_OK").then(function(translation){$.notify(translation,"success")})};oMainScope.$applyAsync(function(){oMainScope["grid_subform_title"]=
oBusinessObject["title"];oMainScope["grid_subform_definition_name"]=sFilterformDefinitionName});oFilterformScope["loadSubForm"]({"sFormDefinitionName":sFilterformDefinitionName,"oFormDefinition":oFilterformDefinition,"oFormValues":oFilterformValues,"oProperties":scope["oProperties"]});$("#"+sModalId).modal("show")};setGrid()})};scope["initSectionSubformGrid"]=function(){$log.log("formReader.appSubformGridDrtv.initSectionSubformGrid");var sSection=scope["field"]["section_id"];var sSubformId="formreader_"+
scope["sFormUniqueName"]+"_grid_subform";var sModalId="formreader_"+scope["sFormUniqueName"]+"_grid_subform_modal";var envSrvc=angular.element(vitisApp.appMainDrtv).injector().get(["envSrvc"]);var formSrvc=angular.element(vitisApp.appMainDrtv).injector().get(["formSrvc"]);var oSubformScope=angular.element("#"+sSubformId).scope();var oSearchValues={};var oInsertValues={};var sFilterAttr=scope["field"]["section_filter_attr"];var sFilterValue=scope["field"]["form_filter_value"];var bIsIntersected=false;
scope["haveInsertRights"]=false;scope["haveDeleteRights"]=false;oMainScope["closeModal"]=function(identifier){$(identifier).modal("hide")};$("#"+sModalId).on("hidden.bs.modal",function(event){setTimeout(function(){envSrvc["oFormValues"]=oMainScope["oFormValues"];envSrvc["oFormDefinition"]=oMainScope["oFormDefinition"];envSrvc["sFormDefinitionName"]=oMainScope["sFormDefinitionName"]})});if(goog.isDefAndNotNull(sFilterAttr)&&sFilterAttr!=="")if(goog.isDefAndNotNull(sFilterValue)&&sFilterValue!=="")if(goog.isDefAndNotNull(oMainScope["oFormValues"]))if(goog.isDefAndNotNull(oMainScope["oFormValues"][oMainScope["sFormDefinitionName"]]))if(goog.isDefAndNotNull(oMainScope["oFormValues"][oMainScope["sFormDefinitionName"]][sFilterValue])){bIsIntersected=
true;oSearchValues[sFilterAttr]=oMainScope["oFormValues"][oMainScope["sFormDefinitionName"]][sFilterValue];oInsertValues[sFilterAttr]=oMainScope["oFormValues"][oMainScope["sFormDefinitionName"]][sFilterValue]}scope["addObject"]=function(){if(formContainer.attr("id")==="studio_form_reader"){$translate("NO_IN_STUDIO").then(function(translation){$.notify(translation,"error")});return 0}var oSubformValues={"insert":angular.copy(oInsertValues)};var oSubformDefinition=scope["oSubformDefinition"];var oSubformScope=
angular.element("#formreader_"+scope["sFormUniqueName"]+"_grid_subform").scope();var sSubformDefinitionName="insert";if(bIsIntersected)oSubformDefinition=formReaderService["disableFormElement"](oSubformDefinition,sFilterAttr,sSubformDefinitionName);oMainScope.$applyAsync(function(){oMainScope["grid_subform_title"]=scope["oRessourceTab"]["name"];oMainScope["grid_subform_definition_name"]=sSubformDefinitionName});oSubformDefinition[sSubformDefinitionName]["name"]="formreader_"+scope["sFormUniqueName"]+
"_grid_subform_form";if(goog.isDefAndNotNull(oSubformDefinition["insert"]["afterEvent"]))delete oSubformDefinition["insert"]["afterEvent"];oSubformDefinition["insert"]["event"]=function(oFormValuesResulted){formReaderService["insertSectionElement"](scope["oSection"]["ressource_id"],scope["sIdField"],scope["oSubformDefinition"],sSubformDefinitionName,oFormValuesResulted).then(function(){$("#"+sModalId).modal("hide");setTimeout(function(){formReaderService["getSectionRessourceData"](scope["oSection"]["ressource_id"]).then(function(oNewResult){scope["gridOptions"]["data"]=
oNewResult})});$translate("LIST_ADD_OK").then(function(translation){$.notify(translation,"success")})})};formReaderService["showModalSubform"](sModalId,oSubformScope,oSubformDefinition,sSubformDefinitionName,oSubformValues)};scope["removeSelection"]=function(){if(formContainer.attr("id")==="studio_form_reader"){$translate("NO_IN_STUDIO").then(function(translation){$.notify(translation,"error")});return 0}var aIds=[];var rows=scope["gridApi"]["selection"]["getSelectedRows"]();if(rows.length>0)$translate("LIST_DELETE_CONFIRM").then(function(translation){bootbox.confirm(translation,
function(result){if(result===true){for(var i=0;i<rows.length;i++)aIds.push(rows[i][scope["sIdField"]]);formReaderService["deleteSectionElements"](scope["oSection"]["ressource_id"],aIds).then(function(oResponse){setTimeout(function(){formReaderService["getSectionRessourceData"](scope["oSection"]["ressource_id"]).then(function(oNewResult){scope["gridOptions"]["data"]=oNewResult})});$translate("LIST_DELETE_OK").then(function(translation){$.notify(translation,"success")})})}})});else $translate("LIST_NO_ELEMENT_SELECTED").then(function(translation){$.notify(translation,
"warning")})};scope["showFilterFormModal"]=function(){if(formContainer.attr("id")==="studio_form_reader"){$translate("NO_IN_STUDIO").then(function(translation){$.notify(translation,"error")});return 0}var oFilterformScope=oSubformScope;var sFilterformDefinitionName="search";var oFilterformDefinition=scope["oSubformDefinition"];var oFilterformValues={"search":oSearchValues};if(bIsIntersected)oFilterformDefinition=formReaderService["disableFormElement"](oFilterformDefinition,sFilterAttr,sFilterformDefinitionName);
oFilterformDefinition[sFilterformDefinitionName]["name"]="formreader_"+scope["sFormUniqueName"]+"_grid_subform_form";oFilterformDefinition[sFilterformDefinitionName]["event"]=function(oFormValuesResulted){envSrvc["oFormValues"]=oFormValuesResulted;envSrvc["oFormDefinition"]=oFilterformDefinition;envSrvc["sFormDefinitionName"]=sFilterformDefinitionName;var oValues=formSrvc["getFormData"](sFilterformDefinitionName,true);var sFilter=formReaderService["parseFilter"](oValues);$("#"+sModalId).modal("hide");
formReaderService["getSectionRessourceData"](scope["oSection"]["ressource_id"],sFilter).then(function(oNewResult){scope["gridOptions"]["data"]=oNewResult});$translate("LIST_SEARCH_OK").then(function(translation){$.notify(translation,"success")})};oMainScope.$applyAsync(function(){oMainScope["grid_subform_title"]=scope["oRessourceTab"]["name"];oMainScope["grid_subform_definition_name"]=sFilterformDefinitionName});oFilterformScope["loadSubForm"]({"sFormDefinitionName":sFilterformDefinitionName,"oFormDefinition":oFilterformDefinition,
"oFormValues":oFilterformValues,"oProperties":scope["oProperties"]});$("#"+sModalId).modal("show")};formReaderService["getSectionDef"](sSection).then(function(oSection){scope["oSection"]=oSection;formReaderService["getSectionRessourceTab"](scope["oSection"]["ressource_id"]).then(function(oRessourceTab){scope["oRessourceTab"]=oRessourceTab;formReaderService["getSectionRessourceData"](scope["oSection"]["ressource_id"]).then(function(aRessourceData){scope["aRessourceData"]=aRessourceData;formReaderService["getSectionForm"](scope["oSection"],
true).then(function(oSubformDefinition){scope["oSubformDefinition"]=oSubformDefinition;var aColumns,aActions,oTab;var sRessource=scope["oRessourceTab"]["ressource_id"].substr(scope["oRessourceTab"]["ressource_id"].lastIndexOf("/")+1);for(var i=0;i<scope["oRessourceTab"][sRessource].length;i++){if(goog.isDefAndNotNull(scope["oRessourceTab"][sRessource][i]["columns"]))aColumns=scope["oRessourceTab"][sRessource][i]["columns"];if(goog.isDefAndNotNull(scope["oRessourceTab"][sRessource][i]["actions"]))aActions=
scope["oRessourceTab"][sRessource][i]["actions"];if(goog.isDefAndNotNull(scope["oRessourceTab"][sRessource][i]["tabs"]))oTab=scope["oRessourceTab"][sRessource][i]["tabs"][0]}scope["sIdField"]=angular.copy(aColumns[0]["name"]);if(oTab["show_column"]==="showSectionForm")scope["gridApi"]["grid"]["appScope"]["show_column"]="show";if(oTab["edit_column"]==="editSectionForm")scope["gridApi"]["grid"]["appScope"]["edit_column"]="edit";scope["gridOptions"]["columnDefs"]=[{"name":"","field":"actions","cellTemplate":"<app-ui-grid-action></app-ui-grid-action>",
"width":60,"enableSorting":false,"enableColumnMoving":false,"enableColumnResizing":false}];if(goog.isDefAndNotNull(aColumns))goog.array.extend(scope["gridOptions"]["columnDefs"],aColumns);scope["gridOptions"]["data"]=angular.copy(scope["aRessourceData"]);for(var i=0;i<aActions.length;i++){if(aActions[i]["event"]==="AddSectionForm")scope["haveInsertRights"]=true;if(aActions[i]["event"]==="DeleteSelection")scope["haveDeleteRights"]=true}scope["gridApi"]["grid"]["appScope"]["executeActionButtonEvent"]=
function(oRow,sEvent){if(formContainer.attr("id")==="studio_form_reader"){$translate("NO_IN_STUDIO").then(function(translation){$.notify(translation,"error")});return 0}var sSubformDefinitionName=sEvent==="edit"?"update":sEvent==="show"?"display":"display";var oSubformValues={};oSubformValues[sSubformDefinitionName]=angular.copy(oRow["entity"]);scope["oSubformDefinition"][sSubformDefinitionName]["name"]="formreader_"+scope["sFormUniqueName"]+"_grid_subform_form";if(sSubformDefinitionName==="update")scope["oSubformDefinition"]["update"]["event"]=
function(oFormValuesResulted){formReaderService["updateSectionElement"](scope["oSection"]["ressource_id"],scope["sIdField"],scope["oSubformDefinition"],sSubformDefinitionName,oFormValuesResulted).then(function(){$("#"+sModalId).modal("hide");setTimeout(function(){formReaderService["getSectionRessourceData"](scope["oSection"]["ressource_id"]).then(function(oNewResult){scope["gridOptions"]["data"]=oNewResult})});$translate("LIST_EDIT_OK").then(function(translation){$.notify(translation,"success")})})};
if(bIsIntersected)scope["oSubformDefinition"]=formReaderService["disableFormElement"](scope["oSubformDefinition"],sFilterAttr,sSubformDefinitionName);if(!goog.isDefAndNotNull(oSubformScope)){console.error("oSubformScope undefined");return 0}if(!goog.isDefAndNotNull(scope["oSubformDefinition"])){console.error("scope.oSubformDefinition undefined");return 0}if(!goog.isDefAndNotNull(sSubformDefinitionName)){console.error("sSubformDefinitionName undefined");return 0}if(!goog.isDefAndNotNull(oSubformValues)){console.error("oSubformValues undefined");
return 0}oMainScope.$applyAsync(function(){oMainScope["grid_subform_title"]=scope["oRessourceTab"]["name"];oMainScope["grid_subform_definition_name"]=sSubformDefinitionName});formReaderService["showModalSubform"](sModalId,oSubformScope,scope["oSubformDefinition"],sSubformDefinitionName,oSubformValues)};scope["gridApi"]["grid"]["refresh"]()})})})})};scope["initSubformGrid"]=function(){$log.log("initSubformGrid");if(scope["field"]["type"]==="bo_grid")scope["initBoSubformGrid"]();else if(scope["field"]["type"]===
"section_grid")scope["initSectionSubformGrid"]();setTimeout(function(){if(goog.isDefAndNotNull(scope["gridOptions"]))if(goog.isDefAndNotNull(scope["gridOptions"]["gridApi"]))if(goog.isDefAndNotNull(scope["gridOptions"]["gridApi"]["core"]))if(goog.isDefAndNotNull(scope["gridOptions"]["gridApi"]["core"]["handleWindowResize"])){scope["gridOptions"]["gridApi"]["core"]["handleWindowResize"]();setTimeout(function(){scope["gridOptions"]["gridApi"]["core"]["handleWindowResize"]()},500);setTimeout(function(){scope["gridOptions"]["gridApi"]["core"]["handleWindowResize"]()},
1E3);setTimeout(function(){scope["gridOptions"]["gridApi"]["core"]["handleWindowResize"]()},2E3)}})};if(goog.isDefAndNotNull(oMainScope["initSubformGridEvent"])){oMainScope["initSubformGridEvent_"+scope["field"]["name"]]();oMainScope["initSubformGridEvent_"+scope["field"]["name"]]=null}if(oMainScope["bFormDefinitionInfosExtracted"])scope["initSubformGrid"]();else oMainScope["initSubformGridEvent_"+scope["field"]["name"]]=oMainScope.$on("extractFormDefinitionInfos",function(){scope["initSubformGrid"]()})}}};
formReader.module.directive("appSubformGrid",formReader.appSubformGridDrtv);
formReader.appSubformDrtv=function($compile,$log){return{link:function(scope,element,attrs){$log.log("formReader.appSubformDrtv.link");var content;var template='<div app-form-reader app-properties="oProperties"></div>';scope["oSubformValues"]=null;scope["loadSubForm"]=function(opt_options){$log.log("formReader.loadSubForm");if(!goog.isDefAndNotNull(opt_options["sFormDefinitionName"])){console.error("opt_options['sFormDefinitionName'] undefined");return 0}if(!goog.isDefAndNotNull(opt_options["oFormDefinition"])){console.error("opt_options['oFormDefinition'] undefined");
return 0}if(!goog.isDefAndNotNull(opt_options["oFormValues"])){console.error("opt_options['oFormValues'] undefined");return 0}if(!goog.isDefAndNotNull(opt_options["oProperties"])){console.error("opt_options['oProperties'] undefined");return 0}scope["oSubformValues"]=opt_options["oFormValues"];scope.$applyAsync(function(){scope["oProperties"]=opt_options["oProperties"];content=$compile(template)(scope);element.html("");element.append(content);setTimeout(function(){scope["oFormReaderScope"]=angular.element($(element).find("[app-form-reader]").children()).scope();
scope["oFormReaderScope"]["ctrl"]["setDefinitionName"](opt_options["sFormDefinitionName"]);scope["oFormReaderScope"]["ctrl"]["setFormValues"](scope["oSubformValues"]);scope["oFormReaderScope"]["ctrl"]["setFormDefinition"](opt_options["oFormDefinition"]);scope["oFormReaderScope"]["ctrl"]["loadForm"]()})})};scope["setFormValues"]=function(oValues){$log.log("formReader.setFormValues");scope["oSubformValues"]=oValues;if(goog.isDefAndNotNull(scope["oFormReaderScope"]))if(goog.isDefAndNotNull(scope["oFormReaderScope"]["ctrl"])){scope["oFormReaderScope"]["ctrl"]["setFormValues"](scope["oSubformValues"]);
scope["oFormReaderScope"]["ctrl"]["loadForm"]()}}}}};formReader.module.directive("appSubform",formReader.appSubformDrtv);goog.provide("formReader.service.formReaderService");goog.require("formReader");
formReader.formReaderService=function($translate,$rootScope,$q,$log,$timeout,envSrvc){return{"reloadSelectField":function(oParentSelect,sFormDefinitionName,oFormValues,oFormDefinition){var oChildSelect=this["getFormElementDefinition"](oParentSelect["child_select"],sFormDefinitionName,oFormDefinition);if(goog.isDef(oChildSelect)){var oParams=oChildSelect["web_service"]["parameters"];if(!goog.isDef(oParams))oParams={"filter":{}};if(goog.isString(oParams["filter"]))oParams["filter"]={"stringFilter":oParams["filter"]};
if(!goog.isDef(oParams["filter"]))oParams["filter"]={};oParams["filter"][oParentSelect["name"]]=oFormValues[sFormDefinitionName][oParentSelect["name"]]["selectedOption"]["value"];oChildSelect["web_service"]["parameters"]=oParams;this["setWebServiceSelectOptions"](oChildSelect,sFormDefinitionName,oFormValues,oChildSelect["web_service"])}},"getFormElementDefinition":function(sFormElementName,sFormDefinitionName,oFormDefinition){var oFormDefinition=oFormDefinition[sFormDefinitionName];var i=0,j,k;while(i<
oFormDefinition["rows"].length){j=0;while(j<oFormDefinition["rows"][i]["fields"].length){if(oFormDefinition["rows"][i]["fields"][j]["name"]===sFormElementName)return oFormDefinition["rows"][i]["fields"][j];else if(typeof oFormDefinition["rows"][i]["fields"][j]["buttons"]!="undefined"){k=0;while(k<oFormDefinition["rows"][i]["fields"][j]["buttons"].length){if(oFormDefinition["rows"][i]["fields"][j]["buttons"][k]["name"]===sFormElementName)return oFormDefinition["rows"][i]["fields"][j]["buttons"][k];
k++}}j++}i++}},"getAllFormElementDefinition":function(sFormDefinitionName,oFormDefinition){var oFormDefinition=oFormDefinition[sFormDefinitionName];var oFormElementDefinition=[];var i=0,j;while(i<oFormDefinition["rows"].length){j=0;while(j<oFormDefinition["rows"][i]["fields"].length){oFormElementDefinition.push(oFormDefinition["rows"][i]["fields"][j]);j++}i++}return oFormElementDefinition},"setWebServiceSelectOptions":function(oFormElementDefinition,sFormDefinitionName,oFormValues,oWebService,oSelectedOption){var this_=
this;var sToken=this["sToken"];var oProperties=this["oProperties"];var oFormValues=oFormValues[sFormDefinitionName];var oParams={};var deferred=$q.defer();var promise=deferred.promise;var valueNumber;$rootScope["oFormPromises"][sFormDefinitionName].push(promise);if(!goog.isDefAndNotNull(oFormElementDefinition)){console.error("oFormElementDefinition not defined");return 0}if(!goog.isDefAndNotNull(sFormDefinitionName)){console.error("sFormDefinitionName not defined");return 0}if(!goog.isDefAndNotNull(oFormValues)){console.error("oFormValues not defined");
return 0}if(!goog.isDefAndNotNull(oWebService)){console.error("oWebService not defined");return 0}if(!goog.isDef(oFormValues)){console.error("oFormValues["+sFormDefinitionName+"] not defined");oFormValues={}}this["getWebServiceData"](oWebService).then(function(aData){if(!goog.isDefAndNotNull(aData))return null;var j,oNotSelectedOptions,oSelectedOptions,sFromSelectName="",sToSelectName;var sLabelKey=oWebService["label_key"];var sValueKey=oWebService["id_key"];var aSelectedOptions=[];var selectedData=
oFormValues[oFormElementDefinition["name"]];if(goog.isNumber(selectedData))aSelectedOptions[0]=String(selectedData);else if(goog.isString(selectedData)&&selectedData!=="")aSelectedOptions=selectedData.split("|");else if(goog.isObject(selectedData)&&goog.isArray(selectedData["options"]))for(var i in selectedData["options"])aSelectedOptions.push(selectedData["options"][i]["value"]);j=0;oNotSelectedOptions={"selectedOption":[],"options":[]};oSelectedOptions={"selectedOption":[],"options":[]};if(oFormElementDefinition["type"]===
"double_select"){sFromSelectName=oFormElementDefinition["name_from"];sToSelectName=oFormElementDefinition["name_to"]}else sToSelectName=oFormElementDefinition["name"];while(j<aData.length){if(!goog.isDef(aData[j][sLabelKey])){console.error("result."+sLabelKey+" does not exist, check the label_key param on the JSON file");aData[j][sLabelKey]=null;j++;continue}if(!goog.isDef(aData[j][sValueKey])){console.error("result."+sValueKey+" does not exist, check the id_key param on the JSON file");aData[j][sValueKey]=
null;j++;continue}valueNumber=Number(aData[j][sValueKey]);if(!isNaN(valueNumber))if(!parseInt(valueNumber,10)===valueNumber||parseInt(valueNumber,10)===valueNumber&&String(aData[j][sValueKey]).substr(0,1)!=0)aData[j][sValueKey]=valueNumber;if(aSelectedOptions.indexOf(String(aData[j][sValueKey]))!==-1||sFromSelectName==="")oSelectedOptions["options"].push({"label":aData[j][sLabelKey],"value":aData[j][sValueKey]});else oNotSelectedOptions["options"].push({"label":aData[j][sLabelKey],"value":aData[j][sValueKey]});
j++}if(sFromSelectName===""){if(goog.isDefAndNotNull(oSelectedOption))oSelectedOptions["selectedOption"]=oSelectedOption;else{if(oFormElementDefinition["type"]==="select"||oFormElementDefinition["type"]==="editable_select"){var selectedOptionValue=angular.copy(oFormValues[oFormElementDefinition["name"]]);var selectedOptionLabel;if(selectedOptionValue!==null&&goog.isObject(selectedOptionValue)){selectedOptionValue=selectedOptionValue["selectedOption"]["value"];selectedOptionLabel=oFormValues[oFormElementDefinition["name"]]["selectedOption"]["label"]}if(typeof selectedOptionValue===
"undefined"&&typeof oFormElementDefinition["default_value"]!=="undefined"){selectedOptionValue=oFormElementDefinition["default_value"];if(goog.isString(selectedOptionValue))if(this_["isFunctionCall"](selectedOptionValue))selectedOptionValue=this_["callFunction"](selectedOptionValue)}selectedOptionValue=goog.isDef(selectedOptionValue)?selectedOptionValue:null;selectedOptionLabel=goog.isDef(selectedOptionLabel)?selectedOptionLabel:"";oSelectedOptions["selectedOption"]={"value":selectedOptionValue,"label":selectedOptionLabel}}if(oFormElementDefinition["type"]===
"list"){var selectedOptionValue=angular.copy(oFormValues[oFormElementDefinition["name"]]);if(goog.isDefAndNotNull(selectedOptionValue))if(goog.isArray(selectedOptionValue["selectedOption"]))selectedOptionValue=selectedOptionValue["selectedOption"];if(goog.isDefAndNotNull(selectedOptionValue)&&typeof oFormElementDefinition["default_value"]!=="undefined"){selectedOptionValue=oFormElementDefinition["default_value"];if(goog.isString(selectedOptionValue))if(this_["isFunctionCall"](selectedOptionValue))selectedOptionValue=
this_["callFunction"](selectedOptionValue)}if(goog.isArray(selectedOptionValue)&&selectedOptionValue.length>0)oSelectedOptions["selectedOption"]=selectedOptionValue;else{var aSelectedOptionValues=[];if(goog.isString(selectedOptionValue))aSelectedOptionValues=selectedOptionValue.split("|");if(goog.isNumber(selectedOptionValue))aSelectedOptionValues=[selectedOptionValue];oSelectedOptions["selectedOption"]=[];for(var i=0;i<aSelectedOptionValues.length;i++)for(var ii=0;ii<oSelectedOptions["options"].length;ii++)if(oSelectedOptions["options"][ii]["value"]==
aSelectedOptionValues[i]){if(goog.isNumber(oSelectedOptions["options"][ii]["value"])&&goog.isString(aSelectedOptionValues[i]))aSelectedOptionValues[i]=parseFloat(aSelectedOptionValues[i]);oSelectedOptions["selectedOption"].push({"value":aSelectedOptionValues[i],"label":oSelectedOptions["options"][ii]["label"]})}}}}if(goog.isDefAndNotNull(oFormElementDefinition["options"])){var i=0,aOptions,aOptionsKeys=[],aOptionsValues=[];while(i<oFormElementDefinition["options"].length){aOptions=oFormElementDefinition["options"][i].split("|");
aOptionsKeys.push(aOptions[0]);aOptionsValues.push(aOptions[1]);i++}$translate(aOptionsKeys).then(function(translations){var aTranslationsKeys=Object.keys(translations);i=0;while(i<aTranslationsKeys.length){oSelectedOptions["options"].unshift({"label":translations[aTranslationsKeys[i]],"value":aOptionsValues[i]});i++}})}if(oFormElementDefinition["required"]!==true&&oFormElementDefinition["required"]!=="true"){var isEmptyValuePresent=false;for(var i=0;i<oSelectedOptions["options"].length;i++)if(oSelectedOptions["options"][i]["value"]===
"")isEmptyValuePresent=true;if(!isEmptyValuePresent)oSelectedOptions["options"].unshift({"label":"","value":""})}}else oFormValues[sFromSelectName]=oNotSelectedOptions;oFormValues[sToSelectName]=oSelectedOptions;if(oFormElementDefinition["type"]!=="editable_select"){var selectedIsInOption=false;for(var i=0;i<oFormValues[sToSelectName]["options"].length;i++)if(oSelectedOptions["selectedOption"]["value"]==oFormValues[sToSelectName]["options"][i]["value"]){oSelectedOptions["selectedOption"]["value"]=
oFormValues[sToSelectName]["options"][i]["value"];oSelectedOptions["selectedOption"]["label"]=oFormValues[sToSelectName]["options"][i]["label"];selectedIsInOption=true}if(!selectedIsInOption){delete oFormValues[sToSelectName]["selectedOption"]["value"];delete oFormValues[sToSelectName]["selectedOption"]["label"]}}if(!goog.isDefAndNotNull(oFormValues[sToSelectName]))oFormValues[sToSelectName]={};if(!goog.isDefAndNotNull(oFormValues[sToSelectName]["selectedOption"]))oFormValues[sToSelectName]["selectedOption"]=
{};if(!goog.isDefAndNotNull(oFormValues[sToSelectName]["selectedOption"]["value"])){oFormValues[sToSelectName]["selectedOption"]["value"]="";oFormValues[sToSelectName]["selectedOption"]["label"]=""}if(oFormElementDefinition["type"]==="list")if(goog.isObject(oFormValues[sToSelectName]["selectedOption"])&&!goog.isArray(oFormValues[sToSelectName]["selectedOption"]))oFormValues[sToSelectName]["selectedOption"]=[oFormValues[sToSelectName]["selectedOption"]];this["oFormValues"]=oFormValues;this["sFormDefinitionName"]=
sFormDefinitionName;envSrvc["oFormDefaultValues"][sFormDefinitionName]=this_["copyFormValues"](oFormValues);if(typeof oWebService["callback"]!=="undefined")if(this_["isFunctionCall"](oWebService["callback"]))this_["callFunction"](oWebService["callback"]);$rootScope.$emit("webServiceSelectOptionsloaded");deferred.resolve()})},"getWebServiceData":function(oWebService){var sToken=this["sToken"];var oProperties=this["oProperties"];var oWebService=oWebService;var oParams={};var deferred=$q.defer();if(!goog.isDefAndNotNull(oWebService)){console.error("oWebService not defined");
return 0}if(goog.isDef(oWebService["parameters"])){oParams=oWebService["parameters"];if(oWebService["dataType"]==="businessObject")if(goog.isDefAndNotNull(oParams["attributs"]))delete oParams["attributs"];if(goog.isDef(oWebService["parameters"]["filter"])||goog.isDef(oWebService["parameters"]["filter_extension"])){oWebService["parameters"]["filter"]=this["parseFilter"](oWebService["parameters"]["filter"]);if(oWebService["parameters"]["filter"]==="")delete oWebService["parameters"]["filter"]}}ajaxRequest({"method":"POST",
"url":oProperties["web_server_name"]+"/"+oProperties["services_alias"]+"/"+oWebService["ressource_id"],"data":oParams,"scope":$rootScope,"headers":{"X-HTTP-Method-Override":"GET","Accept":"application/x-vm-json"},"success":function(response){if(goog.isDefAndNotNull(oWebService["parameters"]))oWebService["parameters"]["filter"]=oWebService["parameters"]["original_filter"];var data=response["data"];data["data"]=goog.isDef(data["data"])?data["data"]:[];if(data["status"]===1){var aData;if(goog.isDefAndNotNull(oWebService["subObject"])){aData=
[];for(var i=0;i<data["data"].length;i++)if(goog.isDefAndNotNull(data["data"][i][oWebService["subObject"]]))aData.push(data["data"][i][oWebService["subObject"]])}else aData=goog.isDef(data["data"])?data["data"]:[]}deferred.resolve(aData)}});return deferred.promise},"emptySelectOptions":function(oFormElementDefinition,sFormDefinitionName,oFormValues){var sFromSelectName,sToSelectName;if(oFormElementDefinition["type"]==="double_select"){sFromSelectName=oFormElementDefinition["name_from"];sToSelectName=
oFormElementDefinition["name_to"]}else sToSelectName=oFormElementDefinition["name"];if(goog.isDefAndNotNull(oFormValues[sFormDefinitionName]))if(goog.isDefAndNotNull(oFormValues[sFormDefinitionName][sToSelectName]))if(goog.isDefAndNotNull(oFormValues[sFormDefinitionName][sToSelectName]["options"]))oFormValues[sFormDefinitionName][sToSelectName]="";this["oFormValues"]=oFormValues;if(goog.isDefAndNotNull(envSrvc["oFormDefaultValues"]))if(goog.isDefAndNotNull(envSrvc["oFormDefaultValues"][sFormDefinitionName]))envSrvc["oFormDefaultValues"][sFormDefinitionName]=
this["copyFormValues"](oFormValues)},"callFunction":function(sFunction){if(!goog.isDefAndNotNull(sFunction)){console.error("callFunction: no function defined");return 0}if(!sFunction.length>0){console.error('callFunction: function === ""');return 0}var sParams="";var aParams=[];if(sFunction.indexOf("(")!==-1){sParams=sFunction.substr(sFunction.indexOf("("));sParams=sParams.substr(1,sParams.length-2);if(sParams.length>0)aParams=sParams.split(",");for(var i=0;i<aParams.length;i++)if(goog.isString(aParams[i]))aParams[i]=
aParams[i].trim()}for(var i=0;i<aParams.length;i++)if(this["isFunctionCall"](aParams[i]))aParams[i]="'"+this["callFunction"](aParams[i])+"'";if(aParams.length>0)sFunction=sFunction.replace(sParams,aParams.join(","));var sFunctionName=sFunction.substr(0,sFunction.indexOf("("));var returnMessage;this["eventsContainer"]=this["oFormEventsContainer"];this["rootScope_"]=$rootScope;if(typeof eval("window."+sFunctionName)=="function")try{$log.log(sFunction);returnMessage=eval(sFunction)}catch(e){if(this["oProperties"]["debug_mode"]===
true)console.error(e)}else if(typeof this["eventsContainer"]!="undefined"&&typeof this["eventsContainer"][sFunctionName]=="function")try{$log.log("eventsContainer."+sFunction);returnMessage=eval("this.eventsContainer."+sFunction)}catch(e){if(this["oProperties"]["debug_mode"]===true)console.error(e)}else if(typeof this[sFunctionName]=="function")try{$log.log("this."+sFunction);returnMessage=eval("this."+sFunction)}catch(e){if(this["oProperties"]["debug_mode"]===true)console.error(e)}else if(typeof this["rootScope_"]!=
"undefined"&&typeof this["rootScope_"][sFunctionName]=="function")try{$log.log("$rootScope."+sFunction);returnMessage=eval("this.rootScope_."+sFunction)}catch(e){if(this["oProperties"]["debug_mode"]===true)console.error(e)}return returnMessage},"isFunctionCall":function(sString,bCheckFunction){if(typeof bCheckFunction=="undefined")bCheckFunction=true;var bReturn=false;if(typeof sString==="string"){aMatchResult=sString.match(/(.+)\((.*)\)/);if(aMatchResult!==null)if(bCheckFunction){var sFunctionName=
sString.substr(0,sString.indexOf("("));var returnMessage;if(typeof sFunctionName=="function")bReturn=true;else if(typeof this["oFormEventsContainer"]!="undefined"&&typeof this["oFormEventsContainer"][sFunctionName]=="function")bReturn=true;else if(typeof this[sFunctionName]=="function")bReturn=true;else if(typeof $rootScope[sFunctionName]=="function")bReturn=true;if(!bReturn)$log.warn("Function not found : "+sString)}else bReturn=true}return bReturn},"selectFirstOption":function(sFormElementName,
oFormValues,sFormDefinitionName){oFormValues=goog.isDef(oFormValues)?oFormValues:this["oFormValues"];sFormDefinitionName=goog.isDef(sFormDefinitionName)?sFormDefinitionName:this["sFormDefinitionName"];oFormValues=oFormValues[sFormDefinitionName];if(oFormValues[sFormElementName]["options"].length>0)oFormValues[sFormElementName]["selectedOption"]["value"]=oFormValues[sFormElementName]["options"][0]["value"]},"setSelectOptions":function(oFormElementDefinition,sFormDefinitionName,oFormValues,aOptions){$log.log("setSelectOptions");
var getFormatedOptions=function(aKeys,aValues){var aOptions=[];if(!goog.isArray(aKeys)){console.error("getFormatedOptions: aKeys is not an array",aKeys);return aOptions}if(!goog.isArray(aValues)){console.error("getFormatedOptions: aKeys is not an array",aValues);return aOptions}if(aKeys.length!==aValues.length){console.error("getFormatedOptions: aKeys.length !== aValues.length",aKeys,aValues);return aOptions}for(var i=0;i<aKeys.length;i++)aOptions.push({"label":aKeys[i],"value":aValues[i]});return aOptions};
var i=0,sLabel,sValue,aOption;var oSelectOptions={"selectedOption":{"value":""},"options":[]};var sSelectName,sFromSelectName,sToSelectName;aOptions=goog.isDef(aOptions)?aOptions:oFormElementDefinition["options"];var aOptionsKeys=[];var aOptionsValues=[];if(goog.isString(aOptions))aOptions=aOptions.split(",");while(i<aOptions.length){aOption=aOptions[i].split("|");sLabel=aOption[0];aOptionsKeys.push(sLabel);if(aOption.length>1)sValue=aOption[1];else sValue=sLabel;aOptionsValues.push(sValue);i++}var selectValue=
oFormValues[sFormDefinitionName][oFormElementDefinition["name"]];if(oFormElementDefinition["type"]==="list"&&goog.isString(selectValue)){var aSelectedValues=selectValue.split("|");if(aSelectedValues.length>0){var aSelectedOptions=[];for(var i=0;i<aSelectedValues.length;i++)aSelectedOptions.push({"label":"","value":aSelectedValues[i]});selectValue={"selectedOption":aSelectedOptions}}}if(typeof selectValue==="undefined"&&typeof oFormElementDefinition["default_value"]!=="undefined"){selectValue=oFormElementDefinition["default_value"];
if(typeof selectValue==="string")if(this["isFunctionCall"](selectValue))selectValue=this["callFunction"](selectValue)}if(goog.isDefAndNotNull(selectValue))if(goog.isDefAndNotNull(selectValue["selectedOption"])){if(goog.isDefAndNotNull(selectValue["selectedOption"]["value"]))oSelectOptions=selectValue;if(goog.isArray(selectValue["selectedOption"]))oSelectOptions=selectValue}else oSelectOptions["selectedOption"]["value"]=String(selectValue);$translate(aOptionsKeys).then(function(translations){for(var i=
0;i<aOptionsKeys.length;i++)if(isNaN(aOptionsKeys[i]))aOptionsKeys[i]=translations[aOptionsKeys[i]];oSelectOptions["options"]=getFormatedOptions(aOptionsKeys,aOptionsValues);if(oFormElementDefinition["type"]==="double_select"){sFromSelectName=oFormElementDefinition["name_from"];sToSelectName=oFormElementDefinition["name_to"];var aFromOptionsKeys=angular.copy(aOptionsKeys);var aFromOptionsValues=angular.copy(aOptionsValues);var aToOptionsKeys=[];var aToOptionsValues=[];var aValues=[];if(goog.isDefAndNotNull(selectValue))aValues=
selectValue.split("|");for(var i=0;i<aValues.length;i++){var index=aFromOptionsValues.indexOf(aValues[i]);aToOptionsValues.unshift(aFromOptionsValues[index]);aToOptionsKeys.unshift(aFromOptionsKeys[index]);aFromOptionsValues.splice(index,1);aFromOptionsKeys.splice(index,1)}var oFromSelectOptions={"options":getFormatedOptions(aFromOptionsKeys,aFromOptionsValues)};var oToSelectOptions={"options":getFormatedOptions(aToOptionsKeys,aToOptionsValues)};oFormValues[sFormDefinitionName][sFromSelectName]=oFromSelectOptions;
oFormValues[sFormDefinitionName][sToSelectName]=oToSelectOptions}else{sSelectName=oFormElementDefinition["name"];oFormValues[sFormDefinitionName][sSelectName]=oSelectOptions}if(typeof envSrvc["oFormDefaultValues"][sFormDefinitionName]==="undefined")envSrvc["oFormDefaultValues"][sFormDefinitionName]={};if(typeof envSrvc["oFormDefaultValues"][sFormDefinitionName][sSelectName]=="undefined")envSrvc["oFormDefaultValues"][sFormDefinitionName][sSelectName]=angular.copy(oSelectOptions)})},"selectOptionAfterLoad":function(oFormValues,
oFormElementDefinition,sFormDefinitionName,sFieldName,value){if(oFormElementDefinition["type"]==="double_select")console.log(value);else if(oFormElementDefinition["type"]==="select"){var opt=oFormValues[sFormDefinitionName][sFieldName].options;for(var i=0;i<opt.length;i++)if(opt[i].value===value){oFormValues[sFormDefinitionName][sFieldName].selectedOption=opt[i];break}}else if(oFormElementDefinition["type"]==="list");else console.error("this element is not a select")},"extractWebServiceData":function(sController,
oWebServiceData){var sKey=sController;var aData=[];if(typeof oWebServiceData[sKey]!=="undefined")if(Array.isArray(oWebServiceData[sKey])){if(oWebServiceData[sKey].length>0)aData=oWebServiceData[sKey]}else aData=oWebServiceData[sKey];return aData},"parseFilter":function(filter){if(goog.isObject(filter)){var isJSONFilter=false;if(goog.isDefAndNotNull(filter["operators"])&&goog.isDefAndNotNull(filter["relation"]))isJSONFilter=true;if(goog.isDefAndNotNull(filter["column"])&&goog.isDefAndNotNull(filter["compare_operator"])&&
goog.isDefAndNotNull(filter["value"]))isJSONFilter=true;if(!isJSONFilter){var aFilters=[];var sFilterValue;for(var key in filter)if(key==="stringFilter")aFilters.push(filter[key]);else{sFilterValue=filter[key];if(sFilterValue!==""){if(this["isFunctionCall"](sFilterValue))sFilterValue=this["callFunction"](sFilterValue);if(!goog.isDefAndNotNull(sFilterValue))sFilterValue="is null";if(goog.isDef(sFilterValue)){var sCompareOperator="=";if(goog.isString(sFilterValue)){if(sFilterValue.toLowerCase().trim()===
"not null"){sCompareOperator="!=";sFilterValue="NULL"}if(sFilterValue.toLowerCase().trim()==="is null"){sCompareOperator="IS NULL";sFilterValue=""}if(sFilterValue.toLowerCase().trim()==="is not null"){sCompareOperator="IS NOT NULL";sFilterValue=""}}aFilters.push({"column":key,"compare_operator":sCompareOperator,"value":sFilterValue})}}}if(aFilters.length>0){filter={"relation":"AND","operators":[]};for(var i=0;i<aFilters.length;i++)filter["operators"].push(aFilters[i])}else filter=""}}return filter},
"setWebServiceTags":function(oFormElementDefinition,sFormDefinitionName,oFormValues){var oWebService=angular.copy(oFormElementDefinition["web_service"]);var aRessourceId=oWebService["ressource_id"].split("/");var oFormValues=oFormValues[sFormDefinitionName],selectedOptionValue;var oFormSrvc=this;var oParams={};if(typeof oWebService["parameters"]!=="undefined"){oParams=oWebService["parameters"];if(typeof oWebService["parameters"]["filter"]!=="undefined"){oWebService["parameters"]["filter"]=this["parseFilter"](oWebService["parameters"]["filter"]);
if(oWebService["parameters"]["filter"]==="")delete oWebService["parameters"]["filter"]}}ajaxRequest({"method":"POST","url":this["oProperties"]["web_server_name"]+"/"+this["oProperties"]["services_alias"]+"/"+oWebService["ressource_id"],"headers":{"X-HTTP-Method-Override":"GET"},"data":oParams,"scope":$rootScope,"success":function(response){var data=response["data"];var j,oNotSelectedOptions,oSelectedOptions,sFromSelectName="",sToSelectName;if(data["status"]===1){var aData=oFormSrvc["extractWebServiceData"](aRessourceId[1],
data);var aTags=[];if(typeof oFormValues[oFormElementDefinition["name"]]==="string")aTags=oFormValues[oFormElementDefinition["name"]].split(",");var sLabelKey=oWebService["label_key"];var sValueKey=oWebService["id_key"];var i=0;var aAvailableTags=[];while(i<aData.length){if(aTags.indexOf(aData[i][sValueKey])===-1)aAvailableTags.push(aData[i][sValueKey]);i++}oFormValues[oFormElementDefinition[["name_available_tags"]]]=aAvailableTags.join(",");if(typeof envSrvc["oFormDefaultValues"][sFormDefinitionName][oFormElementDefinition[["name_available_tags"]]]==
"undefined")envSrvc["oFormDefaultValues"][sFormDefinitionName][oFormElementDefinition[["name_available_tags"]]]=angular.copy(oFormValues[oFormElementDefinition[["name_available_tags"]]]);$timeout(function(){$rootScope.$emit("webServiceTagsloaded",oFormElementDefinition)})}}})},"checkFormModifications":function(sFormDefinitionName){var deferred=$q.defer();var promise=deferred.promise;if((envSrvc["sMode"]=="insert"||envSrvc["sMode"]=="update")&&typeof sFormDefinitionName!="undefined"){var oFormDefinition=
envSrvc["oFormDefinition"][sFormDefinitionName];if(typeof oFormDefinition!="undefined"&&typeof oFormDefinition["event"]!="undefined"){var sFormName=oFormDefinition["name"];var oFormElement=angular.element("form[name='"+sFormName+"']");if(oFormElement.length>0){var formScope=oFormElement.scope();if(formScope[sFormName]["$dirty"]&&!formScope[sFormName]["$submitted"]){var oOptions={"className":"modal-warning","message":"FORM_MODIFIED_WARNING","callback":function(bResponse){if(bResponse)deferred.resolve()}};
formScope.$root["modalWindow"]("confirm","FORM_MODIFIED_WARNING_TITLE",oOptions)}else deferred.resolve()}else deferred.resolve()}else deferred.resolve()}else deferred.resolve();return promise},"checkStudioFormModifications":function(sSelectedObjectName){var deferred=$q.defer();var promise=deferred.promise;var AppName=oVFB.getApplication();if(AppName==="vmap"){var Update=oVFB.getUpdate();if(Update===true){var oOptions={"className":"modal-warning","message":"FORM_MODIFIED_WARNING","callback":function(bResponse){if(bResponse)deferred.resolve()}};
$rootScope["modalWindow"]("confirm","FORM_MODIFIED_WARNING_TITLE",oOptions)}else deferred.resolve()}else deferred.resolve();return promise},"getFormValueFromObject":function(oFormValues,sFormFieldName){$log.info("getFormValueFromObject");var sReturn=this["copyFormValues"](oFormValues);var aFormFieldName=sFormFieldName.split(".");aFormFieldName.forEach(function(sParameter){sReturn=sReturn[sParameter]});return sReturn},"copyFormValues":function(oFormValues){$log.info("copyFormValues");var oReturn={};
try{oReturn=angular.copy(oFormValues)}catch(e){for(var key in oFormValues)try{oReturn[key]=angular.copy(oFormValues[key])}catch(e){if(goog.isObject(oFormValues[key])){oReturn[key]={};for(var key2 in oFormValues[key])try{oReturn[key][key2]=angular.copy(oFormValues[key][key2])}catch(e){}}}}return oReturn},"getFormValue":function(sName){$log.info("getFormValue");if(!goog.isString(sName))return null;sName=sName.trim();var oFormValues=this["oFormValues"][this["sFormDefinitionName"]];if(!goog.isDefAndNotNull(oFormValues))return null;
var sValue=oFormValues[sName.trim()];if(goog.isDefAndNotNull(sValue["selectedOption"]))if(goog.isDefAndNotNull(sValue["selectedOption"]["value"]))sValue=sValue["selectedOption"]["value"];return sValue},"concat":function(){$log.info("concat");var sResult="";for(var i=0;i<arguments.length;i++)if(goog.isString(arguments[i]))sResult+=arguments[i];return sResult},"getBusinessObjectDef":function(sBusinessObject){var deferred=$q.defer();showAjaxLoader();ajaxRequest({"method":"GET","url":this["oProperties"]["web_server_name"]+
"/"+this["oProperties"]["services_alias"]+"/vmap/businessobjects/"+sBusinessObject,"scope":$rootScope,"headers":{"Accept":"application/x-vm-json"},"success":function(response){hideAjaxLoader();if(!goog.isDef(response["data"])){$translate("NO_VALUES_RETURNED").then(function(sTranslation){bootbox.alert(sTranslation)});return 0}if(!goog.isDef(response["data"]["data"]))return 0;if(!goog.isDef(response["data"]["data"][0]))return 0;if(!goog.isDef(response["data"]["data"][0]["business_object_id"]))return 0;
if(goog.isDef(response["data"]["errorMessage"])){bootbox.alert(response["data"]["errorMessage"]);return 0}deferred.resolve(response["data"]["data"][0])},"error":function(response){hideAjaxLoader();console.error(response);bootbox.alert(response)}});return deferred.promise},"showModalSubform":function(sModalId,oSubformScope,oSubformDefinition,oSubformDefinitionName,oSubformValues){var sToken=this["sToken"];var oProperties=this["oProperties"];if(goog.isDefAndNotNull(oSubformScope["loadSubForm"])){oSubformScope["loadSubForm"]({"sFormDefinitionName":oSubformDefinitionName,
"oFormDefinition":oSubformDefinition,"oFormValues":oSubformValues,"oProperties":oProperties,"sToken":sToken});$("#"+sModalId).modal("show")}},"updateBoElement":function(sBusinessObject,oObject,oSubformDefinition,sSubformDefinitionName,oFormValuesResulted,successCallback){var oProperties=this["oProperties"];var envSrvc=angular.element(vitisApp.appMainDrtv).injector().get(["envSrvc"]);var formSrvc=angular.element(vitisApp.appMainDrtv).injector().get(["formSrvc"]);var aParamsToSave=[oObject["bo_id_field"]];
envSrvc["oFormValues"]=oFormValuesResulted;envSrvc["oFormDefinition"]=oSubformDefinition;envSrvc["sFormDefinitionName"]=sSubformDefinitionName;var oValues=formSrvc["getFormData"](sSubformDefinitionName,true);for(var i=0;i<aParamsToSave.length;i++)if(goog.isDefAndNotNull(oFormValuesResulted[sSubformDefinitionName][aParamsToSave[i]]))oValues[aParamsToSave[i]]=oFormValuesResulted[sSubformDefinitionName][aParamsToSave[i]];var oFormData=new FormData;for(var key in oValues)if(goog.isDefAndNotNull(oValues[key]["aFiles"])){oFormData.append(key+
"_attached_content",oValues[key]["aFiles"][0]);oFormData.append(key,oValues[key]["aFiles"][0]["name"])}else oFormData.append(key,oValues[key]);ajaxRequest({"method":"PUT","url":this["oProperties"]["web_server_name"]+"/"+this["oProperties"]["services_alias"]+"/vmap/querys/"+sBusinessObject,"data":oFormData,"scope":$rootScope,"success":function(response){if(!goog.isDef(response["data"])){$translate("NO_VALUES_RETURNED").then(function(sTranslation){bootbox.alert(sTranslation)});return 0}if(goog.isDef(response["data"]["errorMessage"])){bootbox.alert(response["data"]["errorMessage"]);
return 0}if(goog.isDef(response["status"]))if(response["status"]===500){bootbox.alert(response["statusText"]);return 0}successCallback.call()},"error":function(response){bootbox.alert(response);console.error(response)}})},"insertBoElement":function(sBusinessObject,oBusinessObject,oSubformDefinition,sSubformDefinitionName,oFormValuesResulted,successCallback){var oProperties=this["oProperties"];var envSrvc=angular.element(vitisApp.appMainDrtv).injector().get(["envSrvc"]);var formSrvc=angular.element(vitisApp.appMainDrtv).injector().get(["formSrvc"]);
var aParamsToSave=[oBusinessObject["id_field"]];envSrvc["oFormValues"]=oFormValuesResulted;envSrvc["oFormDefinition"]=oSubformDefinition;envSrvc["sFormDefinitionName"]=sSubformDefinitionName;var oValues=formSrvc["getFormData"](sSubformDefinitionName,true);for(var i=0;i<aParamsToSave.length;i++)if(goog.isDefAndNotNull(oFormValuesResulted[sSubformDefinitionName][aParamsToSave[i]]))oValues[aParamsToSave[i]]=oFormValuesResulted[sSubformDefinitionName][aParamsToSave[i]];var oFormData=new FormData;for(var key in oValues)if(goog.isDefAndNotNull(oValues[key]["aFiles"])){oFormData.append(key+
"_attached_content",oValues[key]["aFiles"][0]);oFormData.append(key,oValues[key]["aFiles"][0]["name"])}else oFormData.append(key,oValues[key]);ajaxRequest({"method":"POST","url":this["oProperties"]["web_server_name"]+"/"+this["oProperties"]["services_alias"]+"/vmap/querys/"+sBusinessObject,"data":oFormData,"scope":$rootScope,"success":function(response){if(!goog.isDef(response["data"])){$translate("NO_VALUES_RETURNED").then(function(sTranslation){bootbox.alert(sTranslation)});return 0}if(goog.isDef(response["data"]["errorMessage"])){bootbox.alert(response["data"]["errorMessage"]);
return 0}if(goog.isDef(response["status"]))if(response["status"]===500){bootbox.alert(response["statusText"]);return 0}successCallback.call()},"error":function(response){bootbox.alert(response);console.error(response)}})},"deleteBoElements":function(sBusinessObject,aIds,successCallback){var oProperties=this["oProperties"];ajaxRequest({"method":"DELETE","url":this["oProperties"]["web_server_name"]+"/"+this["oProperties"]["services_alias"]+"/vmap/querys/"+sBusinessObject,"params":{"idList":aIds.join("|")},
"scope":$rootScope,"success":function(response){if(!goog.isDef(response["data"])){$translate("NO_VALUES_RETURNED").then(function(sTranslation){bootbox.alert(sTranslation)});return 0}if(goog.isDef(response["data"]["errorMessage"])){bootbox.alert(response["data"]["errorMessage"]);return 0}if(goog.isDef(response["status"]))if(response["status"]===500){bootbox.alert(response["statusText"]);return 0}successCallback.call()},"error":function(response){bootbox.alert(response);console.error(response)}})},
"getSectionDef":function(sSection){var oProperties=this["oProperties"];var deferred=$q.defer();ajaxRequest({"method":"GET","url":this["oProperties"]["web_server_name"]+"/"+this["oProperties"]["services_alias"]+"/vitis/vitissections/"+sSection,"scope":$rootScope,"success":function(response){if(!goog.isDef(response["data"])){$translate("NO_VALUES_RETURNED").then(function(sTranslation){bootbox.alert(sTranslation)});return 0}if(!goog.isDef(response["data"]["data"])){$translate("NO_SECTION_FOUNDED").then(function(sTranslation){bootbox.alert(sTranslation)});
return 0}if(!goog.isDef(response["data"]["data"][0])){$translate("NO_SECTION_FOUNDED").then(function(sTranslation){bootbox.alert(sTranslation)});return 0}if(!goog.isDef(response["data"]["data"][0]["ressource_id"])){$translate("NO_SECTION_FOUNDED").then(function(sTranslation){bootbox.alert(sTranslation)});return 0}if(goog.isDef(response["data"]["errorMessage"])){bootbox.alert(response["data"]["errorMessage"]);return 0}deferred.resolve(response["data"]["data"][0])},"error":function(response){bootbox.alert(response);
console.error(response)}});return deferred.promise},"getSectionRessourceTab":function(sRessourceId){var oProperties=this["oProperties"];var deferred=$q.defer();ajaxRequest({"method":"GET","url":this["oProperties"]["web_server_name"]+"/"+this["oProperties"]["services_alias"]+"/vitis/ressources/"+sRessourceId,"headers":{"Accept":"application/json"},"scope":$rootScope,"success":function(response){if(!goog.isDef(response["data"])){$translate("NO_VALUES_RETURNED").then(function(sTranslation){bootbox.alert(sTranslation)});
return 0}if(!goog.isDef(response["data"]["ressources"])){$translate("NO_VALUES_RETURNED").then(function(sTranslation){bootbox.alert(sTranslation)});return 0}if(!goog.isDef(response["data"]["ressources"][0])){$translate("NO_VALUES_RETURNED").then(function(sTranslation){bootbox.alert(sTranslation)});return 0}if(goog.isDef(response["data"]["errorMessage"])){bootbox.alert(response["data"]["errorMessage"]);return 0}deferred.resolve(response["data"]["ressources"][0])},"error":function(response){bootbox.alert(response);
console.error(response)}});return deferred.promise},"getSectionRessourceData":function(sRessourceId,sFilter){var oProperties=this["oProperties"];var deferred=$q.defer();var oParams={"limit":100};if(goog.isDefAndNotNull(sFilter)&&sFilter!=="")oParams["filter"]=sFilter;ajaxRequest({"method":"GET","url":this["oProperties"]["web_server_name"]+"/"+this["oProperties"]["services_alias"]+"/"+sRessourceId,"params":oParams,"scope":$rootScope,"success":function(response){if(!goog.isDef(response["data"])){$translate("NO_VALUES_RETURNED").then(function(sTranslation){bootbox.alert(sTranslation)});
return 0}if(!goog.isDef(response["data"]["data"])){$translate("NO_VALUES_RETURNED").then(function(sTranslation){bootbox.alert(sTranslation)});return 0}if(!goog.isDef(response["data"]["data"][0])){$translate("NO_VALUES_RETURNED").then(function(sTranslation){bootbox.alert(sTranslation)});return 0}if(goog.isDef(response["data"]["errorMessage"])){bootbox.alert(response["data"]["errorMessage"]);return 0}deferred.resolve(response["data"]["data"])},"error":function(response){bootbox.alert(response);console.error(response)}});
return deferred.promise},"getSectionForm":function(oSection,bHideButtons){bHideButtons=goog.isDefAndNotNull(bHideButtons)?bHideButtons:false;var deferred=$q.defer();var sFileName;if(oSection["index"]>1)sFileName=oSection["mode_id"]+"_"+oSection["tab_name"]+"_"+oSection["name"]+".json";else sFileName=oSection["mode_id"]+"_"+oSection["tab_name"]+".json";ajaxRequest({"method":"GET","url":"modules/"+oSection["module_name"]+"/forms/"+oSection["mode_id"]+"/"+sFileName,"scope":$rootScope,"success":function(response){if(!goog.isDef(response["data"])){$translate("NO_FORM_FOUNDED").then(function(sTranslation){bootbox.alert(sTranslation)});
return 0}var oForm=response["data"];if(bHideButtons)for(var key in oForm)if(goog.isDefAndNotNull(oForm[key]))if(goog.isDefAndNotNull(oForm[key]["rows"]))for(var i=oForm[key]["rows"].length-1;i>=0;i--)if(goog.isDefAndNotNull(oForm[key]["rows"][i]["fields"]))for(var ii=oForm[key]["rows"][i]["fields"].length-1;ii>=0;ii--)if(oForm[key]["rows"][i]["fields"][ii]["type"]==="button")oForm[key]["rows"][i]["fields"].splice(ii,1);deferred.resolve(oForm)},"error":function(response){bootbox.alert(response);console.error(response)}});
return deferred.promise},"updateSectionElement":function(sRessourceId,sIdField,oSubformDefinition,sSubformDefinitionName,oFormValuesResulted){var deferred=$q.defer();var oProperties=this["oProperties"];var sId=oFormValuesResulted[sSubformDefinitionName][sIdField];var sUrl;var envSrvc=angular.element(vitisApp.appMainDrtv).injector().get(["envSrvc"]);var formSrvc=angular.element(vitisApp.appMainDrtv).injector().get(["formSrvc"]);envSrvc["oFormValues"]=oFormValuesResulted;envSrvc["oFormDefinition"]=
oSubformDefinition;envSrvc["sFormDefinitionName"]=sSubformDefinitionName;var oFormData=formSrvc["getFormData"](envSrvc["sFormDefinitionName"]);if(goog.isDefAndNotNull(sId))sUrl=this["oProperties"]["web_server_name"]+"/"+this["oProperties"]["services_alias"]+"/"+sRessourceId+"/"+sId;else sUrl=this["oProperties"]["web_server_name"]+"/"+this["oProperties"]["services_alias"]+"/"+sRessourceId;ajaxRequest({"method":"PUT","url":sUrl,"data":oFormData,"scope":$rootScope,"success":function(response){if(!goog.isDef(response["data"])){$translate("NO_VALUES_RETURNED").then(function(sTranslation){bootbox.alert(sTranslation)});
return 0}if(goog.isDef(response["data"]["errorMessage"])){bootbox.alert(response["data"]["errorMessage"]);return 0}if(goog.isDef(response["status"]))if(response["status"]===500){bootbox.alert(response["statusText"]);return 0}deferred.resolve(response["data"])},"error":function(response){console.error(response);bootbox.alert(response)}});return deferred.promise},"insertSectionElement":function(sRessourceId,sIdField,oSubformDefinition,sSubformDefinitionName,oFormValuesResulted){var deferred=$q.defer();
var oProperties=this["oProperties"];var sId=oFormValuesResulted[sSubformDefinitionName][sIdField];var sUrl;var envSrvc=angular.element(vitisApp.appMainDrtv).injector().get(["envSrvc"]);var formSrvc=angular.element(vitisApp.appMainDrtv).injector().get(["formSrvc"]);envSrvc["oFormValues"]=oFormValuesResulted;envSrvc["oFormDefinition"]=oSubformDefinition;envSrvc["sFormDefinitionName"]=sSubformDefinitionName;var oFormData=formSrvc["getFormData"](envSrvc["sFormDefinitionName"]);ajaxRequest({"method":"POST",
"url":this["oProperties"]["web_server_name"]+"/"+this["oProperties"]["services_alias"]+"/"+sRessourceId,"data":oFormData,"scope":$rootScope,"success":function(response){if(!goog.isDef(response["data"])){$translate("NO_VALUES_RETURNED").then(function(sTranslation){bootbox.alert(sTranslation)});return 0}if(goog.isDef(response["data"]["errorMessage"])){bootbox.alert(response["data"]["errorMessage"]);return 0}if(goog.isDef(response["status"]))if(response["status"]===500){bootbox.alert(response["statusText"]);
return 0}deferred.resolve(response["data"])},"error":function(response){console.error(response);bootbox.alert(response)}});return deferred.promise},"deleteSectionElements":function(sRessourceId,aIds){var deferred=$q.defer();var sToken=this["sToken"];var oProperties=this["oProperties"];ajaxRequest({"method":"DELETE","url":this["oProperties"]["web_server_name"]+"/"+this["oProperties"]["services_alias"]+"/"+sRessourceId,"params":{"idList":aIds.join("|")},"scope":$rootScope,"success":function(response){if(!goog.isDef(response["data"])){$translate("NO_VALUES_RETURNED").then(function(sTranslation){bootbox.alert(sTranslation)});
return 0}if(goog.isDef(response["data"]["errorMessage"])){bootbox.alert(response["data"]["errorMessage"]);return 0}if(goog.isDef(response["status"]))if(response["status"]===500){bootbox.alert(response["statusText"]);return 0}deferred.resolve(response["data"])},"error":function(response){console.error(response);bootbox.alert(response)}});return deferred.promise},"disableFormElement":function(oFormDefinition,sElement,sFormDefinitionName){if(!goog.isDefAndNotNull(oFormDefinition)){console.error("oFormDefinition not defined");
return null}if(!goog.isDefAndNotNull(sElement)){console.error("sElement not defined");return null}var aFormNames=[];if(goog.isDefAndNotNull(sFormDefinitionName))aFormNames=[sFormDefinitionName];else aFormNames=Object.keys(oFormDefinition);for(var i=0;i<aFormNames.length;i++)if(goog.isDefAndNotNull(oFormDefinition[aFormNames[i]]))if(goog.isArray(oFormDefinition[aFormNames[i]]["rows"]))for(var ii=0;ii<oFormDefinition[aFormNames[i]]["rows"].length;ii++)if(goog.isDefAndNotNull(oFormDefinition[aFormNames[i]]["rows"][ii]["fields"]))for(var iii=
0;iii<oFormDefinition[aFormNames[i]]["rows"][ii]["fields"].length;iii++)if(oFormDefinition[aFormNames[i]]["rows"][ii]["fields"][iii]["name"]===sElement)oFormDefinition[aFormNames[i]]["rows"][ii]["fields"][iii]["disabled"]=true;return oFormDefinition},"extractFormDefinitionInfos":function(sFormName){var scope=angular.element("form[name='"+sFormName+"']").scope();scope["ctrl"].extractFormDefinitionInfos()},"getGPS":function(){return goog.isDefAndNotNull(vitisApp["oGeoLocation"])?vitisApp["oGeoLocation"]:
null},"getGPSPosition":function(){var oGPS=vitisApp["oGeoLocation"];if(goog.isDefAndNotNull(oGPS))return oGPS.getPosition()},"getGPSLat":function(){var oGPS=vitisApp["oGeoLocation"];if(goog.isDefAndNotNull(oGPS)){var aPosition=oGPS.getPosition();if(goog.isDefAndNotNull(aPosition))return oGPS.getPosition()[1];else console.error("GPS position undefined")}else console.error("GPS undefined")},"getGPSLong":function(){var oGPS=vitisApp["oGeoLocation"];if(goog.isDefAndNotNull(oGPS)){var aPosition=oGPS.getPosition();
if(goog.isDefAndNotNull(aPosition))return oGPS.getPosition()[0]}else console.error("GPS undefined")},"getGPSAltitude":function(){var oGPS=vitisApp["oGeoLocation"];if(goog.isDefAndNotNull(oGPS))return oGPS.getAltitude();else console.error("GPS undefined")},"getGPSAccuracy":function(){var oGPS=vitisApp["oGeoLocation"];if(goog.isDefAndNotNull(oGPS))return oGPS.getAccuracy();else console.error("GPS undefined")},"getGPSHeading":function(){var oGPS=vitisApp["oGeoLocation"];if(goog.isDefAndNotNull(oGPS))return oGPS.getHeading();
else console.error("GPS undefined")}}};formReader.module.service("formReaderService",formReader.formReaderService);
